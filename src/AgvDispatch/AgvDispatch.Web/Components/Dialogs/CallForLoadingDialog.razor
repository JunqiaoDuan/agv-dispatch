@using AgvDispatch.Shared.DTOs.Stations
@using AgvDispatch.Shared.DTOs.Tasks
@using AgvDispatch.Shared.Enums
@using AgvDispatch.Web.Services
@inject ITaskClient TaskClient
@inject ISnackbar Snackbar

<MudDialog Visible="Visible" VisibleChanged="OnDialogVisibleChanged" Options="DialogOptions">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Upload" Color="Color.Success" />
                <MudText Typo="Typo.h6">召唤小车上料</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudStack Spacing="3">
                @* 目标站点选择 *@
                <MudSelect T="string"
                           Label="目标站点"
                           Value="TargetStationCode"
                           ValueChanged="OnStationChanged"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           HelperText="请选择上料站点">
                    @foreach (var station in Stations.Where(s => s.StationType == StationType.Pickup))
                    {
                        <MudSelectItem T="string" Value="@station.StationCode">
                            @station.StationCode - @station.DisplayName
                        </MudSelectItem>
                    }
                </MudSelect>

                @if (LoadingRecommendations)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Typo="Typo.caption">查询中...</MudText>
                }

                @* 推荐列表 *@
                @if (Recommendations.Any())
                {
                    <MudDivider />

                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Small" Style="vertical-align: middle;" />
                            推荐小车 (@Recommendations.Count(x => x.IsAvailable) 可用 / @Recommendations.Count 总计)
                        </MudText>
                        @if (Recommendations.Count > 1)
                        {
                            <MudButton OnClick="@(() => _showAllRecommendations = !_showAllRecommendations)"
                                       Size="Size.Small"
                                       Variant="Variant.Text"
                                       StartIcon="@(_showAllRecommendations ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)">
                                @(_showAllRecommendations ? "折叠" : $"展开 ({Recommendations.Count - 1})")
                            </MudButton>
                        }
                    </MudStack>

                    @if (!Recommendations.Any(x => x.IsAvailable))
                    {
                        <MudAlert Severity="Severity.Warning">无可用小车</MudAlert>
                    }

                    <div style="max-height: 400px; overflow-y: auto;">
                        <MudStack Spacing="2">
                            @foreach (var (recommendation, index) in Recommendations.Select((r, i) => (r, i)))
                            {
                                @* 如果没有可用小车，全部折叠；如果有可用小车，只显示第一个可用的，其它折叠 *@
                                @if (ShouldShowRecommendation(index, recommendation.IsAvailable))
                                {
                                    <MudCard Outlined="true" Class="@(SelectedAgvId == recommendation.AgvId ? "selected-card" : "")">
                                        <MudCardContent Class="pa-2">
                                            <MudStack Spacing="1">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudChip T="string" Color="@(recommendation.IsAvailable ? GetRankColor(index) : Color.Default)" Size="Size.Small">
                                                        #@(index + 1)
                                                    </MudChip>
                                                    <MudText Typo="Typo.body2"><strong>@recommendation.AgvCode</strong></MudText>
                                                    <MudChip T="string" Color="@GetStatusColor(recommendation.Status)" Size="Size.Small">
                                                        @recommendation.Status.ToDisplayText()
                                                    </MudChip>
                                                    @if (!recommendation.IsAvailable)
                                                    {
                                                        <MudChip T="string" Color="Color.Error" Size="Size.Small">不可用</MudChip>
                                                    }
                                                </MudStack>

                                                <MudText Typo="Typo.caption">
                                                    电量: @recommendation.Battery% |
                                                    得分: @recommendation.TotalScore.ToString("F1")
                                                </MudText>

                                                @if (!string.IsNullOrWhiteSpace(recommendation.RecommendReason))
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @recommendation.RecommendReason
                                                    </MudText>
                                                }

                                                <MudButton Variant="@(SelectedAgvId == recommendation.AgvId ? Variant.Filled : Variant.Outlined)"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           FullWidth="true"
                                                           OnClick="@(() => SelectAgv(recommendation.AgvId))"
                                                           Disabled="@(!recommendation.IsAvailable)">
                                                    @(SelectedAgvId == recommendation.AgvId ? "已选择" : recommendation.IsAvailable ? "选择" : "不可用")
                                                </MudButton>
                                            </MudStack>
                                        </MudCardContent>
                                    </MudCard>
                                }
                            }
                        </MudStack>
                    </div>
                }
            </MudStack>
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseDialog" Variant="Variant.Text">取消</MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.Check"
                       OnClick="ConfirmAssignment"
                       Disabled="@(Assigning || SelectedAgvId == null || string.IsNullOrWhiteSpace(TargetStationCode))">
                @if (Assigning)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>分配中...</span>
                }
                else
                {
                    <span>确认分配</span>
                }
            </MudButton>
        </DialogActions>
</MudDialog>

<style>
    .selected-card {
        border-color: #2196F3 !important;
        border-width: 2px !important;
        background: #E3F2FD !important;
    }
</style>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public List<StationListItemDto> Stations { get; set; } = [];
    [Parameter] public EventCallback OnTaskCreated { get; set; }

    private DialogOptions DialogOptions = new()
    {
        MaxWidth = MaxWidth.Small,
        FullWidth = true,
        CloseButton = true,
        Position = DialogPosition.Center
    };

    private string TargetStationCode = string.Empty;
    private List<AgvRecommendationDto> Recommendations = [];
    private Guid? SelectedAgvId;
    private bool LoadingRecommendations = false;
    private bool Assigning = false;
    private bool _previousVisible = false;
    private bool _showAllRecommendations = false;

    protected override async Task OnParametersSetAsync()
    {
        // 只在从 false 变为 true 时才加载数据
        if (Visible && !_previousVisible)
        {
            // 打开弹窗时重置状态
            TargetStationCode = string.Empty;
            Recommendations.Clear();
            SelectedAgvId = null;
            await GetRecommendations();
        }

        _previousVisible = Visible;
    }

    private async Task OnDialogVisibleChanged(bool visible)
    {
        if (!visible)
        {
            // 对话框被关闭
            await CloseDialog();
        }
    }

    private void OnStationChanged(string? stationCode)
    {
        TargetStationCode = stationCode ?? string.Empty;
        // 移除自动刷新推荐小车的逻辑
    }

    private async Task GetRecommendations()
    {
        LoadingRecommendations = true;
        Recommendations.Clear();
        SelectedAgvId = null;

        try
        {
            var request = new GetRecommendationsRequestDto
            {
                TaskType = TaskJobType.CallForLoading
            };

            Recommendations = await TaskClient.GetRecommendationsAsync(request);

            if (Recommendations.Any())
            {
                var availableCount = Recommendations.Count(x => x.IsAvailable);
                Snackbar.Add($"找到 {availableCount} 辆可用小车", Severity.Success);
            }
            else
            {
                Snackbar.Add("暂无可用小车", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"获取推荐失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            LoadingRecommendations = false;
        }
    }

    private void SelectAgv(Guid agvId)
    {
        SelectedAgvId = agvId;
    }

    private async Task ConfirmAssignment()
    {
        if (SelectedAgvId == null) return;

        Assigning = true;

        try
        {
            var request = new CreateTaskWithAgvRequestDto
            {
                TaskType = TaskJobType.CallForLoading,
                TargetStationCode = TargetStationCode,
                SelectedAgvId = SelectedAgvId.Value
            };

            var response = await TaskClient.CreateTaskAsync(request);

            if (response != null)
            {
                Snackbar.Add("任务已成功创建并下发！", Severity.Success);
                await CloseDialog();
                await OnTaskCreated.InvokeAsync();
            }
            else
            {
                Snackbar.Add("创建任务失败", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"创建任务失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            Assigning = false;
        }
    }

    private async Task CloseDialog()
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(Visible);
        Recommendations.Clear();
        SelectedAgvId = null;
        TargetStationCode = string.Empty;
    }

    private Color GetRankColor(int index) => index switch
    {
        0 => Color.Success,
        1 => Color.Info,
        2 => Color.Warning,
        _ => Color.Default
    };

    private Color GetStatusColor(AgvStatus status) => status switch
    {
        AgvStatus.Idle => Color.Success,
        AgvStatus.Running => Color.Info,
        AgvStatus.Charging => Color.Warning,
        AgvStatus.Error => Color.Error,
        _ => Color.Default
    };

    private bool ShouldShowRecommendation(int index, bool isAvailable)
    {
        // 如果用户选择展开全部，显示所有小车
        if (_showAllRecommendations)
            return true;

        var hasAvailable = Recommendations.Any(x => x.IsAvailable);

        // 如果没有可用小车，不显示任何小车（折叠全部）
        if (!hasAvailable)
            return false;

        // 如果有可用小车，只显示第一个可用的小车
        var firstAvailableIndex = Recommendations.FindIndex(x => x.IsAvailable);
        return index == firstAvailableIndex;
    }
}
