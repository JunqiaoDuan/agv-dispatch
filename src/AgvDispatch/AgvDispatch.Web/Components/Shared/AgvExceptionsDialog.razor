@using AgvDispatch.Shared.DTOs
@using AgvDispatch.Shared.DTOs.Agvs
@using AgvDispatch.Shared.Enums
@using AgvDispatch.Web.Services
@using MudBlazor
@inject IAgvClient AgvClient
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Style="vertical-align: middle;" />
            AGV异常列表 - @AgvCode
        </MudText>

        @if (_loading)
        {
            <div style="text-align: center; padding: 20px;">
                <MudProgressCircular Size="Size.Medium" Indeterminate="true" />
            </div>
        }
        else
        {
            @* Tab切换 *@
            <MudTabs @bind-ActivePanelIndex="_activeTabIndex" Elevation="0" ApplyEffectsToContainer="true" PanelClass="pa-2">
                <MudTabPanel Text="@($"未确认的异常 ({_unresolvedExceptions.Count})")">
                    @if (!_unresolvedExceptions.Any())
                    {
                        <MudAlert Severity="Severity.Success" Dense="true">当前无未解决的异常</MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@GetPaginatedUnresolvedExceptions()"
                                  MultiSelection="true"
                                  @bind-SelectedItems="_selectedExceptions"
                                  Dense="true"
                                  Hover="true"
                                  FixedHeader="true"
                                  Height="400px">
                            <HeaderContent>
                                <MudTh>类型</MudTh>
                                <MudTh>级别</MudTh>
                                <MudTh>消息</MudTh>
                                <MudTh>站点</MudTh>
                                <MudTh>时间</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="类型">
                                    <MudText Typo="Typo.body2" Color="@GetSeverityColor(context.Severity)">
                                        <strong>@context.ExceptionType.ToDisplayText()</strong>
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="级别">
                                    <MudChip T="string" Size="Size.Small" Color="@GetSeverityColor(context.Severity)">
                                        @context.Severity.ToDisplayText()
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="消息">
                                    <MudText Typo="Typo.body2">@context.Message</MudText>
                                </MudTd>
                                <MudTd DataLabel="站点">
                                    <MudText Typo="Typo.body2">@context.StationCode</MudText>
                                </MudTd>
                                <MudTd DataLabel="时间">
                                    <MudText Typo="Typo.caption">
                                        @context.ExceptionTime.ToLocalTime().ToString("MM-dd HH:mm:ss")
                                    </MudText>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>

                        @* 未确认异常的分页控件 - 客户端分页 *@
                        @if (_unresolvedTotalPages > 1)
                        {
                            <div class="d-flex justify-center mt-3">
                                <MudPagination Count="@_unresolvedTotalPages"
                                             SelectedChanged="OnUnresolvedPageChanged"
                                             Selected="@_unresolvedCurrentPage"
                                             Color="Color.Primary"
                                             Variant="Variant.Filled" />
                            </div>
                        }

                        <div class="mt-3">
                            <MudAlert Severity="Severity.Info" Dense="true" Icon="@Icons.Material.Filled.Info">
                                已选中 @_selectedExceptions.Count 条异常
                            </MudAlert>
                        </div>
                    }
                </MudTabPanel>

                <MudTabPanel Text="@($"所有异常 ({_allExceptionsTotalCount})")">
                    @if (_allExceptionsTotalCount == 0)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">暂无异常记录</MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@_allExceptions"
                                  Dense="true"
                                  Hover="true"
                                  FixedHeader="true"
                                  Height="400px">
                            <HeaderContent>
                                <MudTh>类型</MudTh>
                                <MudTh>级别</MudTh>
                                <MudTh>消息</MudTh>
                                <MudTh>站点</MudTh>
                                <MudTh>时间</MudTh>
                                <MudTh>状态</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="类型">
                                    <MudText Typo="Typo.body2" Color="@GetSeverityColor(context.Severity)">
                                        <strong>@context.ExceptionType.ToDisplayText()</strong>
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="级别">
                                    <MudChip T="string" Size="Size.Small" Color="@GetSeverityColor(context.Severity)">
                                        @context.Severity.ToDisplayText()
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="消息">
                                    <MudText Typo="Typo.body2">@context.Message</MudText>
                                </MudTd>
                                <MudTd DataLabel="站点">
                                    <MudText Typo="Typo.body2">@context.StationCode</MudText>
                                </MudTd>
                                <MudTd DataLabel="时间">
                                    <MudText Typo="Typo.caption">
                                        @context.ExceptionTime.ToLocalTime().ToString("MM-dd HH:mm:ss")
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="状态">
                                    @if (context.IsResolved)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success">已解决</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">未解决</MudChip>
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>

                        @* 所有异常的分页控件 - 服务端分页 *@
                        @if (_allTotalPages > 1)
                        {
                            <div class="d-flex justify-center mt-3">
                                <MudPagination Count="@_allTotalPages"
                                             SelectedChanged="OnAllPageChanged"
                                             Selected="@_allCurrentPage"
                                             Color="Color.Primary"
                                             Variant="Variant.Filled" />
                            </div>
                        }
                    }
                </MudTabPanel>
            </MudTabs>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">取消</MudButton>
        @if (_activeTabIndex == 0 && _unresolvedExceptions.Any())
        {
            <MudButton OnClick="SelectAll" Color="Color.Primary" Variant="Variant.Text">全选当前页</MudButton>
            <MudButton OnClick="ResolveSelected"
                       Color="Color.Error"
                       Variant="Variant.Filled"
                       Disabled="@(!_selectedExceptions.Any() || _resolving)">
                @if (_resolving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>处理中...</span>
                }
                else
                {
                    <span>消除选中的异常</span>
                }
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public string AgvCode { get; set; } = string.Empty;

    [Parameter]
    public EventCallback OnExceptionsResolved { get; set; }

    // 数据
    private List<AgvExceptionSummaryDto> _unresolvedExceptions = new();
    private List<AgvExceptionSummaryDto> _allExceptions = new();
    private HashSet<AgvExceptionSummaryDto> _selectedExceptions = new();

    // Tab状态
    private int _activeTabIndex = 0;

    // 分页 - 未确认的异常（客户端分页）
    private int _unresolvedCurrentPage = 1;
    private int _unresolvedPageSize = 20;
    private int _unresolvedTotalPages => (int)Math.Ceiling(_unresolvedExceptions.Count / (double)_unresolvedPageSize);

    // 分页 - 所有异常（服务端分页）
    private int _allCurrentPage = 1;
    private int _allPageSize = 20;
    private int _allExceptionsTotalCount = 0;
    private int _allTotalPages => (int)Math.Ceiling(_allExceptionsTotalCount / (double)_allPageSize);

    // UI状态
    private bool _loading = true;
    private bool _resolving = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadExceptions();
        }
    }

    private async Task LoadExceptions()
    {
        _loading = true;
        try
        {
            // 加载未解决的异常（全部加载，客户端分页）
            _unresolvedExceptions = await AgvClient.GetAgvUnresolvedExceptionsAsync(AgvCode);

            // 加载所有异常（服务端分页）
            await LoadAllExceptions();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载异常列表失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadAllExceptions()
    {
        var request = new PagedAgvExceptionRequest
        {
            PageIndex = _allCurrentPage - 1, // 转换为0基索引
            PageSize = _allPageSize,
            SortBy = "ExceptionTime",
            SortDescending = true
        };

        var pagedResult = await AgvClient.GetAllAgvExceptionsAsync(AgvCode, request);
        _allExceptions = pagedResult.Items;
        _allExceptionsTotalCount = pagedResult.TotalCount;
    }

    private void OnUnresolvedPageChanged(int page)
    {
        _unresolvedCurrentPage = page;
        _selectedExceptions.Clear();
    }

    private async Task OnAllPageChanged(int page)
    {
        _allCurrentPage = page;
        await LoadAllExceptions();
    }

    private void SelectAll()
    {
        // 客户端分页：选中当前页的未解决异常
        _selectedExceptions = GetPaginatedUnresolvedExceptions().ToHashSet();
    }

    private List<AgvExceptionSummaryDto> GetPaginatedUnresolvedExceptions()
    {
        return _unresolvedExceptions
            .Skip((_unresolvedCurrentPage - 1) * _unresolvedPageSize)
            .Take(_unresolvedPageSize)
            .ToList();
    }

    private async Task ResolveSelected()
    {
        if (!_selectedExceptions.Any())
        {
            Snackbar.Add("请至少选择一条异常", Severity.Warning);
            return;
        }

        _resolving = true;
        try
        {
            var exceptionIds = _selectedExceptions.Select(e => e.Id).ToList();
            var success = await AgvClient.ResolveExceptionsAsync(exceptionIds);

            if (success)
            {
                Snackbar.Add($"成功消除 {exceptionIds.Count} 条异常", Severity.Success);
                await OnExceptionsResolved.InvokeAsync();

                // 重新加载数据
                await LoadExceptions();

                // 清空选择
                _selectedExceptions.Clear();
            }
            else
            {
                Snackbar.Add("消除异常失败", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"消除异常失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            _resolving = false;
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private Color GetSeverityColor(AgvExceptionSeverity severity) => severity switch
    {
        AgvExceptionSeverity.Info => Color.Info,
        AgvExceptionSeverity.Warning => Color.Warning,
        AgvExceptionSeverity.Error => Color.Error,
        AgvExceptionSeverity.Critical => Color.Error,
        _ => Color.Default
    };
}
