@page "/job-monitor"
@using AgvDispatch.Business.Entities.BackgroundJobLogAggregate
@using AgvDispatch.Shared.DTOs.BackgroundJobLogs
@using AgvDispatch.Web.Services
@rendermode InteractiveServer
@inject IBackgroundJobLogClient JobLogClient
@implements IDisposable

<PageTitle>后台任务监控 - AGV 调度系统</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">后台任务监控</MudText>
    <MudButtonGroup>
        <MudButton OnClick="@(() => SwitchStatsPeriod(true))"
                   Variant="@(_showTodayStats ? Variant.Filled : Variant.Outlined)"
                   Color="Color.Primary">
            今日
        </MudButton>
        <MudButton OnClick="@(() => SwitchStatsPeriod(false))"
                   Variant="@(_showTodayStats ? Variant.Outlined : Variant.Filled)"
                   Color="Color.Primary">
            总共
        </MudButton>
    </MudButtonGroup>
</MudStack>

@* 统计信息卡片 *@
<MudGrid Class="mb-4">
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <MudText Typo="Typo.subtitle2" Color="Color.Default">总执行次数</MudText>
                    <MudText Typo="Typo.h4">@(_statistics?.TotalCount.ToString("N0") ?? "-")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.Schedule" Color="Color.Primary" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <MudText Typo="Typo.subtitle2" Color="Color.Default">成功</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">@(_statistics?.SuccessCount.ToString("N0") ?? "-")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <MudText Typo="Typo.subtitle2" Color="Color.Default">失败</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Error">@(_statistics?.FailedCount.ToString("N0") ?? "-")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <MudText Typo="Typo.subtitle2" Color="Color.Default">跳过</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Default">@(_statistics?.SkippedCount.ToString("N0") ?? "-")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.SkipNext" Color="Color.Default" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@* 筛选条件 *@
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid Spacing="2">
        <MudItem xs="12" sm="6" md="3" lg="2">
            <MudDatePicker @bind-Date="_startDate" Label="起始时间" Variant="Variant.Outlined"
                           DateFormat="yyyy-MM-dd" />
        </MudItem>

        <MudItem xs="12" sm="6" md="3" lg="2">
            <MudDatePicker @bind-Date="_endDate" Label="截至时间" Variant="Variant.Outlined"
                           DateFormat="yyyy-MM-dd" />
        </MudItem>

        <MudItem xs="12" sm="6" md="3" lg="2">
            <MudTextField @bind-Value="_filterJobName" Label="任务名称" Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="6" md="3" lg="2">
            <MudSelect @bind-Value="_filterResult" Label="执行结果" Variant="Variant.Outlined">
                <MudSelectItem Value="@((int?)null)">全部</MudSelectItem>
                <MudSelectItem Value="@((int?)1)">成功</MudSelectItem>
                <MudSelectItem Value="@((int?)2)">失败</MudSelectItem>
                <MudSelectItem Value="@((int?)3)">跳过</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3" lg="2" Class="d-flex align-center">
            <MudStack Row="true" Spacing="1">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData"
                           StartIcon="@Icons.Material.Filled.Search" Size="Size.Medium">
                    查询
                </MudButton>

                <MudIconButton Icon="@Icons.Material.Filled.Clear" Color="Color.Secondary"
                               OnClick="ClearFilters" Size="Size.Medium" />

                <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Info"
                               OnClick="LoadData" Size="Size.Medium" />
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudGrid>
    @* 任务日志列表 *@
    <MudItem xs="12" md="10">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                <MudText Typo="Typo.h6">任务日志 (共 @_totalCount 条)</MudText>
                @if (_loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
            </MudStack>

            @if (_loading && !_logs.Any())
            {
                <MudProgressLinear Indeterminate="true" />
            }
            else if (_logs.Any())
            {
                <div style="max-height: 600px; overflow-y: auto;">
                    <MudTable Items="@_logs" Dense="true" Hover="true" Striped="true" FixedHeader="true">
                        <HeaderContent>
                            <MudTh>执行时间</MudTh>
                            <MudTh>任务名称</MudTh>
                            <MudTh>执行结果</MudTh>
                            <MudTh>影响数量</MudTh>
                            <MudTh>耗时(ms)</MudTh>
                            <MudTh>消息</MudTh>
                            <MudTh>操作</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="执行时间">
                                <MudText Typo="Typo.caption">@context.ExecuteTime.LocalDateTime.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                            </MudTd>
                            <MudTd DataLabel="任务名称">
                                <MudText Typo="Typo.body2">@context.JobDisplayName</MudText>
                            </MudTd>
                            <MudTd DataLabel="执行结果">
                                <MudChip T="string" Size="Size.Small" Color="@GetResultColor(context.Result)">
                                    @GetResultText(context.Result)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="影响数量">
                                @if (context.AffectedCount > 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.AffectedCount</MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2">-</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="耗时">
                                <MudText Typo="Typo.body2">@context.DurationMs</MudText>
                            </MudTd>
                            <MudTd DataLabel="消息">
                                <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                    @context.Message
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="操作">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary"
                                               OnClick="@(() => ShowLogDetails(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>

                @* 分页控件 *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-3">
                    <MudText Typo="Typo.body2">
                        显示 @((_currentPage * _pageSize) + 1)-@Math.Min((_currentPage + 1) * _pageSize, _totalCount) 条，共 @_totalCount 条
                    </MudText>
                    <MudPagination Count="@_totalPages" Selected="@(_currentPage + 1)" SelectedChanged="OnPageChanged"
                                   BoundaryCount="1" MiddleCount="3" />
                </MudStack>
            }
            else
            {
                <MudText Color="Color.Default" Class="pa-4">暂无任务日志数据</MudText>
            }
        </MudPaper>
    </MudItem>

    @* 右侧统计面板 *@
    <MudItem xs="12" md="2">
        <MudStack Spacing="3">
            @* 任务类型分布 *@
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">任务类型分布</MudText>
                @if (_statistics?.ByJobType.Any() == true)
                {
                    <MudList T="string" Dense="true">
                        @foreach (var item in _statistics.ByJobType)
                        {
                            <MudListItem T="string">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.body2">@item.JobDisplayName</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@item.Count 次</MudChip>
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudText Color="Color.Default" Typo="Typo.body2">暂无数据</MudText>
                }
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

@* 日志详情对话框 *@
<MudDialog @bind-Visible="_showDetailsDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">任务日志详情</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedLog != null)
        {
            <MudStack Spacing="2">
                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2">执行时间:</MudText>
                        <MudText Typo="Typo.body2">@_selectedLog.ExecuteTime.LocalDateTime.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2">执行结果:</MudText>
                        <MudChip T="string" Size="Size.Small" Color="@GetResultColor(_selectedLog.Result)">
                            @GetResultText(_selectedLog.Result)
                        </MudChip>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2">任务名称:</MudText>
                        <MudText Typo="Typo.body2">@_selectedLog.JobDisplayName (@_selectedLog.JobName)</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2">影响数量:</MudText>
                        <MudText Typo="Typo.body2">@_selectedLog.AffectedCount</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2">执行耗时:</MudText>
                        <MudText Typo="Typo.body2">@_selectedLog.DurationMs ms</MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2">消息:</MudText>
                        <MudText Typo="Typo.body2">@_selectedLog.Message</MudText>
                    </MudItem>
                    @if (!string.IsNullOrWhiteSpace(_selectedLog.ErrorMessage))
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Color="Color.Error">错误信息:</MudText>
                            <MudPaper Class="pa-3" Elevation="0" Style="background-color: #ffebee;">
                                <MudText Typo="Typo.body2" Color="Color.Error">@_selectedLog.ErrorMessage</MudText>
                            </MudPaper>
                        </MudItem>
                    }
                    @if (!string.IsNullOrWhiteSpace(_selectedLog.Details))
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">详细信息 (JSON):</MudText>
                            <MudPaper Class="pa-3" Elevation="0" Style="background-color: #f5f5f5; max-height: 400px; overflow-y: auto;">
                                <code style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">@FormatJson(_selectedLog.Details)</code>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="CloseDetailsDialog">关闭</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<BackgroundJobLogDto> _logs = new();
    private BackgroundJobStatistics? _statistics;
    private bool _loading = true;
    private bool _showTodayStats = true;

    // 日期范围（默认最近7天）
    private DateTime? _startDate;
    private DateTime? _endDate;

    // 分页相关
    private int _currentPage = 0;
    private int _pageSize = 50;
    private int _totalCount = 0;
    private int _totalPages => (_totalCount + _pageSize - 1) / _pageSize;

    // 过滤条件
    private string? _filterJobName;
    private int? _filterResult;

    // 日志详情对话框
    private bool _showDetailsDialog;
    private BackgroundJobLogDto? _selectedLog;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 设置默认时间范围为最近7天
            _endDate = DateTime.Today;
            _startDate = DateTime.Today.AddDays(-7);

            await LoadData();
        }
    }

    private async Task LoadData()
    {
        await Task.WhenAll(LoadLogs(), LoadStatistics());
    }

    private async Task LoadLogs()
    {
        _loading = true;
        try
        {
            // 将 DateTime 格式化为 yyyyMMdd 字符串
            string? startTime = _startDate?.ToString("yyyyMMdd");
            string? endTime = _endDate?.ToString("yyyyMMdd");

            var result = await JobLogClient.GetByTimeRangeAsync(
                startTime,
                endTime,
                _filterJobName,
                _filterResult,
                _currentPage,
                _pageSize
            );

            if (result != null)
            {
                _logs = result.Items;
                _totalCount = result.TotalCount;
            }
            else
            {
                _logs = new();
                _totalCount = 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载任务日志失败: {ex.Message}");
            _logs = new();
            _totalCount = 0;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            var since = _showTodayStats ? DateTime.Today.ToString("yyyyMMdd") : null;
            _statistics = await JobLogClient.GetStatisticsAsync(since);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载统计失败: {ex.Message}");
        }
    }

    private void SwitchStatsPeriod(bool showToday)
    {
        _showTodayStats = showToday;
        _ = LoadStatistics();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page - 1; // MudPagination 从1开始，我们的pageIndex从0开始
        await LoadLogs();
    }

    private async Task ClearFilters()
    {
        _filterJobName = null;
        _filterResult = null;

        // 重置为默认时间范围（最近7天）
        _endDate = DateTime.Today;
        _startDate = DateTime.Today.AddDays(-7);

        _currentPage = 0;
        await LoadData();
    }

    private void ShowLogDetails(BackgroundJobLogDto log)
    {
        _selectedLog = log;
        _showDetailsDialog = true;
    }

    private void CloseDetailsDialog()
    {
        _showDetailsDialog = false;
    }

    private Color GetResultColor(JobExecutionResult result)
    {
        return result switch
        {
            JobExecutionResult.Success => Color.Success,
            JobExecutionResult.Failed => Color.Error,
            JobExecutionResult.Skipped => Color.Default,
            _ => Color.Default
        };
    }

    private string GetResultText(JobExecutionResult result)
    {
        return result switch
        {
            JobExecutionResult.Success => "成功",
            JobExecutionResult.Failed => "失败",
            JobExecutionResult.Skipped => "跳过",
            _ => "未知"
        };
    }

    private string FormatJson(string json)
    {
        try
        {
            var jsonElement = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(json);
            return System.Text.Json.JsonSerializer.Serialize(jsonElement, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }

    public void Dispose()
    {
    }
}
