@page "/task-monitor"
@layout ContentLayout
@using AgvDispatch.Shared.DTOs.MapEdges
@using AgvDispatch.Shared.DTOs.MapNodes
@using AgvDispatch.Shared.DTOs.Maps
@using AgvDispatch.Shared.DTOs.Stations
@using AgvDispatch.Shared.DTOs.Agvs
@using AgvDispatch.Shared.DTOs.Tasks
@using AgvDispatch.Shared.Enums
@using AgvDispatch.Shared.Rendering
@using AgvDispatch.Shared.PathFinding
@using AgvDispatch.Shared.Simulation
@using AgvDispatch.Web.Services
@using AgvDispatch.Web.Components.Shared
@using System.Timers
@rendermode InteractiveServer
@inject IMapClient MapClient
@inject IStationClient StationClient
@inject IAgvClient AgvClient
@inject ITaskClient TaskClient
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>任务调度与监控 - AGV调度系统</PageTitle>

<div class="task-monitor-page">
    @* 顶部工具栏 *@
    <div class="monitor-toolbar">
        <div class="toolbar-left">
            <MudText Typo="Typo.body2">
                <strong>任务调度与监控</strong>
            </MudText>
            @if (_map != null)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-2">
                    地图: @_map.MapCode @_map.DisplayName
                </MudText>
            }
        </div>

        <div class="toolbar-center">
            <MudChip T="string" Color="Color.Info" Size="Size.Small">
                AGV: @_agvs.Count 辆
            </MudChip>
            <MudChip T="string" Color="Color.Success" Size="Size.Small">
                任务: @_tasks.Count 个
            </MudChip>
        </div>

        <div class="toolbar-right">
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Size="Size.Small"
                           OnClick="RefreshData"
                           Title="立即刷新" />
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                           Size="Size.Small"
                           OnClick="OpenSettings"
                           Title="设置" />
        </div>
    </div>

    @* 主体区域 *@
    <div class="monitor-body">
        @* 左侧控制面板 - 四个功能按钮 *@
        <div class="monitor-panel left-panel">
            <div class="panel-content">
                <MudStack Spacing="3">
                    @* 召唤小车上料 *@
                    <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.CallForLoading)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Upload" Color="Color.Success" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Success">召唤小车上料</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                将空闲小车召唤到上料点
                            </MudText>
                        </MudStack>
                    </MudPaper>

                    @* 告知小车去下料 *@
                    <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.SendToUnloading)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Download" Color="Color.Info" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Info">告知小车去下料</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                指派小车前往下料点
                            </MudText>
                        </MudStack>
                    </MudPaper>

                    @* 确认下料去等待区 *@
@*                     <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.ReturnToWaiting)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Home" Color="Color.Warning" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Warning">确认下料去等待区</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                完成下料后返回等待区
                            </MudText>
                        </MudStack>
                    </MudPaper> *@

                    @* 让小车充电 *@
@*                     <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.SendToCharge)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.BatteryChargingFull" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Primary">让小车充电</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                将小车送往充电站
                            </MudText>
                        </MudStack>
                    </MudPaper> *@
                </MudStack>

                @* 追踪小车控制 *@
                @if (_tasks.Any(t => t.TaskStatus == TaskJobStatus.Executing))
                {
                    <div class="panel-section mt-3">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.MyLocation" Size="Size.Small" Style="vertical-align: middle;" />
                            追踪小车
                        </MudText>

                        <MudRadioGroup T="string" Value="_trackingMode" ValueChanged="OnTrackingModeChanged">
                            <MudRadio T="string" Value="@("none")" Color="Color.Default" Size="Size.Small">
                                不跟踪
                            </MudRadio>
                            @foreach (var task in _tasks.Where(t => t.TaskStatus == TaskJobStatus.Executing).OrderBy(t => t.Id))
                            {
                                var agv = _agvs.FirstOrDefault(a => a.AgvCode == task.AssignedAgvCode);
                                var displayName = agv?.DisplayName ?? task.AssignedAgvCode ?? "未分配";
                                <MudRadio T="string" Value="@(task.Id.ToString())" Color="Color.Primary" Size="Size.Small">
                                    @displayName
                                </MudRadio>
                            }
                        </MudRadioGroup>

                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                            开启追踪后，画面会自动跟随小车移动
                        </MudText>
                    </div>
                }
            </div>
        </div>

        @* 中央画布 - 地图和AGV *@
        <div class="monitor-canvas"
             @onwheel="OnWheel"
             @onwheel:preventDefault="true"
             @onmousedown="OnMouseDown"
             @onmousemove="OnMouseMove"
             @onmouseup="OnMouseUp"
             @onmouseleave="OnMouseLeave">

            @if (_loading)
            {
                <div class="loading-overlay">
                    <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                    <MudText Typo="Typo.body1" Class="mt-2">加载中...</MudText>
                </div>
            }
            else if (_map != null)
            {
                @* 地图层 *@
                <div class="map-layer">
                    @((MarkupString)_mapSvg)
                </div>

                @* 任务路径层 *@
                <div class="task-paths-layer">
                    @((MarkupString)_taskPathsSvg)
                </div>

                @* AGV层 *@
                <div class="agv-layer">
                    @((MarkupString)_agvSvg)
                </div>

                @* 画布工具条 *@
                <div class="canvas-tools">
                    <MudIconButton Icon="@Icons.Material.Filled.ZoomOut"
                                   Size="Size.Small"
                                   OnClick="ZoomOut"
                                   Title="缩小" />
                    <MudNumericField T="int"
                                     Value="@((int)(_scale * 100))"
                                     ValueChanged="OnZoomValueChanged"
                                     Min="1"
                                     Max="100"
                                     Variant="Variant.Outlined"
                                     HideSpinButtons="true"
                                     Adornment="Adornment.End"
                                     AdornmentText="%"
                                     Style="width: 70px;"
                                     Margin="Margin.Dense" />
                    <MudIconButton Icon="@Icons.Material.Filled.ZoomIn"
                                   Size="Size.Small"
                                   OnClick="ZoomIn"
                                   Title="放大" />
                    <MudIconButton Icon="@Icons.Material.Filled.FitScreen"
                                   Size="Size.Small"
                                   OnClick="FitToScreen"
                                   Title="适应画布" />
                    <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                    <MudText Typo="Typo.caption" Class="mr-1">元素:</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.RemoveCircleOutline"
                                   Size="Size.Small"
                                   OnClick="DecreaseElementScale"
                                   Title="减小元素" />
                    <MudText Typo="Typo.caption">@(_elementScale.ToString("F1"))x</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.AddCircleOutline"
                                   Size="Size.Small"
                                   OnClick="IncreaseElementScale"
                                   Title="增大元素" />
                </div>

                @* 缩略图 *@
                <div class="minimap-container"
                     @onclick="OnMinimapClick">
                    <div class="minimap-content">
                        @((MarkupString)_minimapMapSvg)
                        @((MarkupString)_minimapAgvSvg)
                        @((MarkupString)_minimapOverlaySvg)
                    </div>
                </div>
            }
        </div>

        @* 右侧状态面板 - AGV监控 *@
        <div class="monitor-panel right-panel">
            <div class="panel-content">
                <AgvMonitorPanel AgvList="@_agvMonitorList"
                                 Stations="@_stations"
                                 Tasks="@_tasks"
                                 OnRefreshData="RefreshData" />
            </div>
        </div>
    </div>
</div>

@* 任务分配弹窗 *@
<CallForLoadingDialog Visible="_callForLoadingDialogVisible"
                      VisibleChanged="(v) => _callForLoadingDialogVisible = v"
                      Stations="_stations"
                      OnTaskCreated="RefreshData" />

<SendToUnloadingDialog Visible="_sendToUnloadingDialogVisible"
                       VisibleChanged="(v) => _sendToUnloadingDialogVisible = v"
                       Stations="_stations"
                       OnTaskCreated="RefreshData" />

<ReturnToWaitingDialog Visible="_returnToWaitingDialogVisible"
                       VisibleChanged="(v) => _returnToWaitingDialogVisible = v"
                       Stations="_stations"
                       OnTaskCreated="RefreshData" />

<SendToChargeDialog Visible="_sendToChargeDialogVisible"
                    VisibleChanged="(v) => _sendToChargeDialogVisible = v"
                    Stations="_stations"
                    OnTaskCreated="RefreshData" />

@* 设置对话框 *@
<TaskMonitorSettingsDialog Visible="_settingsDialogVisible"
                           VisibleChanged="(v) => _settingsDialogVisible = v"
                           RenderOptions="_renderOptions"
                           AutoRefresh="_autoRefresh"
                           RefreshInterval="_refreshIntervalSeconds"
                           EnableAutoSimulation="_enableAutoSimulation"
                           SimulationSpeedRatio="_simulationSpeedRatio"
                           Agvs="_agvs"
                           OnRenderOptionsChanged="OnRenderOptionsChanged"
                           OnAutoRefreshChanged="OnAutoRefreshChanged"
                           OnRefreshIntervalChanged="OnRefreshIntervalChanged"
                           OnAutoSimulationChanged="OnAutoSimulationChanged"
                           OnSimulationSpeedRatioChanged="OnSimulationSpeedRatioChanged"
                           OnControlSuccess="RefreshData" />

@code {
    // 地图数据
    private MapDetailDto? _map;
    private List<MapNodeListItemDto> _nodes = [];
    private List<MapEdgeListItemDto> _edges = [];
    private List<StationListItemDto> _stations = [];

    // AGV和任务数据
    private List<AgvListItemDto> _agvs = [];
    private List<AgvMonitorItemDto> _agvMonitorList = [];
    private List<TaskListItemDto> _tasks = [];

    // 弹窗控制
    private bool _callForLoadingDialogVisible = false;
    private bool _sendToUnloadingDialogVisible = false;
    private bool _returnToWaitingDialogVisible = false;
    private bool _sendToChargeDialogVisible = false;
    private bool _settingsDialogVisible = false;

    // 任务筛选
    private string? _selectedStatusValue = "Executing"; // 默认选中"执行中"
    private Guid? _selectedTaskId;

    // 渲染
    private MapRenderer _mapRenderer = new();
    private MiniMapRenderer _minimapRenderer = new();
    private SimulationRenderer _simulationRenderer = new();
    private MapRenderOptions _renderOptions = new() { ShowGrid = true, ShowArrows = true, ShowNodeLabels = false, ShowEdgeLabels = false, ShowStationLabels = true };
    private MapRenderData _renderData = new();
    private string _mapSvg = string.Empty;
    private string _agvSvg = string.Empty;
    private string _taskPathsSvg = string.Empty;
    private string _minimapMapSvg = string.Empty;
    private string _minimapAgvSvg = string.Empty;
    private string _minimapOverlaySvg = string.Empty;

    // 任务模拟
    private Dictionary<Guid, PathfindingResult> _taskPathCache = new();
    private Dictionary<Guid, AgvSimulator> _taskSimulators = new();
    private Dictionary<Guid, decimal> _lastTaskProgress = new();
    private System.Timers.Timer? _simulationTimer;
    private bool _enableAutoSimulation = true;
    private int _simulationSpeedRatio = 80;

    // 视图控制
    private float _viewWidth = 1200f;
    private float _viewHeight = 800f;
    private float _scale = 0.2f;
    private float _elementScale = 1.0f;
    private float _offsetX = 50f;
    private float _offsetY = 50f;
    private bool _isDragging = false;
    private double _lastMouseX;
    private double _lastMouseY;

    // 缩略图
    private const float MinimapWidth = 330f;
    private const float MinimapHeight = 440f;
    private float _minimapScale = 0.01f;
    private float _minimapOffsetX = 0f;
    private float _minimapOffsetY = 0f;

    // UI 状态
    private bool _loading = true;
    private bool _autoRefresh = true;
    private int _refreshIntervalSeconds = 2;
    private System.Timers.Timer? _refreshTimer;

    // 追踪控制
    private string _trackingMode = "none"; // "none" 或 任务ID

    private List<TaskListItemDto> FilteredTasks
    {
        get
        {
            if (string.IsNullOrEmpty(_selectedStatusValue))
                return _tasks.OrderByDescending(t => t.CreationDate).ToList();

            var status = Enum.Parse<TaskJobStatus>(_selectedStatusValue);
            return _tasks.Where(t => t.TaskStatus == status).OrderByDescending(t => t.CreationDate).ToList();
        }
    }

    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            await LoadMapData();
            await LoadAgvsAndTasks();
            _loading = false;

            // 启动自动刷新定时器
            _refreshTimer = new System.Timers.Timer(_refreshIntervalSeconds * 1000);
            _refreshTimer.Elapsed += OnRefreshTimerElapsed;
            if (_autoRefresh)
            {
                _refreshTimer.Start();
            }

            // 启动模拟定时器
            _simulationTimer = new System.Timers.Timer(50);
            _simulationTimer.Elapsed += OnSimulationTimerElapsed;
            if (_enableAutoSimulation)
            {
                _simulationTimer.Start();
            }

            StateHasChanged();
        }
    }

    private async Task LoadMapData()
    {
        try
        {
            // 获取所有地图，按 SortNo 排序
            var maps = await MapClient.GetAllAsync();
            var mapListItem = maps.OrderBy(m => m.SortNo).FirstOrDefault();

            if (mapListItem == null)
            {
                Snackbar.Add("未找到可用地图", Severity.Warning);
                return;
            }

            var mapId = mapListItem.Id;

            // 加载地图详情
            _map = await MapClient.GetByIdAsync(mapId);
            if (_map == null)
            {
                Snackbar.Add("加载地图详情失败", Severity.Error);
                return;
            }

            // 加载节点、边和站点
            _nodes = await MapClient.GetNodesAsync(mapId);
            _edges = await MapClient.GetEdgesAsync(mapId);
            _stations = await StationClient.GetAllAsync(mapId);

            // 初始化渲染数据
            _renderData.Width = _map.Width;
            _renderData.Height = _map.Height;
            _renderData.Nodes = _nodes;
            _renderData.Edges = _edges;
            _renderData.Stations = _stations;

            // 设置缩放比例
            _scale = 0.2f;

            // 计算偏移使地图居中
            var mapWidth = (float)_map.Width;
            var mapHeight = (float)_map.Height;
            _offsetX = (_viewWidth - mapWidth * _scale) / 2f;
            _offsetY = (_viewHeight - mapHeight * _scale) / 2f;

            RenderMap();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载地图失败: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAgvsAndTasks()
    {
        try
        {
            // 加载所有AGV和活动任务用于地图渲染
            _agvs = await AgvClient.GetAllAsync();
            _tasks = await TaskClient.GetActiveTasksAsync();

            // 加载AGV监控数据
            _agvMonitorList = await AgvClient.GetMonitorListAsync();

            // 处理执行中的任务
            ProcessExecutingTasks();

            RenderAgvs();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载数据失败: {ex.Message}", Severity.Error);
        }
    }

    private async Task RefreshData()
    {
        await LoadAgvsAndTasks();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnRefreshTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        await LoadAgvsAndTasks();
        await InvokeAsync(StateHasChanged);
    }

    #region 任务分配

    private void OpenTaskDialog(TaskJobType taskType)
    {
        switch (taskType)
        {
            case TaskJobType.CallForLoading:
                _callForLoadingDialogVisible = true;
                break;
            case TaskJobType.SendToUnloading:
                _sendToUnloadingDialogVisible = true;
                break;
            case TaskJobType.ReturnToWaiting:
                _returnToWaitingDialogVisible = true;
                break;
            case TaskJobType.SendToCharge:
                _sendToChargeDialogVisible = true;
                break;
        }
    }

    #endregion

    #region 设置

    private void OpenSettings()
    {
        _settingsDialogVisible = true;
    }

    private void OnRenderOptionsChanged(MapRenderOptions options)
    {
        _renderOptions.ShowNodeLabels = options.ShowNodeLabels;
        _renderOptions.ShowStationLabels = options.ShowStationLabels;
        _renderOptions.ShowEdgeLabels = options.ShowEdgeLabels;
        _renderOptions.ShowArrows = options.ShowArrows;
        RenderMap();
    }

    private void OnAutoRefreshChanged(bool autoRefresh)
    {
        _autoRefresh = autoRefresh;
        if (_autoRefresh)
        {
            _refreshTimer?.Start();
        }
        else
        {
            _refreshTimer?.Stop();
        }
    }

    private void OnRefreshIntervalChanged(int intervalSeconds)
    {
        _refreshIntervalSeconds = intervalSeconds;

        // 重新创建定时器
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
        _refreshTimer = new System.Timers.Timer(_refreshIntervalSeconds * 1000);
        _refreshTimer.Elapsed += OnRefreshTimerElapsed;

        if (_autoRefresh)
        {
            _refreshTimer.Start();
        }
    }

    private void OnAutoSimulationChanged(bool enabled)
    {
        _enableAutoSimulation = enabled;
        if (_enableAutoSimulation)
        {
            _simulationTimer?.Start();
        }
        else
        {
            _simulationTimer?.Stop();
        }
    }

    private void OnSimulationSpeedRatioChanged(int ratio)
    {
        _simulationSpeedRatio = ratio;
    }

    #endregion

    #region 追踪控制

    /// <summary>
    /// 切换追踪模式
    /// </summary>
    private void OnTrackingModeChanged(string mode)
    {
        _trackingMode = mode;

        // 如果切换到追踪模式，立即跟随选中的小车
        if (_trackingMode != "none" && Guid.TryParse(_trackingMode, out var taskId))
        {
            ApplyTracking(taskId);
        }
    }

    /// <summary>
    /// 应用追踪逻辑
    /// </summary>
    private void ApplyTracking(Guid taskId)
    {
        if (!_taskSimulators.TryGetValue(taskId, out var simulator))
            return;

        var agvX = (float)simulator.CurrentPosition.X;
        var agvY = (float)simulator.CurrentPosition.Y;

        // 使小车位置居中
        _offsetX = -agvX * _scale + _viewWidth / 2f;
        _offsetY = -agvY * _scale + _viewHeight / 2f;

        // 重新渲染整个地图（包括地图层、任务路径层和缩略图）
        RenderMap();
    }

    #endregion

    #region 任务模拟

    /// <summary>
    /// 处理执行中的任务
    /// </summary>
    private void ProcessExecutingTasks()
    {
        var executingTasks = _tasks.Where(t => t.TaskStatus == TaskJobStatus.Executing).ToList();

        // 清理已完成或取消的任务
        var taskIdsToRemove = _taskSimulators.Keys
            .Where(id => !executingTasks.Any(t => t.Id == id))
            .ToList();

        foreach (var taskId in taskIdsToRemove)
        {
            if (_taskSimulators.TryGetValue(taskId, out var simulator))
            {
                simulator.Stop();
            }
            _taskSimulators.Remove(taskId);
            _taskPathCache.Remove(taskId);
            _lastTaskProgress.Remove(taskId);

            // 如果正在追踪的任务已完成，取消追踪
            if (_trackingMode == taskId.ToString())
            {
                _trackingMode = "none";
            }
        }

        // 处理每个执行中的任务
        foreach (var task in executingTasks)
        {
            OnTaskProgressUpdated(task);
        }

        // 渲染任务路径和小地图
        RenderTaskPaths();
        RenderMinimapAgvs();
    }

    /// <summary>
    /// 任务进度更新处理
    /// </summary>
    private void OnTaskProgressUpdated(TaskListItemDto task)
    {
        // 如果进度为 null，初始化为 0，以便启动自动模拟
        var progress = task.ProgressPercentage ?? 0m;

        if (progress < 0)
            return;

        // 检查进度是否变化
        var progressChanged = !_lastTaskProgress.ContainsKey(task.Id) ||
                              _lastTaskProgress[task.Id] != progress;

        if (!progressChanged && _taskSimulators.ContainsKey(task.Id))
            return; // 进度未变化且模拟器已存在，无需处理

        _lastTaskProgress[task.Id] = progress;

        // 获取或创建路径
        if (!_taskPathCache.ContainsKey(task.Id))
        {
            var path = CalculateTaskPath(task);
            if (path == null || !path.Success)
                return;

            _taskPathCache[task.Id] = path;
        }

        var pathResult = _taskPathCache[task.Id];

        // 获取或创建模拟器
        if (!_taskSimulators.ContainsKey(task.Id))
        {
            var simulator = CreateTaskSimulator(pathResult, task);
            if (simulator == null)
                return;

            _taskSimulators[task.Id] = simulator;
        }

        // 跳转到新进度并启动模拟
        var taskSimulator = _taskSimulators[task.Id];
        taskSimulator.JumpToProgress(progress);

        // 如果任务已完成，不再启动模拟器
        if (_enableAutoSimulation &&
            taskSimulator.State != SimulationState.Running &&
            taskSimulator.State != SimulationState.Completed)
        {
            taskSimulator.Start();
        }
    }

    /// <summary>
    /// 计算任务路径
    /// </summary>
    private PathfindingResult? CalculateTaskPath(TaskListItemDto task)
    {
        try
        {
            if (string.IsNullOrEmpty(task.StartStationCode) || string.IsNullOrEmpty(task.EndStationCode))
                return null;

            // 根据StationCode查找Station
            var startStation = _stations.FirstOrDefault(s => s.StationCode == task.StartStationCode);
            var endStation = _stations.FirstOrDefault(s => s.StationCode == task.EndStationCode);

            if (startStation == null || endStation == null)
                return null;

            var pathfinder = new AStarPathfinder(_nodes, _edges, _stations);
            return pathfinder.FindPath(startStation.Id, endStation.Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"计算任务路径失败: {ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// 创建任务模拟器
    /// </summary>
    private AgvSimulator? CreateTaskSimulator(PathfindingResult path, TaskListItemDto task)
    {
        try
        {
            // 获取AGV信息以获取速度
            var agv = string.IsNullOrEmpty(task.AssignedAgvCode)
                ? null
                : _agvs.FirstOrDefault(a => a.AgvCode == task.AssignedAgvCode);
            // 数据库存储单位是 m/s，需要转换为 cm/s（乘以100）
            var speedInMs = agv?.Speed ?? 0.5m; // 默认速度 0.5 m/s
            var speed = speedInMs * 100m; // 转换为 cm/s

            var config = new AgvSimulationConfig
            {
                Speed = speed,
                UpdateIntervalMs = 50
            };

            var simulator = new AgvSimulator(path, _nodes, _edges, config);

            return simulator;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"创建任务模拟器失败: {ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// 模拟定时器更新
    /// </summary>
    private void OnSimulationTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        if (!_enableAutoSimulation) return;

        var needsRender = false;

        foreach (var (taskId, simulator) in _taskSimulators.ToList())
        {
            if (simulator.State == SimulationState.Running)
            {
                // 使用配置的速度比例进行模拟
                var speedRatio = _simulationSpeedRatio / 100m;
                simulator.UpdateWithSpeedRatio(speedRatio);
                needsRender = true;
            }
        }

        if (needsRender)
        {
            InvokeAsync(() =>
            {
                // 应用追踪逻辑
                if (_trackingMode != "none" && Guid.TryParse(_trackingMode, out var trackedTaskId))
                {
                    if (_taskSimulators.TryGetValue(trackedTaskId, out var trackedSimulator))
                    {
                        var agvX = (float)trackedSimulator.CurrentPosition.X;
                        var agvY = (float)trackedSimulator.CurrentPosition.Y;

                        // 使小车位置居中
                        _offsetX = -agvX * _scale + _viewWidth / 2f;
                        _offsetY = -agvY * _scale + _viewHeight / 2f;

                        // 重新渲染整个地图（包括地图层、任务路径层和缩略图）
                        RenderMap();
                    }
                    else
                    {
                        // 如果追踪的任务已完成或不存在，更新任务路径和小地图
                        RenderTaskPaths();
                        RenderMinimapAgvs();
                    }
                }
                else
                {
                    // 不追踪时更新任务路径和小地图
                    RenderTaskPaths();
                    RenderMinimapAgvs();
                }

                StateHasChanged();
            });
        }
    }

    /// <summary>
    /// 渲染任务路径
    /// </summary>
    private void RenderTaskPaths()
    {
        if (_map == null || _taskSimulators.Count == 0)
        {
            _taskPathsSvg = string.Empty;
            return;
        }

        // 准备模拟数据
        var simulatedAgvs = new List<AgvSimulationData>();

        foreach (var (taskId, simulator) in _taskSimulators)
        {
            if (!_taskPathCache.TryGetValue(taskId, out var path))
                continue;

            simulatedAgvs.Add(new AgvSimulationData
            {
                Position = simulator.CurrentPosition,
                StartNodeId = path.NodePath.First(),
                EndNodeId = path.NodePath.Last(),
                PathEdgeIds = path.EdgePath,
                Config = new AgvSimulationConfig
                {
                    AgvSize = 20f,
                    AgvColor = "#2196F3",
                    StartMarkerColor = "#4CAF50",
                    EndMarkerColor = "#F44336",
                    TraveledPathColor = "#2196F3",
                    TraveledPathWidth = 3f,
                    ToEndLineColor = "#9E9E9E",
                    ToEndLineDashArray = "5,5"
                }
            });
        }

        _renderData.SimulatedAgvs = simulatedAgvs;

        _taskPathsSvg = _simulationRenderer.RenderSimulationLayer(
            _renderData,
            _viewWidth,
            _viewHeight,
            _scale,
            _offsetX,
            _offsetY,
            elementScale: _elementScale);
    }

    #endregion

    #region 任务操作

    private void SelectTask(Guid taskId)
    {
        _selectedTaskId = taskId;
        // TODO: 在地图上高亮显示任务路径
    }

    #endregion

    #region 地图渲染

    private void RenderMap()
    {
        if (_map == null) return;

        _mapRenderer = new MapRenderer(_renderOptions);
        _mapSvg = _mapRenderer.Render(
            _renderData,
            _viewWidth,
            _viewHeight,
            _scale,
            _offsetX,
            _offsetY,
            elementScale: _elementScale);

        RenderAgvs();
        RenderTaskPaths();
        RenderMinimap();
    }

    private void RenderAgvs()
    {
        if (_map == null) return;

        var svg = new System.Text.StringBuilder();
        svg.AppendLine($"<svg width=\"{_viewWidth}\" height=\"{_viewHeight}\" xmlns=\"http://www.w3.org/2000/svg\">");

        // 构建任务到模拟器的映射（AgvCode -> Simulator）
        var agvSimulatorMap = new Dictionary<string, (AgvSimulator Simulator, PathfindingResult Path)>();
        foreach (var (taskId, simulator) in _taskSimulators)
        {
            var task = _tasks.FirstOrDefault(t => t.Id == taskId);
            if (task == null || task.TaskStatus != TaskJobStatus.Executing || string.IsNullOrEmpty(task.AssignedAgvCode))
                continue;

            if (!_taskPathCache.TryGetValue(taskId, out var path))
                continue;

            agvSimulatorMap[task.AssignedAgvCode] = (simulator, path);
        }

        // 遍历所有 AGV，每个 AGV 只渲染一次
        foreach (var agv in _agvs)
        {
            // 离线的 AGV 不显示
            if (agv.AgvStatus == AgvStatus.Offline)
                continue;

            // 优先显示：如果 AGV 在模拟器中（正在执行任务），跳过（由任务路径层渲染）
            if (agvSimulatorMap.ContainsKey(agv.AgvCode))
                continue;

            // 否则：使用站点位置渲染
            var station = _stations.FirstOrDefault(s => s.StationCode == agv.CurrentStationCode);
            if (station == null)
                continue;

            var x = (float)station.X * _scale + _offsetX;
            var y = (float)station.Y * _scale + _offsetY;
            var size = 20f * _elementScale;
            var angleInDegrees = (double)agv.PositionAngle; // 从数据库读取的是度数(0-360)
            var angleInRadians = angleInDegrees * Math.PI / 180.0; // 转换为弧度
            var color = "#4CAF50"; // 空闲状态使用绿色

            // 三角形顶点（未旋转时，箭头指向右侧）
            var halfSize = size * 0.5f;
            var tipLength = size * 0.8f;

            var p1X = tipLength;
            var p1Y = 0f;
            var p2X = -tipLength * 0.3f;
            var p2Y = -halfSize;
            var p3X = -tipLength * 0.3f;
            var p3Y = halfSize;

            // 旋转并平移
            var cos = (float)Math.Cos(angleInRadians);
            var sin = (float)Math.Sin(angleInRadians);

            float RotateX(float px, float py) => x + px * cos - py * sin;
            float RotateY(float px, float py) => y + px * sin + py * cos;

            var r1X = RotateX(p1X, p1Y);
            var r1Y = RotateY(p1X, p1Y);
            var r2X = RotateX(p2X, p2Y);
            var r2Y = RotateY(p2X, p2Y);
            var r3X = RotateX(p3X, p3Y);
            var r3Y = RotateY(p3X, p3Y);

            // 绘制填充的三角形
            svg.AppendLine($"  <path d=\"M{r1X.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{r1Y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)} " +
                $"L{r2X.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{r2Y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)} " +
                $"L{r3X.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{r3Y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)} Z\" " +
                $"fill=\"{color}\" stroke=\"white\" stroke-width=\"2\" />");

            // AGV编号
            svg.AppendLine($"<text x=\"{x}\" y=\"{y + size + 12}\" text-anchor=\"middle\" font-size=\"12\" fill=\"#333\" font-weight=\"bold\">{agv.AgvCode}</text>");

            // 电量
            svg.AppendLine($"<text x=\"{x}\" y=\"{y + size + 24}\" text-anchor=\"middle\" font-size=\"10\" fill=\"#666\">{agv.Battery}%</text>");
        }

        svg.AppendLine("</svg>");
        _agvSvg = svg.ToString();

        // 同时更新缩略图上的AGV，确保实时同步
        RenderMinimapAgvs();
    }

    private void RenderMinimap()
    {
        if (_map == null) return;

        // 渲染小地图地图层
        _minimapMapSvg = _minimapRenderer.RenderMap(
            _renderData,
            MinimapWidth,
            MinimapHeight,
            out _minimapScale,
            out _minimapOffsetX,
            out _minimapOffsetY,
            elementScale: 0.5f);

        // 渲染小地图上的AGV（空闲且在站点的AGV）
        RenderMinimapAgvs();

        // 渲染小地图覆盖层（视窗框）
        _minimapOverlaySvg = _minimapRenderer.RenderOverlay(
            minimapWidth: MinimapWidth,
            minimapHeight: MinimapHeight,
            minimapScale: _minimapScale,
            minimapOffsetX: _minimapOffsetX,
            minimapOffsetY: _minimapOffsetY,
            mainViewScale: _scale,
            mainViewOffsetX: _offsetX,
            mainViewOffsetY: _offsetY,
            mainViewWidth: _viewWidth,
            mainViewHeight: _viewHeight,
            agvPosition: null,
            agvSize: 16f,
            agvColor: "#2196F3",
            endPosition: null,
            endMarkerSize: 12f,
            viewportColor: "#FF5722",
            viewportStrokeWidth: 2f,
            viewportDashArray: "5,5");
    }

    private void RenderMinimapAgvs()
    {
        var svg = new System.Text.StringBuilder();
        svg.AppendLine($"<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"{MinimapWidth}\" height=\"{MinimapHeight}\" " +
            $"style=\"position:absolute;top:0;left:0;pointer-events:none;\">");

        // 构建任务到模拟器的映射（AgvCode -> Simulator）
        var agvSimulatorMap = new Dictionary<string, (AgvSimulator Simulator, PathfindingResult Path)>();
        foreach (var (taskId, simulator) in _taskSimulators)
        {
            var task = _tasks.FirstOrDefault(t => t.Id == taskId);
            if (task == null || task.TaskStatus != TaskJobStatus.Executing || string.IsNullOrEmpty(task.AssignedAgvCode))
                continue;

            if (!_taskPathCache.TryGetValue(taskId, out var path))
                continue;

            agvSimulatorMap[task.AssignedAgvCode] = (simulator, path);
        }

        // 遍历所有 AGV，每个 AGV 只渲染一次
        foreach (var agv in _agvs)
        {
            // 离线的 AGV 不显示
            if (agv.AgvStatus == AgvStatus.Offline)
                continue;

            // 优先显示：如果 AGV 在模拟器中（正在执行任务），使用模拟位置
            if (agvSimulatorMap.TryGetValue(agv.AgvCode, out var simData))
            {
                // 渲染任务终点标记
                var endNodeId = simData.Path.NodePath.Last();
                var endNode = _nodes.FirstOrDefault(n => n.Id == endNodeId);
                if (endNode != null)
                {
                    var endX = _minimapOffsetX + (float)endNode.X * _minimapScale;
                    var endY = _minimapOffsetY + (float)endNode.Y * _minimapScale;
                    var radius = 8f;
                    svg.AppendLine($"  <circle cx=\"{endX}\" cy=\"{endY}\" r=\"{radius}\" " +
                        $"fill=\"none\" stroke=\"#F44336\" stroke-width=\"2\" />");
                }

                // 渲染 AGV（使用模拟位置）
                var agvX = _minimapOffsetX + (float)simData.Simulator.CurrentPosition.X * _minimapScale;
                var agvY = _minimapOffsetY + (float)simData.Simulator.CurrentPosition.Y * _minimapScale;
                var agvAngle = simData.Simulator.CurrentPosition.Angle;
                var size = 16f;
                var color = "#2196F3"; // 执行中使用蓝色

                RenderAgvTriangle(svg, agvX, agvY, agvAngle, size, color);
            }
            else
            {
                // 否则：使用站点位置渲染
                var station = _stations.FirstOrDefault(s => s.StationCode == agv.CurrentStationCode);
                if (station == null)
                    continue;

                var agvX = _minimapOffsetX + (float)station.X * _minimapScale;
                var agvY = _minimapOffsetY + (float)station.Y * _minimapScale;
                var agvAngleInDegrees = (double)agv.PositionAngle;
                var agvAngleInRadians = agvAngleInDegrees * Math.PI / 180.0;
                var size = 16f;
                var color = "#4CAF50"; // 空闲状态绿色

                RenderAgvTriangle(svg, agvX, agvY, agvAngleInRadians, size, color);
            }
        }

        svg.AppendLine("</svg>");
        _minimapAgvSvg = svg.ToString();
    }

    /// <summary>
    /// 渲染 AGV 三角形图标（辅助方法）
    /// </summary>
    private void RenderAgvTriangle(System.Text.StringBuilder svg, float x, float y, double angle, float size, string color)
    {
        var halfSize = size * 0.5f;
        var tipLength = size * 0.8f;

        var p1X = tipLength;
        var p1Y = 0f;
        var p2X = -tipLength * 0.3f;
        var p2Y = -halfSize;
        var p3X = -tipLength * 0.3f;
        var p3Y = halfSize;

        var cos = (float)Math.Cos(angle);
        var sin = (float)Math.Sin(angle);

        float RotateX(float px, float py) => x + px * cos - py * sin;
        float RotateY(float px, float py) => y + px * sin + py * cos;

        var r1X = RotateX(p1X, p1Y);
        var r1Y = RotateY(p1X, p1Y);
        var r2X = RotateX(p2X, p2Y);
        var r2Y = RotateY(p2X, p2Y);
        var r3X = RotateX(p3X, p3Y);
        var r3Y = RotateY(p3X, p3Y);

        svg.AppendLine($"  <path d=\"M{r1X.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{r1Y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)} " +
            $"L{r2X.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{r2Y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)} " +
            $"L{r3X.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{r3Y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)} Z\" " +
            $"fill=\"{color}\" stroke=\"white\" stroke-width=\"1\" />");
    }

    #endregion

    #region 缩放控制

    private void ZoomIn()
    {
        _scale *= 1.2f;
        _scale = Math.Min(1f, _scale);
        RenderMap();
    }

    private void ZoomOut()
    {
        _scale *= 0.8f;
        _scale = Math.Max(0.01f, _scale);
        RenderMap();
    }

    private void OnZoomValueChanged(int value)
    {
        _scale = value / 100f;
        _scale = Math.Max(0.01f, Math.Min(1f, _scale));
        RenderMap();
    }

    private void IncreaseElementScale()
    {
        _elementScale = Math.Min(10f, _elementScale + 0.5f);
        RenderMap();
    }

    private void DecreaseElementScale()
    {
        _elementScale = Math.Max(0.5f, _elementScale - 0.5f);
        RenderMap();
    }

    private void FitToScreen()
    {
        if (_map == null) return;
        var mapWidth = (float)_map.Width;
        var mapHeight = (float)_map.Height;
        var scaleX = (_viewWidth - 100) / mapWidth;
        var scaleY = (_viewHeight - 100) / mapHeight;
        _scale = Math.Min(scaleX, scaleY) * 0.9f;
        _offsetX = 50;
        _offsetY = 50;
        RenderMap();
    }

    private void OnWheel(WheelEventArgs e)
    {
        var zoomFactor = e.DeltaY > 0 ? 0.9f : 1.1f;
        _scale *= zoomFactor;
        _scale = Math.Max(0.01f, Math.Min(1f, _scale));
        RenderMap();
    }

    #endregion

    #region 鼠标拖拽

    private void OnMouseDown(MouseEventArgs e)
    {
        _isDragging = true;
        _lastMouseX = e.ClientX;
        _lastMouseY = e.ClientY;
    }

    private void OnMouseMove(MouseEventArgs e)
    {
        if (!_isDragging) return;

        var deltaX = (float)(e.ClientX - _lastMouseX);
        var deltaY = (float)(e.ClientY - _lastMouseY);

        _offsetX += deltaX;
        _offsetY += deltaY;

        _lastMouseX = e.ClientX;
        _lastMouseY = e.ClientY;

        // 手动拖动地图时，取消追踪模式
        if (_trackingMode != "none")
        {
            _trackingMode = "none";
        }

        RenderMap();
    }

    private void OnMouseUp(MouseEventArgs e)
    {
        _isDragging = false;
    }

    private void OnMouseLeave(MouseEventArgs e)
    {
        _isDragging = false;
    }

    #endregion

    #region 缩略图导航

    private void OnMinimapClick(MouseEventArgs e)
    {
        if (_map == null) return;

        // 获取点击位置相对于缩略图容器的坐标
        var clickX = (float)e.OffsetX;
        var clickY = (float)e.OffsetY;

        // 转换到地图坐标
        var mapX = (clickX - _minimapOffsetX) / _minimapScale;
        var mapY = (clickY - _minimapOffsetY) / _minimapScale;

        // 计算新的偏移量，使点击位置居中
        _offsetX = -mapX * _scale + _viewWidth / 2f;
        _offsetY = -mapY * _scale + _viewHeight / 2f;

        // 手动导航时，取消追踪模式
        if (_trackingMode != "none")
        {
            _trackingMode = "none";
        }

        RenderMap();
    }

    #endregion

    #region 辅助方法

    private Color GetTaskStatusColor(TaskJobStatus status) => status switch
    {
        TaskJobStatus.Pending => Color.Default,
        TaskJobStatus.Assigned => Color.Info,
        TaskJobStatus.Executing => Color.Primary,
        TaskJobStatus.Completed => Color.Success,
        TaskJobStatus.Cancelled => Color.Warning,
        TaskJobStatus.Failed => Color.Error,
        _ => Color.Default
    };

    #endregion

    public void Dispose()
    {
        _refreshTimer?.Dispose();
        _simulationTimer?.Dispose();

        // 清理所有模拟器
        foreach (var simulator in _taskSimulators.Values)
        {
            simulator.Stop();
        }
        _taskSimulators.Clear();
        _taskPathCache.Clear();
    }
}

<style>
    .task-monitor-page {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #f5f5f5;
    }

    .monitor-toolbar {
        height: 50px;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 16px;
    }

    .toolbar-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .toolbar-center {
        flex: 1;
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    .toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .monitor-body {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    .monitor-panel {
        background: white;
        overflow-y: auto;
    }

    .left-panel {
        width: 320px;
        border-right: 1px solid #e0e0e0;
    }

    .action-button {
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
    }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .action-button:active {
            transform: translateY(0);
        }

    .right-panel {
        width: 320px;
        border-left: 1px solid #e0e0e0;
    }

    .panel-content {
        padding: 16px;
    }

    .panel-section {
        padding: 12px;
        background: #fafafa;
        border-radius: 4px;
    }

    .monitor-canvas {
        flex: 1;
        position: relative;
        overflow: hidden;
        cursor: grab;
        background: #fafafa;
    }

        .monitor-canvas:active {
            cursor: grabbing;
        }

    .map-layer, .task-paths-layer, .agv-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .canvas-tools {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(255,255,255,0.95);
        padding: 4px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .minimap-container {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 330px;
        height: 440px;
        background: rgba(255,255,255,0.95);
        border: 2px solid #2196F3;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        overflow: hidden;
    }

    .minimap-content {
        width: 100%;
        height: 100%;
        position: relative;
    }

        .minimap-content > svg {
            position: absolute;
            top: 0;
            left: 0;
        }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.9);
    }

    .selected-card {
        border-color: #2196F3 !important;
        border-width: 2px !important;
        background: #E3F2FD !important;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .spinning {
        animation: spin 2s linear infinite;
    }

    /* 任务筛选按钮样式增强 */
    .panel-section .mud-chip-set .mud-chip {
        font-weight: 500;
        border-width: 2px;
        transition: all 0.2s ease;
    }

    /* 选中状态的筛选按钮 */
    .panel-section .mud-chip-set .mud-chip.mud-chip-selected {
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }

    /* 未选中状态的筛选按钮 - 更淡的颜色 */
    .panel-section .mud-chip-set .mud-chip:not(.mud-chip-selected) {
        opacity: 0.6;
        background-color: transparent !important;
    }

    /* 鼠标悬停效果 */
    .panel-section .mud-chip-set .mud-chip:hover {
        opacity: 1;
        transform: scale(1.02);
    }
</style>
