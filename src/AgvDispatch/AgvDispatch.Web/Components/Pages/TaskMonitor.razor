@page "/task-monitor"
@layout ContentLayout
@using AgvDispatch.Shared.DTOs.MapEdges
@using AgvDispatch.Shared.DTOs.MapNodes
@using AgvDispatch.Shared.DTOs.Maps
@using AgvDispatch.Shared.DTOs.Stations
@using AgvDispatch.Shared.DTOs.Agvs
@using AgvDispatch.Shared.DTOs.Tasks
@using AgvDispatch.Shared.DTOs.PathLocks
@using AgvDispatch.Shared.Enums
@using AgvDispatch.Shared.Rendering
@using AgvDispatch.Shared.PathFinding
@using AgvDispatch.Shared.Simulation
@using AgvDispatch.Web.Services
@using AgvDispatch.Web.Components.Shared
@using System.Timers
@rendermode InteractiveServer
@inject IMapClient MapClient
@inject IStationClient StationClient
@inject IAgvClient AgvClient
@inject ITaskClient TaskClient
@inject IPathLockClient PathLockClient
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>任务调度与监控 - AGV调度系统</PageTitle>

<div class="task-monitor-page">
    @* 顶部工具栏 *@
    <div class="monitor-toolbar">
        <div class="toolbar-left">
            <MudText Typo="Typo.body2">
                <strong>任务调度与监控</strong>
            </MudText>
            @if (_map != null)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-2">
                    地图: @_map.MapCode @_map.DisplayName
                </MudText>
            }
        </div>

        <div class="toolbar-center">
            <MudChip T="string" Color="Color.Info" Size="Size.Small">
                AGV: @_agvs.Count 辆
            </MudChip>
            <MudChip T="string" Color="Color.Success" Size="Size.Small">
                任务: @_tasks.Count 个
            </MudChip>
        </div>

        <div class="toolbar-right">
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Size="Size.Small"
                           OnClick="RefreshData"
                           Title="立即刷新" />
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                           Size="Size.Small"
                           OnClick="OpenSettings"
                           Title="设置" />
        </div>
    </div>

    @* 主体区域 *@
    <div class="monitor-body">
        @* 左侧控制面板 - 四个功能按钮 *@
        <div class="monitor-panel left-panel">
            <div class="panel-content">
                <MudStack Spacing="3">
                    @* 召唤小车上料 *@
                    <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.CallForLoading)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Upload" Color="Color.Success" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Success">召唤小车上料</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                将空闲小车召唤到上料点
                            </MudText>
                        </MudStack>
                    </MudPaper>

                    @* 告知小车去下料 *@
                    <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.SendToUnloading)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Download" Color="Color.Info" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Info">告知小车去下料</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                指派小车前往下料点
                            </MudText>
                        </MudStack>
                    </MudPaper>

                    @* 确认下料去等待区 *@
@*                     <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.ReturnToWaiting)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Home" Color="Color.Warning" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Warning">确认下料去等待区</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                完成下料后返回等待区
                            </MudText>
                        </MudStack>
                    </MudPaper> *@

                    @* 让小车充电 *@
@*                     <MudPaper Elevation="2" Class="action-button" @onclick="() => OpenTaskDialog(TaskJobType.SendToCharge)">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.BatteryChargingFull" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Primary">让小车充电</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                                将小车送往充电站
                            </MudText>
                        </MudStack>
                    </MudPaper> *@
                </MudStack>

                @* 已放行区域显示 *@
                @if (true)
                {
                    <div class="panel-section mt-3">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Style="vertical-align: middle;" />
                            已放行区域
                        </MudText>

                        <MudStack Spacing="1">
                            @foreach (var channel in _activeChannels)
                            {
                                <MudPaper Elevation="1" Class="pa-2 channel-item" Style="background-color: #f5f5f5; cursor: pointer;"
                                          @onclick="() => OpenChannelDetailDialog(channel.ChannelName)">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@channel.ChannelName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">(@channel.AgvCount 辆)</MudText>
                                        <MudSpacer />
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" Color="Color.Secondary" />
                                    </MudStack>
                                </MudPaper>
                            }
                        </MudStack>
                    </div>
                }

                @* 追踪小车控制 *@
                @if (true)
                {
                    <div class="panel-section mt-3">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.MyLocation" Size="Size.Small" Style="vertical-align: middle;" />
                            追踪小车
                        </MudText>

                        <MudRadioGroup T="string" Value="@_trackingMode" ValueChanged="OnTrackingModeChanged">
                            <MudRadio T="string" Value="@("none")" Color="Color.Default" Size="Size.Small">
                                不追踪
                            </MudRadio>
                            @foreach (var task in _tasks.Where(t => t.TaskStatus == TaskJobStatus.Executing).OrderBy(t => t.Id))
                            {
                                var agv = _agvs.FirstOrDefault(a => a.AgvCode == task.AssignedAgvCode);
                                var displayName = agv?.DisplayName ?? task.AssignedAgvCode ?? "未分配";
                                <MudRadio T="string" Value="@(task.Id.ToString())" Color="Color.Primary" Size="Size.Small">
                                    @displayName
                                </MudRadio>
                            }
                        </MudRadioGroup>

                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                            开启追踪后，画面会自动跟随小车移动
                        </MudText>
                    </div>
                }
            </div>
        </div>

        @* 中央画布 - 使用 MapSimulationView 组件 *@
        <div class="monitor-canvas">
            @if (_loading)
            {
                <div class="loading-overlay">
                    <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                    <MudText Typo="Typo.body1" Class="mt-2">加载中...</MudText>
                </div>
            }
            else if (_map != null)
            {
                <MapSimulationView Map="_map"
                                  Nodes="_nodes"
                                  Edges="_edges"
                                  Stations="_stations"
                                  Agvs="_agvs"
                                  Tasks="_tasks"
                                  RenderOptions="_renderOptions"
                                  EnableAutoSimulation="_enableAutoSimulation"
                                  SimulationSpeedRatio="_simulationSpeedRatio"
                                  TrackingMode="@_trackingMode"
                                  TrackingModeChanged="OnTrackingModeChanged" />
            }
        </div>

        @* 右侧状态面板 - AGV监控 *@
        <div class="monitor-panel right-panel">
            <div class="panel-content">
                <AgvMonitorPanel AgvList="@_agvMonitorList"
                                 Stations="@_stations"
                                 Tasks="@_tasks"
                                 OnRefreshData="RefreshData" />
            </div>
        </div>
    </div>
</div>

@* 任务分配弹窗 *@
<CallForLoadingDialog Visible="_callForLoadingDialogVisible"
                      VisibleChanged="(v) => _callForLoadingDialogVisible = v"
                      Stations="_stations"
                      OnTaskCreated="RefreshData" />

<SendToUnloadingDialog Visible="_sendToUnloadingDialogVisible"
                       VisibleChanged="(v) => _sendToUnloadingDialogVisible = v"
                       Stations="_stations"
                       OnTaskCreated="RefreshData" />

<ReturnToWaitingDialog Visible="_returnToWaitingDialogVisible"
                       VisibleChanged="(v) => _returnToWaitingDialogVisible = v"
                       Stations="_stations"
                       OnTaskCreated="RefreshData" />

<SendToChargeDialog Visible="_sendToChargeDialogVisible"
                    VisibleChanged="(v) => _sendToChargeDialogVisible = v"
                    Stations="_stations"
                    OnTaskCreated="RefreshData" />

@* 设置对话框 *@
<TaskMonitorSettingsDialog Visible="_settingsDialogVisible"
                           VisibleChanged="(v) => _settingsDialogVisible = v"
                           RenderOptions="_renderOptions"
                           AutoRefresh="_autoRefresh"
                           RefreshInterval="_refreshIntervalSeconds"
                           EnableAutoSimulation="_enableAutoSimulation"
                           SimulationSpeedRatio="_simulationSpeedRatio"
                           Agvs="_agvs"
                           OnRenderOptionsChanged="OnRenderOptionsChanged"
                           OnAutoRefreshChanged="OnAutoRefreshChanged"
                           OnRefreshIntervalChanged="OnRefreshIntervalChanged"
                           OnAutoSimulationChanged="OnAutoSimulationChanged"
                           OnSimulationSpeedRatioChanged="OnSimulationSpeedRatioChanged"
                           OnControlSuccess="RefreshData" />

@* 通道详情弹窗 *@
<ChannelDetailDialog Visible="_channelDetailDialogVisible"
                     VisibleChanged="(v) => _channelDetailDialogVisible = v"
                     ChannelName="@_selectedChannelName"
                     OnChannelReleased="RefreshData" />

@code {
    // 地图数据
    private MapDetailDto? _map;
    private List<MapNodeListItemDto> _nodes = [];
    private List<MapEdgeListItemDto> _edges = [];
    private List<StationListItemDto> _stations = [];

    // AGV和任务数据
    private List<AgvListItemDto> _agvs = [];
    private List<AgvMonitorItemDto> _agvMonitorList = [];
    private List<TaskListItemDto> _tasks = [];

    // 路径锁定数据
    private List<ActiveChannelDto> _activeChannels = [];

    // 弹窗控制
    private bool _callForLoadingDialogVisible = false;
    private bool _sendToUnloadingDialogVisible = false;
    private bool _returnToWaitingDialogVisible = false;
    private bool _sendToChargeDialogVisible = false;
    private bool _settingsDialogVisible = false;
    private bool _channelDetailDialogVisible = false;
    private string _selectedChannelName = string.Empty;

    // 配置
    private MapRenderOptions _renderOptions = new() 
    { 
        ShowGrid = true, 
        ShowArrows = true, 
        ShowNodeLabels = false, 
        ShowEdgeLabels = false, 
        ShowStationLabels = true 
    };
    private bool _enableAutoSimulation = true;
    private int _simulationSpeedRatio = 80;

    // UI 状态
    private bool _loading = true;
    private bool _autoRefresh = true;
    private int _refreshIntervalSeconds = 2;
    private System.Timers.Timer? _refreshTimer;

    // 追踪控制
    private string _trackingMode = "none"; // "none" 或 任务ID

    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            await LoadMapData();
            await LoadAgvsAndTasks();
            _loading = false;

            // 启动自动刷新定时器
            _refreshTimer = new System.Timers.Timer(_refreshIntervalSeconds * 1000);
            _refreshTimer.Elapsed += OnRefreshTimerElapsed;
            if (_autoRefresh)
            {
                _refreshTimer.Start();
            }

            StateHasChanged();
        }
    }

    private async Task LoadMapData()
    {
        try
        {
            // 获取所有地图，按 SortNo 排序
            var maps = await MapClient.GetAllAsync();
            var mapListItem = maps.OrderBy(m => m.SortNo).FirstOrDefault();

            if (mapListItem == null)
            {
                Snackbar.Add("未找到可用地图", Severity.Warning);
                return;
            }

            var mapId = mapListItem.Id;

            // 加载地图详情
            _map = await MapClient.GetByIdAsync(mapId);
            if (_map == null)
            {
                Snackbar.Add("加载地图详情失败", Severity.Error);
                return;
            }

            // 加载节点、边和站点
            _nodes = await MapClient.GetNodesAsync(mapId);
            _edges = await MapClient.GetEdgesAsync(mapId);
            _stations = await StationClient.GetAllAsync(mapId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载地图失败: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAgvsAndTasks()
    {
        try
        {
            // 加载所有AGV和活动任务
            _agvs = await AgvClient.GetAllAsync();
            _tasks = await TaskClient.GetActiveTasksAsync();

            // 加载AGV监控数据
            _agvMonitorList = await AgvClient.GetMonitorListAsync();

            // 加载已放行通道
            _activeChannels = await PathLockClient.GetActiveChannelsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载数据失败: {ex.Message}", Severity.Error);
        }
    }

    private async Task RefreshData()
    {
        await LoadAgvsAndTasks();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnRefreshTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        await LoadAgvsAndTasks();
        await InvokeAsync(StateHasChanged);
    }

    #region 任务分配

    private void OpenTaskDialog(TaskJobType taskType)
    {
        switch (taskType)
        {
            case TaskJobType.CallForLoading:
                _callForLoadingDialogVisible = true;
                break;
            case TaskJobType.SendToUnloading:
                _sendToUnloadingDialogVisible = true;
                break;
            case TaskJobType.ReturnToWaiting:
                _returnToWaitingDialogVisible = true;
                break;
            case TaskJobType.SendToCharge:
                _sendToChargeDialogVisible = true;
                break;
        }
    }

    #endregion

    #region 设置

    private void OpenSettings()
    {
        _settingsDialogVisible = true;
    }

    private void OnRenderOptionsChanged(MapRenderOptions options)
    {
        _renderOptions.ShowNodeLabels = options.ShowNodeLabels;
        _renderOptions.ShowStationLabels = options.ShowStationLabels;
        _renderOptions.ShowEdgeLabels = options.ShowEdgeLabels;
        _renderOptions.ShowArrows = options.ShowArrows;
    }

    private void OnAutoRefreshChanged(bool autoRefresh)
    {
        _autoRefresh = autoRefresh;
        if (_autoRefresh)
        {
            _refreshTimer?.Start();
        }
        else
        {
            _refreshTimer?.Stop();
        }
    }

    private void OnRefreshIntervalChanged(int intervalSeconds)
    {
        _refreshIntervalSeconds = intervalSeconds;

        // 重新创建定时器
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
        _refreshTimer = new System.Timers.Timer(_refreshIntervalSeconds * 1000);
        _refreshTimer.Elapsed += OnRefreshTimerElapsed;

        if (_autoRefresh)
        {
            _refreshTimer.Start();
        }
    }

    private void OnAutoSimulationChanged(bool enabled)
    {
        _enableAutoSimulation = enabled;
    }

    private void OnSimulationSpeedRatioChanged(int ratio)
    {
        _simulationSpeedRatio = ratio;
    }

    #endregion

    #region 追踪控制

    /// <summary>
    /// 切换追踪模式
    /// </summary>
    private void OnTrackingModeChanged(string mode)
    {
        Console.WriteLine($"[TaskMonitor] 追踪模式变更: {_trackingMode} -> {mode}");
        _trackingMode = mode;

        // 关键：触发 UI 更新，确保参数变化传递到子组件
        StateHasChanged();
    }

    #endregion

    #region 通道详情

    /// <summary>
    /// 打开通道详情弹窗
    /// </summary>
    private void OpenChannelDetailDialog(string channelName)
    {
        _selectedChannelName = channelName;
        _channelDetailDialogVisible = true;
    }

    #endregion

    private Color GetTaskStatusColor(TaskJobStatus status) => status switch
    {
        TaskJobStatus.Pending => Color.Default,
        TaskJobStatus.Assigned => Color.Info,
        TaskJobStatus.Executing => Color.Primary,
        TaskJobStatus.Completed => Color.Success,
        TaskJobStatus.Cancelled => Color.Warning,
        TaskJobStatus.Failed => Color.Error,
        _ => Color.Default
    };

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}

<style>
    .task-monitor-page {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #f5f5f5;
    }

    .monitor-toolbar {
        height: 50px;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 16px;
    }

    .toolbar-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .toolbar-center {
        flex: 1;
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    .toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .monitor-body {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    .monitor-panel {
        background: white;
        overflow-y: auto;
    }

    .left-panel {
        width: 320px;
        border-right: 1px solid #e0e0e0;
    }

    .action-button {
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
    }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .action-button:active {
            transform: translateY(0);
        }

    .right-panel {
        width: 320px;
        border-left: 1px solid #e0e0e0;
    }

    .panel-content {
        padding: 16px;
    }

    .panel-section {
        padding: 12px;
        background: #fafafa;
        border-radius: 4px;
    }

    .monitor-canvas {
        flex: 1;
        position: relative;
        overflow: hidden;
        cursor: grab;
        background: #fafafa;
    }

        .monitor-canvas:active {
            cursor: grabbing;
        }

    .map-layer, .task-paths-layer, .agv-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .canvas-tools {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(255,255,255,0.95);
        padding: 4px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .minimap-container {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 330px;
        height: 440px;
        background: rgba(255,255,255,0.95);
        border: 2px solid #2196F3;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        overflow: hidden;
    }

    .minimap-content {
        width: 100%;
        height: 100%;
        position: relative;
    }

        .minimap-content > svg {
            position: absolute;
            top: 0;
            left: 0;
        }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.9);
    }

    .selected-card {
        border-color: #2196F3 !important;
        border-width: 2px !important;
        background: #E3F2FD !important;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .spinning {
        animation: spin 2s linear infinite;
    }

    /* 任务筛选按钮样式增强 */
    .panel-section .mud-chip-set .mud-chip {
        font-weight: 500;
        border-width: 2px;
        transition: all 0.2s ease;
    }

    /* 选中状态的筛选按钮 */
    .panel-section .mud-chip-set .mud-chip.mud-chip-selected {
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }

    /* 未选中状态的筛选按钮 - 更淡的颜色 */
    .panel-section .mud-chip-set .mud-chip:not(.mud-chip-selected) {
        opacity: 0.6;
        background-color: transparent !important;
    }

    /* 鼠标悬停效果 */
    .panel-section .mud-chip-set .mud-chip:hover {
        opacity: 1;
        transform: scale(1.02);
    }

    /* 通道项悬停效果 */
    .channel-item {
        transition: all 0.2s ease;
    }

        .channel-item:hover {
            background-color: #e3f2fd !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateX(4px);
        }
</style>
