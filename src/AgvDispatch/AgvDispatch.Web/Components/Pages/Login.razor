@page "/login"
@layout EmptyLayout
@inject IAuthClient AuthClient
@inject IAuthStateService AuthStateService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>登录 - AGV 调度系统</PageTitle>

<div class="login-page">
    <div class="login-background">
        <div class="bg-shape bg-shape-1"></div>
        <div class="bg-shape bg-shape-2"></div>
        <div class="bg-shape bg-shape-3"></div>
    </div>

    <MudContainer MaxWidth="MaxWidth.Small" Class="login-container">
        <MudPaper Elevation="8" Class="login-card">
            @* Logo 区域 *@
            <div class="login-header">
                <div class="logo-wrapper">
                    <MudIcon Icon="@Icons.Material.Filled.PrecisionManufacturing"
                             Size="Size.Large"
                             Class="logo-icon" />
                </div>
                <MudText Typo="Typo.h4" Class="login-title">AGV 调度系统</MudText>
                <MudText Typo="Typo.body2" Class="login-subtitle">海宁市农业科技创新园物流管理平台</MudText>
            </div>

            <MudDivider Class="my-4" />

            @* 登录表单 *@
            <MudForm @ref="_form" @bind-IsValid="_isValid" Class="login-form">
                <MudTextField @bind-Value="_username"
                              Label="用户名"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="请输入用户名"
                              Disabled="_isLoading"
                              OnKeyDown="HandleKeyDown"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Person"
                              Margin="Margin.Dense"
                              Class="login-input" />

                <MudTextField @bind-Value="_password"
                              Label="密码"
                              Variant="Variant.Outlined"
                              InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                              OnAdornmentClick="() => _showPassword = !_showPassword"
                              Required="true"
                              RequiredError="请输入密码"
                              Disabled="_isLoading"
                              OnKeyDown="HandleKeyDown"
                              Margin="Margin.Dense"
                              Class="login-input mt-4" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="@(!_isValid || _isLoading)"
                           OnClick="HandleLogin"
                           Class="login-button mt-6">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Surface" Class="mr-2" />
                        <span>登录中...</span>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Login" Class="mr-2" />
                        <span>登 录</span>
                    }
                </MudButton>
            </MudForm>
        </MudPaper>
    </MudContainer>
</div>

<style>
    .login-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 50%, #01579b 100%);
    }

    .login-background {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        z-index: 0;
    }

    .bg-shape {
        position: absolute;
        border-radius: 50%;
        opacity: 0.1;
        background: white;
    }

    .bg-shape-1 {
        width: 600px;
        height: 600px;
        top: -200px;
        right: -100px;
        animation: float 20s ease-in-out infinite;
    }

    .bg-shape-2 {
        width: 400px;
        height: 400px;
        bottom: -100px;
        left: -100px;
        animation: float 15s ease-in-out infinite reverse;
    }

    .bg-shape-3 {
        width: 300px;
        height: 300px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: pulse 10s ease-in-out infinite;
    }

    @@keyframes float {
        0%, 100% {
            transform: translateY(0) rotate(0deg);
        }
        50% {
            transform: translateY(-30px) rotate(5deg);
        }
    }

    @@keyframes pulse {
        0%, 100% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.1;
        }
        50% {
            transform: translate(-50%, -50%) scale(1.1);
            opacity: 0.05;
        }
    }

    .login-container {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 420px;
        padding: 20px;
    }

    .login-card {
        padding: 40px 32px;
        border-radius: 16px !important;
        background: rgba(255, 255, 255, 0.98) !important;
        backdrop-filter: blur(10px);
    }

    .login-header {
        text-align: center;
        margin-bottom: 8px;
    }

    .logo-wrapper {
        width: 72px;
        height: 72px;
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(25, 118, 210, 0.3);
    }

    .logo-icon {
        color: white !important;
        font-size: 36px !important;
    }

    .login-title {
        font-weight: 600 !important;
        color: #1a237e !important;
        margin-bottom: 4px !important;
    }

    .login-subtitle {
        color: #666 !important;
        letter-spacing: 1px;
    }

    .login-form {
        margin-top: 16px;
    }

    .login-input {
        margin-bottom: 4px;
    }

    .login-input .mud-input-outlined-border {
        border-radius: 10px !important;
    }

    .login-button {
        height: 48px !important;
        border-radius: 10px !important;
        font-size: 16px !important;
        font-weight: 500 !important;
        letter-spacing: 2px;
        text-transform: none !important;
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%) !important;
        box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3) !important;
        transition: all 0.3s ease !important;
    }

    .login-button:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4) !important;
        transform: translateY(-1px);
    }

    .login-button:disabled {
        background: #bdbdbd !important;
        box-shadow: none !important;
    }

    .login-footer {
        margin-top: 32px;
        text-align: center;
    }

    .footer-text {
        color: #9e9e9e !important;
    }

    /* 响应式适配 */
    @@media (max-width: 480px) {
        .login-card {
            padding: 32px 24px;
        }

        .logo-wrapper {
            width: 60px;
            height: 60px;
        }

        .logo-icon {
            font-size: 28px !important;
        }
    }
</style>

@code {
    private MudForm _form = null!;
    private bool _isValid;
    private bool _isLoading;
    private bool _showPassword;

    private string _username = string.Empty;
    private string _password = string.Empty;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && _isValid && !_isLoading)
        {
            await HandleLogin();
        }
    }

    private async Task HandleLogin()
    {
        if (!_isValid || _isLoading) return;

        _isLoading = true;

        try
        {
            var response = await AuthClient.LoginAsync(new LoginRequest
            {
                Username = _username,
                Password = _password
            });

            if (response?.Success == true && response.Data != null)
            {
                await AuthStateService.LoginAsync(response.Data);
                Snackbar.Add($"欢迎回来，{response.Data.User.DisplayName ?? response.Data.User.Username}！", Severity.Success);

                var returnUrl = string.IsNullOrEmpty(ReturnUrl) ? "/" : ReturnUrl;
                Navigation.NavigateTo(returnUrl);
            }
            else
            {
                Snackbar.Add(response?.Message ?? "登录失败", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"登录失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
