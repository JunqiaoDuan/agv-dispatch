<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AgvDispatch.Mobile.ViewModels"
             xmlns:components="using:AgvDispatch.Mobile.Views.Components"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="360" d:DesignHeight="800"
             x:Class="AgvDispatch.Mobile.Views.TaskMonitorView"
             x:DataType="vm:TaskMonitorViewModel">

    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*">
        <!-- 顶部工具栏 -->
        <Border Grid.Row="0" Background="White"
                BoxShadow="0 2 4 0 #10000000"
                Padding="16,12">
            <Grid ColumnDefinitions="*,Auto">
                <!-- 统计信息 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="M19,2H5C3.89,2 3,2.89 3,4V7C3,8.11 3.89,9 5,9H19C20.11,9 21,8.11 21,7V4C21,2.89 20.11,2 19,2M19,16H5C3.89,16 3,16.89 3,18V21C3,22.11 3.89,23 5,23H19C20.11,23 21,22.11 21,21V18C21,16.89 20.11,16 19,16M11,11V13H13V11H11M3,11V13H9V11H3M15,11V13H21V11H15Z"
                                  Foreground="{StaticResource PrimaryBrush}"
                                  Width="20" Height="20"/>
                        <TextBlock Text="AGV:" FontSize="14" Foreground="#757575"/>
                        <TextBlock Text="{Binding TotalAgvCount}" FontSize="14" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"
                                  Foreground="{StaticResource SuccessBrush}"
                                  Width="20" Height="20"/>
                        <TextBlock Text="任务:" FontSize="14" Foreground="#757575"/>
                        <TextBlock Text="{Binding TotalTaskCount}" FontSize="14" FontWeight="Bold" Foreground="{StaticResource SuccessBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- 操作按钮 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding LoadDataCommand}"
                            Width="36" Height="36"
                            Padding="0"
                            CornerRadius="18"
                            Background="Transparent"
                            ToolTip.Tip="刷新">
                        <PathIcon Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                                  Width="20" Height="20"
                                  Foreground="{StaticResource PrimaryBrush}"/>
                    </Button>
                    <Button Command="{Binding OpenSettingsCommand}"
                            Width="36" Height="36"
                            Padding="0"
                            CornerRadius="18"
                            Background="Transparent"
                            ToolTip.Tip="设置">
                        <PathIcon Data="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"
                                  Width="20" Height="20"
                                  Foreground="{StaticResource PrimaryBrush}"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 加载指示器 -->
        <ProgressBar Grid.Row="1" IsIndeterminate="True"
                     IsVisible="{Binding IsLoading}"
                     Foreground="{StaticResource PrimaryBrush}"
                     Height="3"/>

        <!-- 快速操作按钮（简化版：仅上料和下料） -->
        <Border Grid.Row="2" Background="White" Padding="12,8" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,*">
                <Button Grid.Column="0"
                        Command="{Binding OpenCallForLoadingDialogCommand}"
                        HorizontalAlignment="Stretch"
                        CornerRadius="6"
                        Padding="8,6"
                        Background="{StaticResource SuccessBrush}"
                        Foreground="White"
                        Margin="0,0,4,0">
                    <StackPanel Spacing="2">
                        <TextBlock Text="上料" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Grid.Column="1"
                        Command="{Binding OpenSendToUnloadingDialogCommand}"
                        HorizontalAlignment="Stretch"
                        CornerRadius="6"
                        Padding="8,6"
                        Background="{StaticResource InfoBrush}"
                        Foreground="White"
                        Margin="4,0,0,0">
                    <StackPanel Spacing="2">
                        <TextBlock Text="下料" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- 已放行区域显示 -->
        <Border Grid.Row="3" Background="#F5F5F5" Padding="12,8" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1"
                IsVisible="{Binding ActiveChannels.Count}">
            <StackPanel Spacing="6">
                <TextBlock Text="已放行区域" FontSize="12" FontWeight="Bold" Foreground="#424242"/>
                <ItemsControl ItemsSource="{Binding ActiveChannels}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="White"
                                    CornerRadius="4"
                                    Padding="8,4"
                                    Margin="0,2"
                                    BorderBrush="#E0E0E0"
                                    BorderThickness="1">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M10,17L5,12L6.41,10.58L10,14.17L17.59,6.58L19,8M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4Z"
                                              Width="16" Height="16"
                                              Foreground="{StaticResource SuccessBrush}"/>
                                    <TextBlock Text="{Binding ChannelName}"
                                               FontSize="13"
                                               Foreground="#424242"/>
                                    <TextBlock Text="{Binding AgvCount, StringFormat='({0} 辆)'}"
                                               FontSize="12"
                                               Foreground="#757575"/>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>

        <!-- Tab内容区（重构为3个Tab） -->
        <TabControl Grid.Row="4" SelectedIndex="{Binding SelectedTabIndex}" TabStripPlacement="Top">
            <!-- Tab 1: 小车 -->
            <TabItem Header="小车">
                <components:AllAgvTabView DataContext="{Binding}"/>
            </TabItem>

            <!-- Tab 2: 操作 -->
            <TabItem Header="操作">
                <components:OperationsTabView DataContext="{Binding}"/>
            </TabItem>

            <!-- Tab 3: 任务 -->
            <TabItem Header="任务">
                <components:TasksTabView DataContext="{Binding}"/>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
