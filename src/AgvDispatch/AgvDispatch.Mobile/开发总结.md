# AGV调度系统 - 移动端App开发总结

## 开发完成情况

### ✅ 已完成功能

#### 1. 登录页面
- **位置**: `Views/LoginWindow.axaml`
- **功能**:
  - 用户名和密码输入
  - 登录验证(调用API)
  - 错误提示
  - 加载状态显示
  - 美观的UI设计(仿照Web端风格)

#### 2. 主页(小车列表)
- **位置**: `Views/MainWindow.axaml` + `Views/AgvListView.axaml`
- **功能**:
  - 统计卡片显示(小车总数、在线、运行中、故障)
  - 小车列表展示(编号、名称、状态、电量、位置)
  - 数据刷新功能
  - 用户信息显示
  - 退出登录功能

## 技术架构

### 框架选型
- **UI框架**: Avalonia 11.0.10 (跨平台桌面和移动端)
- **MVVM框架**: CommunityToolkit.Mvvm 8.2.2
- **依赖注入**: Microsoft.Extensions.DependencyInjection
- **HTTP通信**: 基于HttpClient的RESTful API调用

### 架构模式: MVVM
```
View (AXAML) <--> ViewModel (C#) <--> Service (API调用)
                      ↓
                   Model (Shared DTOs)
```

### 项目文件结构
```
AgvDispatch.Mobile/
├── Program.cs                      # 入口程序
├── App.axaml                       # 应用资源和主题
├── App.axaml.cs                    # DI容器配置
├── appsettings.json                # 配置文件
├── README.md                       # 项目说明文档
│
├── Services/                       # 服务层
│   ├── IAgvApiService.cs           # AGV API接口
│   ├── AgvApiService.cs            # AGV API实现
│   ├── IAuthService.cs             # 认证服务接口
│   ├── AuthService.cs              # 认证服务实现
│   └── NavigationService.cs        # 页面导航服务
│
├── ViewModels/                     # 视图模型层
│   ├── LoginViewModel.cs           # 登录页ViewModel
│   ├── MainWindowViewModel.cs      # 主窗口ViewModel
│   └── AgvListViewModel.cs         # 小车列表ViewModel
│
└── Views/                          # 视图层
    ├── LoginWindow.axaml           # 登录窗口
    ├── LoginWindow.axaml.cs
    ├── MainWindow.axaml            # 主窗口
    ├── MainWindow.axaml.cs
    ├── AgvListView.axaml           # 小车列表视图
    └── AgvListView.axaml.cs
```

## 核心实现要点

### 1. 依赖注入配置
在 `App.axaml.cs` 中配置服务:
```csharp
private void ConfigureServices(IServiceCollection services)
{
    // HTTP Client
    services.AddHttpClient("AgvApi", client =>
    {
        client.BaseAddress = new Uri("https://localhost:5001/");
    });

    // Services
    services.AddSingleton<IAuthService, AuthService>();
    services.AddSingleton<IAgvApiService, AgvApiService>();
    services.AddSingleton<INavigationService, NavigationService>();

    // ViewModels
    services.AddTransient<LoginViewModel>();
    services.AddTransient<MainWindowViewModel>();
    services.AddTransient<AgvListViewModel>();
}
```

### 2. 认证流程
1. 用户在登录页输入用户名密码
2. `LoginViewModel` 调用 `AuthService.LoginAsync()`
3. `AuthService` 通过HTTP POST调用 `/api/auth/login`
4. 成功后保存Token和用户信息
5. 导航到主窗口

### 3. API调用模式
所有API调用都经过 `AuthService` 自动添加JWT Token:
```csharp
private HttpClient GetHttpClient()
{
    var client = _httpClientFactory.CreateClient("AgvApi");
    var token = _authService.GetToken();
    if (!string.IsNullOrEmpty(token))
    {
        client.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", token);
    }
    return client;
}
```

### 4. 数据绑定
使用 `CommunityToolkit.Mvvm` 的特性简化代码:
```csharp
[ObservableProperty]
private string _username = string.Empty;

[RelayCommand]
private async Task LoginAsync() { ... }
```

## UI设计风格

### 配色方案
- 主色调: `#1976d2` (蓝色)
- 辅助色: `#1565c0` (深蓝)
- 成功色: `#4caf50` (绿色)
- 警告色: `#ff9800` (橙色)
- 错误色: `#f44336` (红色)

### 设计特点
- 圆角卡片设计
- 阴影效果
- 响应式布局
- 图标 + 文字组合
- 与Web端视觉风格保持一致

## 运行和测试

### 开发环境运行
```bash
cd src/AgvDispatch/AgvDispatch.Mobile
dotnet restore
dotnet build
dotnet run
```

### Android打包
```bash
dotnet publish -f net8.0-android -c Release
```

## 配置说明

### 修改API地址
编辑 `App.axaml.cs` 第48行:
```csharp
client.BaseAddress = new Uri("https://your-server-url/");
```

或修改 `appsettings.json`:
```json
{
  "ApiSettings": {
    "BaseUrl": "https://your-server-url"
  }
}
```

## 后续扩展建议

### 第二阶段功能
1. **任务管理**
   - 任务列表查询
   - 创建新任务
   - 任务详情查看

2. **小车控制**
   - 暂停/继续按钮
   - 急停功能
   - 发送到充电站

3. **实时更新**
   - 定时轮询(每2秒)
   - 状态自动刷新

4. **异常通知**
   - 异常列表
   - 推送通知(移动端)

### 技术优化
1. **离线支持**: 使用SQLite缓存数据
2. **图片资源**: 添加应用图标和启动画面
3. **国际化**: 支持多语言
4. **主题切换**: 支持深色模式
5. **性能优化**: 虚拟化长列表

## 参考资料

### 项目相关
- 架构设计文档: `docs/方案-架构设计.md`
- Web端代码: `src/AgvDispatch/AgvDispatch.Web`
- Shared项目: `src/AgvDispatch/AgvDispatch.Shared`

### 技术文档
- [Avalonia UI官方文档](https://docs.avaloniaui.net/)
- [CommunityToolkit.Mvvm文档](https://learn.microsoft.com/zh-cn/dotnet/communitytoolkit/mvvm/)
- [Avalonia Android支持](https://docs.avaloniaui.net/docs/deployment/android)

## 常见问题

### Q: 如何调试移动端?
A: 使用桌面模式运行(`dotnet run`)可以快速调试，无需Android模拟器。

### Q: 如何添加新页面?
A:
1. 在 `Views/` 创建 `.axaml` 和 `.axaml.cs`
2. 在 `ViewModels/` 创建对应ViewModel
3. 在 `App.axaml.cs` 注册到DI容器
4. 使用 `NavigationService` 导航

### Q: 如何调用新的API?
A: 在 `AgvApiService.cs` 添加新方法，参考现有的 `GetAllAgvsAsync()` 实现。

### Q: 编译报错怎么办?
A: 确保已安装 .NET 8.0 SDK，执行 `dotnet restore` 重新还原包。

## 开发者备注

### 已知问题
- 暂无

### 待办事项
- [ ] 添加任务管理功能
- [ ] 实现小车控制(暂停/继续)
- [ ] 添加实时数据刷新
- [ ] 优化UI响应性
- [ ] 添加单元测试

---

**开发时间**: 2026-01-20
**开发人员**: AI Assistant
**项目状态**: ✅ 第一阶段完成，可运行测试
