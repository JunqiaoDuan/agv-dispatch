# 地图模拟功能实现方案

## 一、功能概览

### 核心目标
在 map-studio 页面增加【模拟】功能，允许用户选择起点、终点和速度，模拟 AGV 沿最短路径移动，验证地图连通性和路径算法正确性。

### 关键价值
- ✅ **地图验证**: 快速验证地图连通性和路径可达性
- ✅ **算法测试**: 测试 A* 路径计算和插值算法
- ✅ **运行时复用**: 核心组件可直接用于实际调度系统
- ✅ **用户体验**: 小地图总览 + 视图跟踪，便于观察全局和细节

### 预期成果
用户可以从 map-studio 点击"模拟"按钮，在独立页面中：
- 选择起点/终点（支持节点或站点）并设置速度
- 观看小车沿最短路径运动的动画
- 使用小地图总览全局，点击快速跳转视图
- 启用视图跟踪功能（固定/跟踪小车/跟踪站点）
- 查看实时统计（进度、距离、时长）

---

## 二、核心设计

### 技术架构
```
┌─────────────────────────────────────────────┐
│  Web 层 (UI)                                │
│  - MapSimulation.razor (主页面)             │
│  - MiniMap.razor (小地图组件)               │
│  - ViewTracker.razor (视图跟踪组件)         │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────┴───────────────────────────┐
│  Shared 层 (核心逻辑 - 运行时可复用)        │
│  ┌─────────────────────────────────────┐   │
│  │ PathFinding 路径查找                │   │
│  │  - AStarPathfinder (A*算法)         │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ Simulation 模拟引擎                 │   │
│  │  - AgvSimulator (模拟器)            │   │
│  │  - PathInterpolator (路径插值)      │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ Rendering 渲染                      │   │
│  │  - SimulationRenderer (SVG生成)     │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### 关键设计决策

| 方面 | 决策 | 理由 |
|------|------|------|
| **路径算法** | A* 寻路算法 | 最优路径，性能好 |
| **代码架构** | 核心逻辑在 Shared 层 | 运行时可复用 |
| **动画实现** | 独立 SVG 层叠加 | 不影响地图渲染，易于控制 |
| **UI 布局** | 独立页面 `/map-simulation/{MapId}` | 便于扩展为运行时监控界面 |
| **视图增强** | 小地图 + 视图跟踪 | 兼顾全局总览和细节观察 |

---

## 三、组件职责

### 核心算法层 (Shared)

#### 1. 路径查找模块
**AStarPathfinder** - A* 寻路算法
- 输入: 起点/终点 ID（可以是节点或站点）
- 输出: PathfindingResult（节点路径、边路径、总距离）
- 核心方法: `FindPath()`, `CalculateHeuristic()`
- 技术要点: 优先队列、欧几里得距离启发式、支持双向边和单向边

#### 2. 模拟引擎模块
**AgvSimulator** - 模拟生命周期管理
- 状态机: NotStarted → Running → Paused/Completed/Failed
- 时间步进: 每 50ms 更新一次位置
- 事件通知: OnPositionUpdated, OnCompleted, OnFailed
- 核心方法: `Start()`, `Update()`, `Pause()`, `Resume()`, `Stop()`

**PathInterpolator** - 路径插值计算
- 支持三种边类型: 直线、折线、贝塞尔曲线
- 输出: 位置 (x, y) + 朝向角度
- 核心方法: `Interpolate(edge, nodes, progress)`

#### 3. 渲染模块
**SimulationRenderer** - 独立 SVG 层生成
- 渲染内容: 起点标记、终点标记、已走路径、到终点直线、AGV 图标
- 叠加方式: `position: absolute` 覆盖在地图之上
- 核心方法: `Render(agvPosition, path, viewParams)`

### UI 层 (Web)

#### 1. MapSimulation.razor - 主模拟页面
- 路由: `/map-simulation/{MapId:guid}`
- 布局: 全屏沉浸式（顶部工具栏 + 主画布 + 右侧状态面板）
- 功能: 起点/终点选择、速度设置、控制按钮、统计信息

#### 2. MiniMap.razor - 小地图组件
- 位置: 左上角固定浮动
- 功能: 缩小版地图、视口矩形框、小车标记、点击跳转
- 尺寸: 200x150px

#### 3. ViewTracker.razor - 视图跟踪组件
- 位置: 左上角（小地图下方）
- 模式: 固定位置 / 跟踪小车 / 跟踪站点
- 功能: 镜头自动跟随或锁定目标

---

## 四、实施计划

### 实现阶段

**阶段 1: 核心算法层** (优先级: 高)
1. 创建 PathFinding 模块
   - `PathfindingResult.cs` - 路径结果数据模型
   - `AStarPathfinder.cs` - A* 算法实现
2. 创建 Simulation 模块
   - `SimulationState.cs`, `AgvPosition.cs`, `AgvSimulationConfig.cs` - 数据模型
   - `PathInterpolator.cs` - 路径插值逻辑
   - `AgvSimulator.cs` - 模拟引擎主逻辑

**阶段 2: 渲染层** (优先级: 高)
1. 扩展渲染数据模型
   - 修改 `MapRenderData.cs` - 添加 SimulatedAgvs 属性
   - 修改 `MapRenderOptions.cs` - 添加模拟渲染配置
2. 创建 `SimulationRenderer.cs` - SVG 层生成逻辑

**阶段 3: 基础 UI** (优先级: 高)
1. 创建 `MapSimulation.razor` - 主页面（不含小地图和跟踪）
2. 实现基本控制面板（起点/终点/速度/控制按钮）
3. 修改 `MapStudio.razor` - 添加"模拟"跳转按钮

**阶段 4: 增强功能** (优先级: 中)
1. 创建 `MiniMap.razor` - 小地图组件
2. 创建 `ViewTracker.razor` - 视图跟踪组件
3. 集成到 MapSimulation 页面

**阶段 5: 优化与扩展** (优先级: 低)
1. 路径计算优化（搜索超时、节点数限制）
2. 动画平滑优化（角度插值、极短边处理）
3. 边界情况处理（起点=终点、无效输入）
4. 运行时模式扩展（SignalR 实时数据）

---

## 五、关键文件清单

### 新增文件 (11 个)

**Shared 层** (共享逻辑 - 运行时可复用)
- `AgvDispatch.Shared/PathFinding/PathfindingResult.cs`
- `AgvDispatch.Shared/PathFinding/AStarPathfinder.cs`
- `AgvDispatch.Shared/Simulation/SimulationState.cs`
- `AgvDispatch.Shared/Simulation/AgvPosition.cs`
- `AgvDispatch.Shared/Simulation/AgvSimulationConfig.cs`
- `AgvDispatch.Shared/Simulation/PathInterpolator.cs`
- `AgvDispatch.Shared/Simulation/AgvSimulator.cs`
- `AgvDispatch.Shared/Rendering/SimulationRenderer.cs`

**Web 层** (UI 组件)
- `AgvDispatch.Web/Components/Pages/Maps/MapSimulation.razor` - 主模拟页面
- `AgvDispatch.Web/Components/Pages/Maps/MiniMap.razor` - 小地图组件
- `AgvDispatch.Web/Components/Pages/Maps/ViewTracker.razor` - 视图跟踪组件

### 修改文件 (3 个)
- `AgvDispatch.Shared/Rendering/MapRenderData.cs` - 添加 SimulatedAgvs 属性
- `AgvDispatch.Shared/Rendering/MapRenderOptions.cs` - 添加模拟渲染配置
- `AgvDispatch.Web/Components/Pages/Maps/MapStudio.razor` - 添加"模拟"跳转按钮

---

## 六、关键技术说明

### A* 算法核心逻辑
- 使用优先队列维护待探索节点（按 FCost 排序）
- FCost = GCost（实际代价）+ HCost（启发式估计）
- 启发函数采用欧几里得距离
- 支持站点自动解析为关联节点

### 路径插值技术
支持三种边类型的插值：
- **直线 (Line)**: 线性插值 `P = P0 + t(P1 - P0)`
- **折线 (Arc)**: 通过中间点的分段线性插值
- **贝塞尔曲线 (ArcWithCurvature)**: 二次贝塞尔曲线插值
  - 位置: `P(t) = (1-t)²P0 + 2(1-t)tP1 + t²P2`
  - 角度: 根据切线向量计算 `atan2(dy/dt, dx/dt)`

### 时间步进机制
```
每帧更新 (50ms):
  距离增量 = deltaTime × speed
  总进度 = 已行驶距离 / 总距离
  → 映射到当前边索引和边内进度
  → 插值计算位置和角度
  → 触发 OnPositionUpdated 事件
```

### SVG 叠加渲染
- 底层 SVG: 地图（节点、边、站点）
- 顶层 SVG: 模拟动画（小车、路径、标记）
- 使用相同的 transform 参数确保坐标一致
- 顶层设置 `pointer-events: none` 避免拦截交互

### 小地图实现要点
- 缩放比例: `min(200/mapWidth, 150/mapHeight) × 0.9`
- 视口矩形: 主画布视口转换到小地图坐标系
- 点击跳转: 小地图坐标 → 地图坐标 → 更新主画布偏移

### 视图跟踪实现要点
- 跟踪小车: 平滑插值移动 `offset += (target - offset) × smoothFactor`
- 跟踪站点: 直接设置 `offset = target`（无平滑）
- 定时器: 20 FPS (50ms/帧) 更新视图位置

---

## 七、运行时可复用性

### 可复用组件 (Shared 层)
- ✅ **AStarPathfinder**: 任务分配时的路径规划
- ✅ **PathInterpolator**: 碰撞检测、轨迹预测
- ✅ **AgvSimulator**: 数字孪生、离线模拟

### 扩展方式: 运行时监控界面
通过添加路由 `/map-runtime/{MapId}` 复用同一页面：

| 特性 | 模拟模式 | 运行时模式 |
|------|---------|-----------|
| 数据源 | 本地 AgvSimulator | SignalR 实时推送 |
| 小车数量 | 单个模拟小车 | 多个真实小车 |
| 控制面板 | 起点/终点/速度选择 | 任务列表、小车状态 |
| 路径显示 | 单条计算路径 | 多条任务路径 |

---

## 八、实施顺序建议

1. **阶段 1-2**: 核心算法 + 渲染层（可独立测试，优先完成）
2. **阶段 3**: 基础 UI（实现核心模拟功能，验证可用性）
3. **阶段 4**: 增强功能（小地图 + 视图跟踪，提升用户体验）
4. **阶段 5**: 优化与扩展（边界情况处理、运行时模式）

每个阶段完成后进行测试，确保质量后再进入下一阶段。
