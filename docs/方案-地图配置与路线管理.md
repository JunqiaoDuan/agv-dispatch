# 地图配置与路线管理实现方案

> 版本: v1.1
> 日期: 2026-01-11
> 状态: MVP 阶段
> 更新: UI重构 - 整合地图编辑与路线管理

---

## 一、模块概述

### 1.1 功能范围

| 模块 | 功能 | 说明 |
|------|------|------|
| 地图管理 | 地图的 CRUD | 管理基础地图信息 |
| 节点管理 | 地图节点的 CRUD | 在地图上定义坐标点 |
| 边管理 | 地图边的 CRUD | 定义节点之间的连线 |
| 路线管理 | 路线的 CRUD | 定义小车行驶的路径 |

### 1.2 现有实体结构

项目已定义以下实体（`AgvDispatch.Business/Entities/`）：

```
MapAggregate/
├── Map.cs          # 地图（MapCode, DisplayName, Width, Height, IsActive）
├── MapNode.cs      # 节点（MapId, NodeCode, DisplayName, X, Y）
└── MapEdge.cs      # 边（MapId, EdgeCode, StartNodeId, EndNodeId, EdgeType, IsBidirectional）

RouteAggregate/
├── Route.cs        # 路线（MapId, RouteCode, DisplayName, IsActive）
└── RouteSegment.cs # 路线段（RouteId, EdgeId, Seq, Direction, Action, WaitTime）

StationAggregate/
└── Station.cs      # 站点（MapId, NodeId, StationCode, DisplayName, StationType）
```

### 1.3 设计原则

- **SVG 跨平台绘图**：Blazor Web 和 Avalonia App 共用同一套 SVG 生成逻辑
- **三层渲染架构**：静态地图层、路径高亮层、动态层分离，优化性能
- **简单交互**：点击添加节点、点击两点连边，不做复杂拖拽
- **复用画布**：地图编辑、路线预览、调度监控共用同一个画布组件

---

## 二、地图管理模块

### 2.1 API 设计

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/maps` | 获取所有地图列表 | User |
| GET | `/api/maps/{id}` | 获取地图详情（含节点、边） | User |
| POST | `/api/maps` | 创建地图 | Admin |
| PUT | `/api/maps/{id}` | 更新地图 | Admin |
| DELETE | `/api/maps/{id}` | 删除地图（软删除） | Admin |
| GET | `/api/maps/next-code` | 获取下一个地图编号 | User |

**节点相关：**

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/maps/{mapId}/nodes` | 获取地图的所有节点 | User |
| POST | `/api/maps/{mapId}/nodes` | 创建节点 | Admin |
| PUT | `/api/maps/{mapId}/nodes/{id}` | 更新节点 | Admin |
| DELETE | `/api/maps/{mapId}/nodes/{id}` | 删除节点 | Admin |

**边相关：**

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/maps/{mapId}/edges` | 获取地图的所有边 | User |
| POST | `/api/maps/{mapId}/edges` | 创建边 | Admin |
| PUT | `/api/maps/{mapId}/edges/{id}` | 更新边 | Admin |
| DELETE | `/api/maps/{mapId}/edges/{id}` | 删除边 | Admin |

### 2.2 DTO 设计

```
DTOs/Maps/
├── MapListItemDto.cs      # 地图列表项
├── MapDetailDto.cs        # 地图详情（含节点、边数量统计）
├── CreateMapRequest.cs    # 创建请求
├── UpdateMapRequest.cs    # 更新请求

DTOs/MapNodes/
├── MapNodeListItemDto.cs  # 节点列表项
├── CreateMapNodeRequest.cs
├── UpdateMapNodeRequest.cs

DTOs/MapEdges/
├── MapEdgeListItemDto.cs  # 边列表项（包含起点终点名称）
├── CreateMapEdgeRequest.cs
├── UpdateMapEdgeRequest.cs
```

### 2.3 页面设计（UI重构版）

#### 菜单结构简化

原有菜单结构将地图管理、路线管理、站点管理分散在不同菜单中，增加了操作复杂度。重构后：

| 变更 | 说明 |
|------|------|
| 去掉 | "路线管理" 菜单项 |
| 去掉 | "站点管理" 菜单项 |
| 保留 | "地图管理" 菜单项 |

#### 页面 `/maps` - 地图列表

```
┌─────────────────────────────────────────────────────────────┐
│ 地图管理                                    [+ 新增地图]    │
├─────────────────────────────────────────────────────────────┤
│ [搜索框]                                                     │
├─────────────────────────────────────────────────────────────┤
│ 编号    名称       尺寸(cm)      节点数   边数   状态   操作 │
│ M001    主车间     10000x8000    12       15     启用   [编辑][删除] │
│ M002    仓库       5000x4000     8        10     启用   [编辑][删除] │
└─────────────────────────────────────────────────────────────┘
```

点击 **[编辑]** 按钮：`window.open('/map-studio/{mapId}')` 在新浏览器Tab中打开编辑器。

#### 页面 `/map-studio/{id}` - 地图工作室（全屏编辑器）

**核心设计原则：**
- 独立页面，无系统外壳（无顶部导航栏、无侧边菜单）
- 最大化画布空间，尤其是垂直方向
- 三栏可收起布局

**整体布局：**

```
┌──────────────────────────────────────────────────────────────────────┐
│ [≡] 选择 添加节点 添加边   [地图编辑|路线管理]   M001主车间  [保存] [≡] │ ← 精简顶栏
├────────┬─────────────────────────────────────────────────┬───────────┤
│        │                                                 │           │
│ 左面板 │                                                 │  右面板   │
│        │                                                 │           │
│ 节点   │              SVG 画布                           │ 属性编辑  │
│ 列表   │              (最大化)                           │           │
│        │                                                 │ 名称: xxx │
│ 边     │                                                 │ X: 100    │
│ 列表   │                                                 │ Y: 200    │
│        │                                                 │           │
│ [收起] │                                                 │ [收起]    │
└────────┴─────────────────────────────────────────────────┴───────────┘
  ↑ 可收起                                                    ↑ 可收起
```

**左面板内容（随Tab切换）：**

| Tab | 左面板内容 |
|-----|-----------|
| 地图编辑 | 节点列表、边列表 |
| 路线管理 | 路线列表、当前路线的段列表 |

**右面板内容：**
- 显示当前选中元素的属性编辑器
- 地图编辑Tab：节点属性 / 边属性
- 路线管理Tab：路线属性 / 段属性

**Tab切换行为：**
- 切换到"路线管理"时，画布显示同一张地图
- 交互模式变为路线编辑（点击边添加到路线）
- 已选路线的边高亮显示

**交互说明：**

| 操作 | 交互方式 |
|------|----------|
| 添加节点 | 选择"添加节点"工具 → 点击画布 → 弹出节点信息填写框 |
| 添加边 | 选择"添加边"工具 → 依次点击起点和终点节点 → 弹出边信息填写框 |
| 选中元素 | 选择"选择"工具 → 点击节点或边 → 右侧属性面板显示详情 |
| 移动节点 | 选中节点后，在属性面板修改坐标，或直接拖拽节点（可选） |
| 删除元素 | 选中元素 → 点击"删除"按钮，或按 Delete 键 |
| 画布缩放 | 点击 +/- 按钮，或滚轮缩放 |
| 画布平移 | 按住空格拖拽，或使用滚动条 |
| 收起面板 | 点击左/右面板的收起按钮，最大化画布区域 |

### 2.4 实现步骤

1. **Shared 层**：创建 DTOs
2. **Business 层**：创建 Specification（查询规范）
3. **Infrastructure 层**：配置 EF 实体映射
4. **Host 层**：创建 `MapsController`
5. **Web 层**：
   - 创建 `IMapClient` 接口和 `MapClient` 实现
   - 创建 `MapList.razor` 页面
   - 创建 `MapDetail.razor` 页面（含选项卡）
   - 创建 `MapEditDialog.razor`、`NodeEditDialog.razor`、`EdgeEditDialog.razor`

---

## 三、路线管理模块

### 3.1 API 设计

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/routes` | 获取所有路线列表 | User |
| GET | `/api/routes?mapId={mapId}` | 按地图筛选路线 | User |
| GET | `/api/routes/{id}` | 获取路线详情（含段落） | User |
| POST | `/api/routes` | 创建路线 | Admin |
| PUT | `/api/routes/{id}` | 更新路线 | Admin |
| DELETE | `/api/routes/{id}` | 删除路线（软删除） | Admin |
| GET | `/api/routes/next-code` | 获取下一个路线编号 | User |

**路线段相关（嵌套在路线内管理）：**

创建/更新路线时，通过请求体一次性提交所有段落，而非单独的段落 CRUD。

### 3.2 DTO 设计

```
DTOs/Routes/
├── RouteListItemDto.cs       # 路线列表项
│   - Id, RouteCode, DisplayName, MapId, MapName, SegmentCount, IsActive
│
├── RouteDetailDto.cs         # 路线详情
│   - 含 Segments 列表
│
├── RouteSegmentDto.cs        # 路线段
│   - EdgeId, EdgeCode, StartNodeName, EndNodeName, Seq, Direction, Action, WaitTime
│
├── CreateRouteRequest.cs     # 创建请求
│   - MapId, RouteCode, DisplayName, Description, Segments[]
│
├── UpdateRouteRequest.cs     # 更新请求
│   - DisplayName, Description, IsActive, Segments[]
│
└── RouteSegmentRequest.cs    # 路线段请求
    - EdgeId, Seq, Direction, Action, WaitTime
```

### 3.3 页面设计（整合到地图工作室）

路线管理功能已整合到 `/map-studio/{id}` 页面的"路线管理"Tab中，不再作为独立页面。

**路线管理Tab界面：**

```
┌──────────────────────────────────────────────────────────────────────┐
│ [≡] 选择              [地图编辑|路线管理]   M001主车间  [保存] [≡]   │
├────────┬─────────────────────────────────────────────────┬───────────┤
│        │                                                 │           │
│ 路线   │      ①●═══════●②                               │ 路线属性  │
│ 列表   │              ║                                 │           │
│ ─────  │              ║                                 │ 名称: xxx │
│ R001 ✓ │              ▼                                 │ 启用: ✓   │
│ R002   │      ④●──────●③                                │           │
│ R003   │                                                 │ ─────     │
│        │  ══ 选中路线路径（高亮）                        │ 段属性    │
│ [+新建]│  ── 其他边（灰色）                              │           │
│        │  ● 节点   ①②③ 路线顺序                         │ 方向: 正向│
│ ─────  │                                                 │ 动作: 装货│
│ 路线段 │  💡 点击边添加到路线                             │ 等待: 5s  │
│ ─────  │                                                 │           │
│ 1.E001 │                                                 │           │
│ 2.E002 │                                                 │           │
│ 3.E003 │                                                 │           │
│        │                                                 │           │
└────────┴─────────────────────────────────────────────────┴───────────┘
```

**左面板内容：**
- 上半部分：当前地图的路线列表，可选中/新建
- 下半部分：选中路线的段列表，支持上移/下移/删除

**右面板内容：**
- 上半部分：选中路线的基本属性
- 下半部分：选中段的属性（方向、动作、等待时间）

**路线编辑交互：**

| 操作 | 交互方式 |
|------|----------|
| 新建路线 | 点击左面板"新建"按钮 → 弹出基本信息填写框 |
| 选中路线 | 点击左面板路线列表项 → 画布高亮显示该路线 |
| 添加路线段 | 点击画布上的边 → 自动添加到路线段列表末尾 |
| 调整段顺序 | 拖拽段落上下移动，或点击 ↑↓ 按钮 |
| 编辑段属性 | 点击段落 → 右面板显示段属性编辑 |
| 删除段落 | 点击段落右侧的 × 按钮 |
| 删除路线 | 在路线列表中右键/长按 → 删除选项 |

### 3.4 实现步骤

1. **Shared 层**：创建 DTOs
2. **Business 层**：创建 Specification
3. **Infrastructure 层**：配置 EF 实体映射
4. **Host 层**：创建 `RoutesController`
5. **Web 层**：
   - 创建 `IRouteClient` 接口和 `RouteClient` 实现
   - 创建 `RouteList.razor` 页面
   - 创建 `RouteEditDialog.razor`（含段落编辑）

---

## 四、数据库迁移

### 4.1 新增表

需要在 `AgvDispatchContext` 中配置以下实体映射：

```csharp
// DbSets
public DbSet<Map> Maps => Set<Map>();
public DbSet<MapNode> MapNodes => Set<MapNode>();
public DbSet<MapEdge> MapEdges => Set<MapEdge>();
public DbSet<Route> Routes => Set<Route>();
public DbSet<RouteSegment> RouteSegments => Set<RouteSegment>();
public DbSet<Station> Stations => Set<Station>();
```

### 4.2 索引建议

```sql
-- 节点
CREATE INDEX idx_map_nodes_map_id ON map_nodes(map_id);

-- 边
CREATE INDEX idx_map_edges_map_id ON map_edges(map_id);
CREATE INDEX idx_map_edges_start_node ON map_edges(start_node_id);
CREATE INDEX idx_map_edges_end_node ON map_edges(end_node_id);

-- 路线
CREATE INDEX idx_routes_map_id ON routes(map_id);

-- 路线段
CREATE INDEX idx_route_segments_route_id ON route_segments(route_id);
CREATE INDEX idx_route_segments_edge_id ON route_segments(edge_id);

-- 站点
CREATE INDEX idx_stations_map_id ON stations(map_id);
CREATE INDEX idx_stations_node_id ON stations(node_id);
```

---

## 五、文件清单

### 5.1 Shared 层新增文件

```
AgvDispatch.Shared/
├── DTOs/
│   ├── Maps/
│   │   ├── MapListItemDto.cs
│   │   ├── MapDetailDto.cs
│   │   ├── CreateMapRequest.cs
│   │   └── UpdateMapRequest.cs
│   ├── MapNodes/
│   │   ├── MapNodeListItemDto.cs
│   │   ├── CreateMapNodeRequest.cs
│   │   └── UpdateMapNodeRequest.cs
│   ├── MapEdges/
│   │   ├── MapEdgeListItemDto.cs
│   │   ├── CreateMapEdgeRequest.cs
│   │   └── UpdateMapEdgeRequest.cs
│   └── Routes/
│       ├── RouteListItemDto.cs
│       ├── RouteDetailDto.cs
│       ├── RouteSegmentDto.cs
│       ├── CreateRouteRequest.cs
│       ├── UpdateRouteRequest.cs
│       └── RouteSegmentRequest.cs
└── Rendering/                          # SVG 渲染逻辑（跨平台共享）
    ├── SvgMapRenderer.cs               # 静态地图层 SVG 生成
    ├── SvgAgvRenderer.cs               # 动态层 SVG 生成（小车+目标线+高亮路径）
    ├── MapRenderData.cs                # 渲染数据模型
    ├── AgvRenderData.cs                # 小车渲染数据
    ├── MapRenderOptions.cs             # 渲染配置
    └── HitTestHelper.cs                # 点击检测
```

### 5.2 Business 层新增文件

```
AgvDispatch.Business/Specifications/
├── Maps/
│   ├── MapListSpec.cs
│   ├── MapByIdSpec.cs
│   ├── MapCodeExistsSpec.cs
│   └── MapMaxCodeSpec.cs
├── MapNodes/
│   ├── MapNodeListSpec.cs
│   ├── MapNodeByIdSpec.cs
│   └── MapNodeCodeExistsSpec.cs
├── MapEdges/
│   ├── MapEdgeListSpec.cs
│   ├── MapEdgeByIdSpec.cs
│   └── MapEdgeCodeExistsSpec.cs
└── Routes/
    ├── RouteListSpec.cs
    ├── RouteByIdSpec.cs
    ├── RouteCodeExistsSpec.cs
    └── RouteMaxCodeSpec.cs
```

### 5.3 Host 层新增文件

```
AgvDispatch.Host/Controllers/
├── MapsController.cs
└── RoutesController.cs
```

### 5.4 Web 层新增文件

```
AgvDispatch.Web/
├── Services/
│   ├── IMapClient.cs
│   ├── MapClient.cs
│   ├── IRouteClient.cs
│   └── RouteClient.cs
└── Components/
    ├── Layout/
    │   └── EmptyLayout.razor            # 空白布局（无导航栏、无侧边菜单）
    └── Pages/
        └── Maps/
            ├── MapList.razor             # 地图列表页
            ├── MapStudio.razor           # 地图工作室（全屏编辑器，整合地图编辑+路线管理）
            ├── MapEditDialog.razor       # 地图基本信息弹窗
            ├── NodeEditDialog.razor      # 节点编辑弹窗
            ├── EdgeEditDialog.razor      # 边编辑弹窗
            └── RouteEditDialog.razor     # 路线编辑弹窗（复用）
```

**废弃文件（UI重构后不再使用）：**

```
Components/Pages/Routes/
├── RouteList.razor           # 已废弃 → 功能整合到 MapStudio
├── RouteEditor.razor         # 已废弃 → 功能整合到 MapStudio
└── EdgeSelectDialog.razor    # 已废弃 → 改为画布点击选择
```

---

## 六、实现顺序建议

### 第一步：SVG 渲染器 + 画布组件
1. Shared 层：创建 SvgMapRenderer、MapRenderData、MapRenderOptions
2. Shared 层：实现节点/边/网格的 SVG 生成逻辑
3. Shared 层：实现 HitTestHelper 点击检测

### 第二步：地图基础 CRUD + 画布集成
1. Shared: Map/MapNode/MapEdge DTOs
2. Business: Specifications
3. Infrastructure: 实体映射
4. Host: MapsController（地图+节点+边 CRUD）
5. Web: MapClient + MapList.razor

### 第三步：地图工作室（UI重构核心）
1. 创建 EmptyLayout.razor（空白布局）
2. 创建 MapStudio.razor 页面骨架，指定使用空白布局
3. 实现三栏可收起布局（左面板 | 画布 | 右面板）
4. 实现顶部精简工具栏 + Tab切换
5. 迁移地图编辑功能（节点/边的增删改交互）
6. 修改 MapList.razor 的编辑按钮为 window.open()

### 第四步：路线管理整合
1. 实现路线管理Tab的左面板（路线列表 + 段列表）
2. 画布交互：点击边添加到路线段
3. 右面板：路线属性 + 段属性编辑
4. 路线段的增删改、排序

### 第五步：菜单简化 + 清理
1. 修改 NavMenu.razor，去掉路线管理、站点管理菜单
2. 删除或废弃 Routes/RouteList.razor、RouteEditor.razor

---

## 七、注意事项

### 7.1 删除约束

- **删除地图前**：检查是否有关联的路线，有则提示用户先删除路线
- **删除节点前**：检查是否有关联的边或站点，有则提示
- **删除边前**：检查是否有路线段引用此边，有则提示

### 7.2 编号自动生成规则

| 实体 | 前缀 | 示例 |
|------|------|------|
| 地图 | M | M001, M002 |
| 节点 | N | N001, N002 |
| 边 | E | E001, E002 |
| 路线 | R | R001, R002 |

### 7.3 边的距离计算

- **直线**：两点间欧几里得距离
- **弧线**：需要提供弧线经过点，计算两段直线距离之和（简化处理）

公式（直线）：
```
distance = sqrt((x2-x1)^2 + (y2-y1)^2)
```

可在后端创建边时自动计算，或前端输入时计算后提交。

### 7.4 软删除

所有实体的删除操作统一使用软删除（设置 `IsDeleted = true`），保留历史数据。

---

## 八、画布组件设计（SVG 分层渲染方案）

### 8.1 技术选型

| 方案 | Blazor Server | Avalonia | 代码复用 | 推荐 |
|------|---------------|----------|----------|------|
| SkiaSharp | 不支持 Server 模式 | 内置支持 | ✅ | ❌ |
| Canvas + JS | 需 JS Interop | 不适用 | ❌ | |
| **SVG 统一** | 原生支持 | Avalonia.Svg.Skia | ✅ SVG 生成逻辑共享 | ✅ |

**选择 SVG 的原因：**
- Blazor Server 原生支持 SVG，无需额外依赖
- Avalonia 通过 `Avalonia.Svg.Skia` 支持 SVG 渲染
- SVG 生成逻辑放在 Shared 层，实现代码复用
- 矢量图形，缩放不失真，可直接导出

### 8.2 三层渲染架构

针对实时监控场景的性能优化，将画布分为三个独立渲染层：

```
┌─────────────────────────────────────────────────────────────┐
│                      画布容器                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Layer 1: 静态地图层 (SVG)                             │  │
│  │  - 网格背景、节点、边、站点标签                         │  │
│  │  - 更新频率：仅在编辑/切换地图时                        │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Layer 2: 路径高亮层 (SVG)                             │  │
│  │  - 小车规划路径（高亮显示经过的边）                      │  │
│  │  - 路线编辑时的选中路线                                 │  │
│  │  - 更新频率：任务/路线变化时（低频）                     │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Layer 3: 动态层 (SVG)                                 │  │
│  │  - 小车图标（位置、方向、状态颜色）                      │  │
│  │  - 目标线（当前位置→目标位置的虚线）                     │  │
│  │  - 目标点标记                                          │  │
│  │  - 更新频率：100ms-1s（高频）                           │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**分层优势：**
- 静态层不随小车位置更新而重绘，减少 DOM 操作
- 路径层仅在任务变化时更新，避免不必要计算
- 动态层独立更新，高频刷新不影响其他层性能

### 8.3 实时监控效果示意

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│      ●N001 ─────────────── ●N002                            │
│       │                      ╲                              │
│       │     ▲ AGV-01          ╲                             │
│       │     ┊（行驶中）         ●N003 ← 目标点               │
│       │     ┊╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌◎                             │
│       │         目标线（虚线）                               │
│       │                                                     │
│      ●N004 ═════════════ ●N005   ← 规划路径（高亮）          │
│                 ■ AGV-02                                    │
│                （空闲）                                      │
│                                                             │
│  图例: ▲行驶中  ■空闲  ●充电  ◆故障  ╌╌目标线  ══规划路径   │
└─────────────────────────────────────────────────────────────┘
```

### 8.4 架构设计

```
AgvDispatch.Shared/
└── Rendering/
    ├── SvgMapRenderer.cs           # 生成静态地图层 SVG
    ├── SvgAgvRenderer.cs           # 生成动态层 SVG（小车+目标线+路径高亮）
    ├── MapRenderData.cs            # 地图渲染数据（节点、边集合）
    ├── AgvRenderData.cs            # 小车渲染数据（位置、目标、状态、规划路径）
    ├── MapRenderOptions.cs         # 渲染配置（颜色、尺寸、样式）
    └── HitTestHelper.cs            # 点击检测逻辑

AgvDispatch.Web/
└── Components/Shared/MapCanvas/
    ├── MapCanvas.razor             # 地图编辑画布（静态层+交互）
    └── MonitorCanvas.razor         # 监控画布（三层完整实现）

AgvDispatch.Mobile/
└── Controls/
    └── MapCanvasControl.cs         # Avalonia 封装，使用 Avalonia.Svg.Skia 渲染
```

### 8.5 渲染器职责

**SvgMapRenderer（静态层）：**

| 功能 | 说明 |
|------|------|
| 绘制背景网格 | SVG pattern 实现 |
| 绘制节点 | circle + text 标签 |
| 绘制边 | line（直线）/ path（弧线） |
| 支持选中高亮 | 通过 data-id 属性标识元素 |

**SvgAgvRenderer（动态层）：**

| 功能 | 说明 |
|------|------|
| 绘制小车 | polygon（三角形表示方向）+ 状态颜色 |
| 绘制目标线 | line + stroke-dasharray（虚线） |
| 绘制目标点 | circle（空心+实心叠加） |
| 绘制规划路径 | 高亮经过的边（半透明粗线） |
| 状态图标 | 故障/充电等特殊状态标记 |

**HitTestHelper（点击检测）：**

| 功能 | 说明 |
|------|------|
| 节点检测 | 点到圆心距离判断 |
| 边检测 | 点到线段距离判断 |
| 优先级 | 节点 > 边（小目标优先） |

### 8.6 画布模式

| 模式 | 用途 | 渲染层 | 交互 |
|------|------|--------|------|
| View | 只读查看 | 静态层 | 无 |
| Edit | 地图编辑 | 静态层 | 点击添加/选中/删除 |
| RouteEdit | 路线编辑 | 静态层 + 路径高亮层 | 点击边添加到路线 |
| Monitor | 实时监控 | 静态层 + 路径高亮层 + 动态层 | 点击小车查看详情 |

### 8.7 各端功能分工

| 功能 | Web | App |
|------|:---:|:---:|
| 地图编辑（增删改节点/边） | ✅ | ❌ |
| 路线编辑 | ✅ | ❌ |
| 地图查看 | ✅ | ✅ |
| 实时监控（小车+目标线） | ✅ | ✅ |

App 端仅做查看和监控，复用 SVG 生成逻辑，交互更简单。

### 8.8 NuGet 依赖

| 项目 | 包 | 说明 |
|------|-----|------|
| AgvDispatch.Shared | 无 | 纯字符串拼接生成 SVG |
| AgvDispatch.Web | 无 | Blazor 原生支持 SVG |
| AgvDispatch.Mobile | `Avalonia.Svg.Skia` | 解析并渲染 SVG |

### 8.9 性能注意事项

| 场景 | 元素数量 | 建议 |
|------|----------|------|
| 地图编辑 | < 500 节点/边 | SVG 完全适用 |
| 实时监控 | < 50 台小车 | 分层渲染，动态层独立更新 |
| 大规模监控 | > 100 台小车 | 考虑视口裁剪，只渲染可见区域 |

**优化策略：**
- 使用 Blazor 组件化，利用 diff 算法减少 DOM 更新
- 动态层使用 `@((MarkupString)svg)` 整体替换，避免逐元素更新
- 路径变化检测：仅在规划路径实际变化时更新路径高亮层

---

## 九、后续优化（非 MVP）

- 节点拖拽移动位置
- 弧线边的可视化绘制（贝塞尔曲线）
- 导入/导出地图配置（JSON/Excel）
- 路线冲突检测
