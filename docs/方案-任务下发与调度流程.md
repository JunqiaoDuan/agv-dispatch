# AGV调度系统 - 任务下发与调度流程设计文档 (手动调度版)

## 零、方案背景

### 实际场景
- **车辆规模**: 仅3辆AGV小车
- **路线特点**: 路线固定,站点明确
- **操作模式**: 工人手动操作为主,系统辅助推荐
- **业务流程**: 生产节拍由人工控制,小车服务于工人操作

### 核心设计原则
1. **手动触发**: 所有任务由工人主动发起,无后台自动调度
2. **智能推荐**: 系统根据距离+电量+状态综合评分,推荐最优小车
3. **快速响应**: 工人确认后立即MQTT下发,无延迟
4. **简单直观**: 界面操作简单,推荐理由清晰

---

## 一、核心流程概述

### 1.1 完整执行流程 (四步手动确认法)

```
┌────────────────────────────────────────────────────────────┐
│ 步骤1: 工人发起召唤                                          │
│    操作界面: Web端/工位触摸屏                                 │
│    操作:                                                     │
│      1. 选择任务类型 (上料/下料/充电/归位)                     │
│      2. 选择目标站点 (如 S001-上料点A)                        │
│      3. 点击"召唤小车"按钮                                    │
│    结果:                                                     │
│      - 调用 API: POST /api/tasks/summon                     │
│      - 系统创建任务,状态=Pending                              │
│      - 自动触发推荐算法                                       │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ 步骤2: 系统智能推荐小车 (实时计算)                            │
│    推荐算法: 综合评分排序                                     │
│    评分因素:                                                 │
│      - 距离因素 (40%权重): 距离越近分数越高                   │
│      - 电量因素 (30%权重): 电量越高分数越高                   │
│      - 状态因素 (30%权重): Idle状态优先,Running状态扣分       │
│    计算公式:                                                 │
│      Score = 距离分(0-40) + 电量分(0-30) + 状态分(0-30)      │
│    推荐列表:                                                 │
│      [                                                      │
│        {agvCode:"V001", score:85, distance:50cm,           │
│         battery:80%, status:Idle, reason:"距离近+电量充足"},  │
│        {agvCode:"V002", score:72, distance:120cm,          │
│         battery:90%, status:Idle, reason:"电量最高"},        │
│        {agvCode:"V003", score:45, distance:200cm,          │
│         battery:30%, status:Running, reason:"正在执行任务"}  │
│      ]                                                      │
│    界面展示: 推荐列表(突出显示第一名),附带推荐理由              │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ 步骤3: 工人确认选择小车                                       │
│    操作界面: 推荐列表弹窗                                     │
│    操作:                                                     │
│      1. 查看推荐列表(系统默认选中第一名)                       │
│      2. 工人可手动切换选择其他小车                            │
│      3. 点击"确认派遣"按钮                                    │
│    结果:                                                     │
│      - 调用 API: POST /api/tasks/{id}/assign               │
│      - 参数: {agvId, confirmedBy}                          │
│      - 更新任务状态: Pending → Assigned                     │
│      - 更新小车状态: Idle → Running                         │
│      - 立即触发MQTT下发                                      │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ 步骤4: 立即MQTT下发任务                                       │
│    Topic: agv/{agvCode}/task/assign                        │
│    消息: {taskId, taskType, startStation, endStation, ...} │
│    QoS: 1 (至少一次,确保送达)                                │
│    说明: 无需等待后台轮询,确认后立即下发                       │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ 步骤5: 小车执行任务并上报进度                                 │
│    小车动作:                                                 │
│      1. 接收任务 → 规划路径 → 开始移动                       │
│      2. 实时上报状态 (心跳1-5秒)                             │
│      3. 关键节点上报进度 (到达、装货、卸货、完成)              │
│    系统更新:                                                 │
│      - 收到Executing状态 → 更新StartedAt                    │
│      - 收到Completed状态 → 更新CompletedAt, 释放小车资源     │
│      - 收到Failed状态 → 记录失败原因, 释放小车                │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ 步骤6: 工人确认完成,发起下一步任务                            │
│    场景示例:                                                 │
│      1. 上料完成 → 工人发起"告知小车去下料"                   │
│      2. 下料完成 → 工人发起"确认下料去等待区"                 │
│      3. 电量低时 → 工人发起"让小车充电"                       │
│    操作: 重复步骤1-5                                         │
└────────────────────────────────────────────────────────────┘
```

### 1.2 任务状态流转

```
Pending (待确认,已有推荐列表)
    ↓ 工人选择小车并确认
Assigned (已分配,已下发MQTT)
    ↓ 小车开始执行
Executing (执行中,小车上报进度)
    ├→ Completed (已完成) ✓  → 小车状态恢复为Idle
    ├→ Failed (失败) ✗      → 小车状态恢复为Idle
    └→ Cancelled (已取消) ◻  → 小车状态恢复为Idle

说明:
- Pending状态: 已创建任务,系统已计算推荐列表,等待工人确认
- Assigned状态: 工人确认后,MQTT消息已发送,小车准备执行
- Executing状态: 小车已开始执行,实时上报进度
- 终态: 任务结束后,小车资源立即释放,可接收下一任务
```

### 1.3 四种任务类型与典型流程

```
任务类型1: CallForLoading (召唤小车上料)
  触发时机: 工人准备好物料,需要小车来装货
  起点: 小车当前位置 (系统自动获取)
  终点: 上料点 (工人选择,如 S001-上料点A)
  到达动作: Load (装货)
  典型流程: 小车从等待区 → 上料点 → 停车等待工人装货

任务类型2: SendToUnloading (告知小车去下料)
  触发时机: 小车装货完成,工人确认可以送往卸货点
  起点: 当前上料点
  终点: 下料点 (工人选择,如 S005-卸货点B)
  到达动作: Unload (卸货)
  典型流程: 上料点 → 下料点 → 停车等待工人卸货

任务类型3: ReturnToWaiting (确认下料去等待区)
  触发时机: 卸货完成,工人确认小车可以返回等待区
  起点: 当前下料点
  终点: 等待区 (如 S010-等待区)
  到达动作: Stop (停车待命)
  典型流程: 下料点 → 等待区 → Idle状态

任务类型4: SendToCharge (让小车充电)
  触发时机: 工人发现小车电量低,主动派遣充电
  起点: 小车当前位置
  终点: 充电站 (如 S020-充电站)
  到达动作: Charge (充电)
  典型流程: 当前位置 → 充电站 → Charging状态

完整业务循环示例:
  1. 工人: "召唤小车上料" (S001)      → Task1: CallForLoading
  2. 小车到达,工人装货完成
  3. 工人: "告知小车去下料" (S005)    → Task2: SendToUnloading
  4. 小车到达,工人卸货完成
  5. 工人: "确认下料去等待区" (S010) → Task3: ReturnToWaiting
  (如果电量低)
  6. 工人: "让小车充电" (S020)       → Task4: SendToCharge
```

### 1.4 与原方案的核心差异

| 对比维度 | 原方案(自动调度) | 新方案(手动调度) |
|---------|-----------------|-----------------|
| **触发方式** | 后台服务每10秒轮询 | 工人主动发起召唤 |
| **任务分配** | 系统自动分配最优小车 | 系统推荐,工人确认 |
| **MQTT下发时机** | 调度服务分配后 | 工人确认后立即下发 |
| **任务类型** | 3种(搬运/充电/返回) | 4种独立步骤(上料/下料/归位/充电) |
| **调度策略** | 距离最近优先 | 综合评分(距离40%+电量30%+状态30%) |
| **后台服务** | AutoDispatchService每10秒调度 | 无后台调度,仅保留超时检测 |
| **适用场景** | 大规模车队,全自动化 | 小规模车队(3辆),人工主导 |
| **操作复杂度** | 低(系统全自动) | 中(每步需确认,但有智能推荐) |
| **响应速度** | 慢(最多等10秒) | 快(确认后立即下发) |

---

## 二、核心数据模型

### 2.1 任务实体 (Tasks)

**新增字段**:
- `RecommendedAgvsJson`: 推荐小车列表JSON,存储推荐结果供查询
- `AssignedBy`: 确认分配的工人ID
- `AssignedByName`: 确认分配的工人姓名

**推荐列表JSON格式示例**:
```json
[
  {
    "agvId": "guid1",
    "agvCode": "V001",
    "score": 85,
    "distance": 50,
    "battery": 80,
    "status": 10,
    "reason": "距离近+电量充足"
  }
]
```

### 2.2 枚举定义

**任务类型 (4种独立任务)**:
- CallForLoading = 10 (召唤小车上料)
- SendToUnloading = 20 (告知小车去下料)
- ReturnToWaiting = 30 (确认下料去等待区)
- SendToCharge = 40 (让小车充电)

**任务状态**:
- Pending = 0 (待确认)
- Assigned = 10 (已分配)
- Executing = 20 (执行中)
- Completed = 30 (已完成)
- Cancelled = 40 (已取消)
- Failed = 50 (失败)

**小车状态**:
- Offline = 0 (离线)
- Idle = 10 (空闲)
- Running = 20 (执行中)
- Charging = 30 (充电中)
- Error = 90 (故障)

**路段动作**:
- None = 0 (无动作)
- Stop = 10 (停车)
- Load = 20 (装货)
- Unload = 30 (卸货)
- Charge = 40 (充电)

### 2.3 推荐算法数据模型

**推荐结果项 (AgvRecommendation)**:
- AgvId: 小车ID
- AgvCode: 小车编号
- TotalScore: 总分 (0-100)
- DistanceScore: 距离分 (0-40)
- BatteryScore: 电量分 (0-30)
- StatusScore: 状态分 (0-30)
- Distance: 实际距离 (厘米)
- Battery: 电量百分比
- Status: 当前状态
- RecommendReason: 推荐理由文本

### 2.4 路径与锁定管理表设计

#### 设计理念

**两层路径设计**:
- **TaskRouteSegments (Web显示路径)**: 细粒度，关联地图节点和边，用于Web端可视化渲染
- **TaskRouteCheckpoints (AGV对接路径)**: 粗粒度，仅包含关键站点，用于AGV导航和通行控制

**路径冲突管理**:
- **锁定粒度**: 站点间路段 (如 S002→S003)
- **通行控制**: AGV实时申请-响应模式
- **冲突处理**: 原地等待，定期重试

#### 核心表结构

##### 1. TaskRoutes (任务路线定义表)

**用途**: 定义逻辑路线

**核心字段**:
- Id, RouteCode (R001), RouteName
- StartStationCode, EndStationCode
- Description, IsValid, SortNo

**关系**:
- 一条TaskRoute有多个TaskRouteSegments (Web显示路径)
- 一条TaskRoute有多个TaskRouteCheckpoints (AGV对接路径)

##### 2. TaskRouteSegments (Web显示路径表)

**用途**: 用于Web端可视化渲染，关联地图节点和边

**核心字段**:
- Id, RouteId
- Seq (10, 20, 30) - 序号
- MapEdgeId - 关联MapEdge表
- Direction (Forward/Backward) - 行驶方向
- FinalAction (None/Stop/Load/Unload) - 到达后动作
- WaitTime - 等待时间(秒)

**数据示例**:
```
路线R001 "上料点A到卸货点B":
Seq=10: MapEdge(N001→N002), Direction=Forward, Action=None
Seq=20: MapEdge(N002→N003), Direction=Forward, Action=None
Seq=30: MapEdge(N003→N005), Direction=Forward, Action=Unload

前端根据这些记录在Canvas上绘制路径线条
```

##### 3. TaskRouteCheckpoints (AGV对接路径表)

**用途**: AGV导航检查点序列，只包含关键站点

**核心字段**:
- Id, RouteId
- Seq (10, 20, 30, 40, 50) - 序号
- StationCode (S001, S002, S003, S004, S005)
- CheckpointType - 检查点类型枚举:
  - Start (10) - 起点
  - Middle (20) - 中间点 (需要申请通行权)
  - End (30) - 终点
- IsLockRequired - 是否需要锁定 (布尔值)
- Description - 描述 (如"狭窄通道入口")

**数据示例**:
```
路线R001 "上料点A到卸货点B":
Seq=10: S001(起点), Type=Start, IsLockRequired=false
Seq=20: S002(中间点-交叉路口), Type=Middle, IsLockRequired=true  ← 需要申请
Seq=30: S003(中间点-狭窄通道), Type=Middle, IsLockRequired=true  ← 需要申请
Seq=40: S004(中间点), Type=Middle, IsLockRequired=false
Seq=50: S005(终点), Type=End, IsLockRequired=false

AGV收到的MQTT消息:
{
  taskId: "T001",
  checkpoints: [
    {seq: 10, station: "S001", type: "Start", needLock: false},
    {seq: 20, station: "S002", type: "Middle", needLock: true},
    {seq: 30, station: "S003", type: "Middle", needLock: true},
    {seq: 40, station: "S004", type: "Middle", needLock: false},
    {seq: 50, station: "S005", type: "End", needLock: false}
  ]
}
```

**为什么分Start/Middle/End**:
- Start: AGV开始移动，不需要锁定 (已经在起点)
- Middle: AGV到达前需要向服务器申请通行权，锁定下一段路
- End: 任务完成点，释放所有锁定

##### 4. TaskPathLocks (任务路径锁定表)

**用途**: 记录路段占用情况，用于冲突检测

**核心字段**:
- Id
- FromStationCode (S002) - 起始站点
- ToStationCode (S003) - 目标站点
- LockedByAgvId - 占用的小车ID
- LockedByAgvCode (V001) - 小车编号 (冗余，便于查询)
- TaskId - 关联任务ID
- LockedAt - 锁定时间
- ExpireAt - 过期时间 (可选，防止死锁)

**索引**:
- 唯一索引: (FromStationCode, ToStationCode) - 确保一段路只能被一辆车占用
- 普通索引: (LockedByAgvId, LockedAt)

**锁定粒度示例**:
```
V001小车从S001→S002→S003→S005移动:

步骤1: AGV到达S002前，申请锁定S002→S003
       TaskPathLocks记录:
       {FromStation: S002, ToStation: S003, LockedByAgv: V001, TaskId: T001}

步骤2: AGV通过S002，到达S003前，申请锁定S003→S005
       先释放S002→S003锁
       再申请S003→S005锁

步骤3: AGV到达S005 (终点)，释放S003→S005锁
```

##### 5. TaskPathLockLogs (通行请求日志表) - 可选

**用途**: 记录AGV请求通行的历史，用于审计和优化

**核心字段**:
- Id, AgvId, AgvCode, TaskId
- FromStationCode, ToStationCode
- RequestTime - 请求时间
- ApprovedTime - 批准时间 (null表示被拒绝)
- Status - 状态枚举:
  - Pending (0) - 等待中
  - Approved (10) - 已批准
  - Rejected (20) - 已拒绝 (路段被占用)
  - Timeout (30) - 超时
- WaitDuration - 等待时长 (毫秒)
- RejectedReason - 拒绝原因

**用途**:
- 分析哪些路段经常冲突
- 优化路线设计
- 审计AGV通行记录

#### 表关系图

```
TaskRoutes (任务路线定义)
  ├─── TaskRouteSegments[] (Web显示路径)
  │      └─── 关联 MapEdge (地图边)
  │             └─── 关联 MapNode (地图节点)
  │
  └─── TaskRouteCheckpoints[] (AGV对接路径)
         └─── 引用 Station (站点)

Tasks (任务)
  ├─── 关联 TaskRoutes (使用哪条路线)
  └─── 关联 Agv (分配给哪辆车)

TaskPathLocks (任务路径锁定)
  ├─── 关联 Agv (哪辆车占用)
  └─── 关联 Tasks (执行哪个任务)

TaskPathLockLogs (通行请求日志，可选)
  ├─── 关联 Agv
  └─── 关联 Tasks
```

#### AGV实时申请通行流程

```
┌─────────────────────────────────────────────────┐
│ AGV即将到达中间点S002                             │
│ (通过GPS/传感器判断距离S002还有5米)                 │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ AGV发送MQTT请求                                  │
│ Topic: agv/{agvCode}/path/lock-request          │
│ {                                               │
│   taskId: "T001",                               │
│   fromStation: "S002",                          │
│   toStation: "S003"                             │
│ }                                               │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 服务器处理 (HandlePathLockRequestAsync)          │
│ 1. 查询TaskPathLocks表                          │
│    WHERE FromStation=S002 AND ToStation=S003    │
│ 2. 判断:                                        │
│    - 如果锁不存在 → 创建锁记录 → 返回Approved     │
│    - 如果锁存在 → 返回Rejected                   │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 服务器返回MQTT响应                                │
│ Topic: agv/{agvCode}/path/lock-response         │
│ {                                               │
│   taskId: "T001",                               │
│   fromStation: "S002",                          │
│   toStation: "S003",                            │
│   status: "Approved" / "Rejected",              │
│   message: "路段已锁定，允许通过"                  │
│ }                                               │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ AGV收到响应                                      │
│ - Approved → 继续前进                            │
│ - Rejected → 原地等待5秒，再次发送请求            │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ AGV通过S002，即将离开时                           │
│ 发送释放锁请求 (可选，也可以申请下一段时自动释放)   │
│ Topic: agv/{agvCode}/path/unlock                │
│ {                                               │
│   fromStation: "S002",                          │
│   toStation: "S003"                             │
│ }                                               │
└─────────────────────────────────────────────────┘
```

#### 完整数据示例

**TaskRoutes表**:
| RouteCode | RouteName | StartStation | EndStation |
|-----------|-----------|--------------|------------|
| R001 | 上料点A到卸货点B | S001 | S005 |

**TaskRouteSegments表 (Web显示路径)**:
| RouteId | Seq | MapEdgeId | Direction | Action |
|---------|-----|-----------|-----------|--------|
| R001 | 10 | E001 | Forward | None |
| R001 | 20 | E002 | Forward | None |
| R001 | 30 | E005 | Forward | Unload |

**TaskRouteCheckpoints表 (AGV对接路径)**:
| RouteId | Seq | StationCode | Type | IsLockRequired |
|---------|-----|-------------|------|----------------|
| R001 | 10 | S001 | Start | false |
| R001 | 20 | S002 | Middle | true |
| R001 | 30 | S003 | Middle | true |
| R001 | 40 | S005 | End | false |

**TaskPathLocks表 (当前锁定状态)**:
| FromStation | ToStation | LockedByAgv | LockedAt | TaskId |
|-------------|-----------|-------------|----------|--------|
| S002 | S003 | V001 | 2026-01-17 10:05:00 | T001 |

---

## 三、MQTT 通信协议

### 3.1 Topic 结构

**AGV → 服务器 (上行)**:
- `agv/{agvCode}/status` - 状态上报 (心跳,1-5秒)
- `agv/{agvCode}/task/progress` - 任务进度上报 (状态变化时)
- `agv/{agvCode}/path/lock-request` - 路段锁定请求 (到达中间点前)
- `agv/{agvCode}/path/unlock` - 路段解锁通知 (离开路段后)
- `agv/{agvCode}/exception` - 异常上报

**服务器 → AGV (下行)**:
- `agv/{agvCode}/task/assign` - 任务下发 (工人确认后立即发送)
- `agv/{agvCode}/task/cancel` - 任务取消
- `agv/{agvCode}/path/lock-response` - 路段锁定响应 (批准/拒绝)
- `agv/{agvCode}/command` - 控制指令 (暂停/继续/急停)

### 3.2 任务下发消息 (TaskAssignMessage)

**Topic**: `agv/{agvCode}/task/assign`
**QoS**: 1 (至少一次)
**触发时机**: 工人确认分配后立即发送

**消息字段**:
- taskId: 任务编号
- taskType: 任务类型枚举
- priority: 优先级
- timestamp: 时间戳
- startStationCode: 起点站点
- endStationCode: 终点站点
- description: 任务描述
- assignedByName: 工人姓名 (新增)
- routeSegments: 路径指令序列

### 3.3 任务进度上报 (TaskProgressMessage)

**Topic**: `agv/{agvCode}/task/progress`
**QoS**: 1

**消息字段**:
- agvCode: 小车编号
- taskId: 任务编号
- timestamp: 时间戳
- progressPercentage: 进度百分比 (0-100)
- status: 任务状态枚举
- message: 进度消息文本

### 3.4 状态上报 (StatusMessage)

**Topic**: `agv/{agvCode}/status`
**QoS**: 0 (允许丢失)

**消息字段**:
- agvCode: 小车编号
- timestamp: 时间戳
- status: 小车状态枚举
- battery: 电量百分比
- speed: 速度
- position: 位置信息 {x, y, angle, stationId}
- currentTaskId: 当前任务ID
- errorCode: 错误码

### 3.5 路段锁定请求 (PathLockRequestMessage)

**Topic**: `agv/{agvCode}/path/lock-request`
**QoS**: 1 (至少一次)
**触发时机**: AGV即将到达中间点时 (距离约5米)

**消息字段**:
- agvCode: 小车编号
- taskId: 当前任务编号
- timestamp: 时间戳
- fromStationCode: 起始站点 (当前中间点)
- toStationCode: 目标站点 (下一个中间点或终点)

**消息示例**:
```json
{
  "agvCode": "V001",
  "taskId": "T001",
  "timestamp": "2026-01-17T10:05:00Z",
  "fromStationCode": "S002",
  "toStationCode": "S003"
}
```

### 3.6 路段锁定响应 (PathLockResponseMessage)

**Topic**: `agv/{agvCode}/path/lock-response`
**QoS**: 1 (至少一次)
**触发时机**: 服务器收到锁定请求后立即响应

**消息字段**:
- agvCode: 小车编号
- taskId: 任务编号
- timestamp: 时间戳
- fromStationCode: 起始站点
- toStationCode: 目标站点
- status: 响应状态枚举
  - Approved (10) - 已批准，允许通过
  - Rejected (20) - 已拒绝，路段被占用
- message: 响应消息
- lockedByAgvCode: 如果被拒绝，返回占用该路段的小车编号 (可选)

**消息示例 (批准)**:
```json
{
  "agvCode": "V001",
  "taskId": "T001",
  "timestamp": "2026-01-17T10:05:01Z",
  "fromStationCode": "S002",
  "toStationCode": "S003",
  "status": 10,
  "message": "路段已锁定，允许通过"
}
```

**消息示例 (拒绝)**:
```json
{
  "agvCode": "V001",
  "taskId": "T001",
  "timestamp": "2026-01-17T10:05:01Z",
  "fromStationCode": "S002",
  "toStationCode": "S003",
  "status": 20,
  "message": "路段被占用，请等待",
  "lockedByAgvCode": "V002"
}
```

### 3.7 路段解锁通知 (PathUnlockMessage)

**Topic**: `agv/{agvCode}/path/unlock`
**QoS**: 1 (至少一次)
**触发时机**: AGV离开路段时 (可选，也可以在申请下一段时自动释放上一段)

**消息字段**:
- agvCode: 小车编号
- taskId: 任务编号
- timestamp: 时间戳
- fromStationCode: 起始站点
- toStationCode: 目标站点

**消息示例**:
```json
{
  "agvCode": "V001",
  "taskId": "T001",
  "timestamp": "2026-01-17T10:06:00Z",
  "fromStationCode": "S002",
  "toStationCode": "S003"
}
```

---

## 四、详细设计

### 4.1 核心服务设计

#### 4.1.1 IAgvRecommendationService - 小车推荐服务

**职责**: 根据任务需求计算推荐小车列表

**核心方法**:
- `GetRecommendationsAsync(targetStationCode, taskType, minBattery)`
  - 参数: 目标站点、任务类型、最低电量要求
  - 返回: 推荐列表 (按总分降序排列,Top 3)

**实现逻辑**:
1. 获取目标站点坐标
2. 获取所有在线小车 (排除Offline状态)
3. 为每辆小车计算综合评分:
   - 距离分: 40分满分,距离越近分数越高 (500cm为最大有效距离)
   - 电量分: 30分满分,电量越高分数越高 (低于最低要求扣分严重)
   - 状态分: 30分满分 (Idle=30, Charging=10, Running=5, Error=0)
4. 生成推荐理由文本
5. 按总分降序排列,返回Top 3

**评分权重说明**:
- **距离因素 (40%)**: 最重要,工人希望小车快速到达
- **电量因素 (30%)**: 重要,避免执行到一半没电
- **状态因素 (30%)**: 重要,优先选择空闲小车

#### 4.1.2 ITaskService - 任务管理服务

**核心新增方法**:

**SummonAgvAsync** - 召唤小车
- 功能: 创建任务并返回推荐列表
- 参数: taskType, targetStationCode, routeId, userId, userName
- 返回: (Task, Recommendations)
- 流程:
  1. 验证路线是否存在
  2. 生成任务编号
  3. 调用推荐服务获取推荐列表
  4. 创建任务(状态=Pending,保存推荐列表JSON)
  5. 返回任务和推荐列表

**AssignAgvToTaskAsync** - 确认分配小车
- 功能: 工人选择小车后确认分配
- 参数: taskId, agvId, userId, userName
- 返回: 是否成功
- 流程:
  1. 查询任务(状态必须为Pending)
  2. 查询小车
  3. 更新任务状态为Assigned,记录分配信息
  4. 更新小车状态为Running,记录当前任务
  5. 立即发送MQTT消息
  6. 保存数据库

**其他方法** (与原方案类似):
- GetTaskByIdAsync: 获取任务详情
- GetTasksAsync: 获取任务列表
- GetPagedTasksAsync: 分页查询
- CancelTaskAsync: 取消任务
- UpdateTaskProgressAsync: 更新任务进度 (MQTT回调)
- GetNextTaskCodeAsync: 生成任务编号
- GetTaskStatisticsAsync: 获取统计信息

---

### 4.2 API 控制器设计

#### TasksController

**核心新增端点**:

**1. POST /api/tasks/summon - 召唤小车**

**请求参数**:
- taskType: 任务类型枚举
- targetStationCode: 目标站点编号
- routeId: 路线ID

**响应数据**:
- taskId: 任务ID
- taskCode: 任务编号
- recommendations: 推荐列表数组
  - agvId, agvCode, totalScore, distance, battery
  - status, statusText, recommendReason
  - isRecommended: 是否为系统推荐(第一名)

**2. POST /api/tasks/{id}/assign - 确认分配小车**

**请求参数**:
- agvId: 选中的小车ID

**响应数据**:
- 成功: true
- 消息: "任务已下发至小车"

**其他端点** (保持与原方案一致):
- GET /api/tasks - 获取所有任务列表
- GET /api/tasks/paged - 分页查询
- GET /api/tasks/{id} - 获取任务详情
- DELETE /api/tasks/{id} - 取消任务
- GET /api/tasks/statistics - 获取统计信息

---

### 4.3 MQTT 消息处理

**HandleTaskProgressAsync**:
- 功能: 处理小车上报的任务进度消息
- 流程:
  1. 根据TaskCode查询任务
  2. 更新状态和进度百分比
  3. 根据状态更新时间字段
  4. 任务结束时释放小车资源(设置Idle状态)
  5. 保存更改

**HandleStatusAsync**:
- 功能: 处理小车状态上报
- 流程:
  1. 更新小车实时状态(位置、电量、速度)
  2. 更新LastOnlineTime
  3. 更新ErrorCode(如果有)

**HandlePathLockRequestAsync** - 新增:
- 功能: 处理AGV路段锁定请求
- 流程:
  1. 接收MQTT消息(fromStation, toStation, agvCode, taskId)
  2. 查询TaskPathLocks表，检查路段是否已被锁定
  3. 如果未锁定:
     - 创建TaskPathLocks记录
     - 记录TaskPathLockLogs日志(Status=Approved)
     - 发送MQTT响应(Status=Approved)
  4. 如果已锁定:
     - 检查是否是同一辆车(允许重复请求)
     - 如果是其他车，记录TaskPathLockLogs日志(Status=Rejected)
     - 发送MQTT响应(Status=Rejected, lockedByAgvCode=xxx)
  5. 保存更改

**HandlePathUnlockAsync** - 新增:
- 功能: 处理AGV路段解锁通知
- 流程:
  1. 接收MQTT消息(fromStation, toStation, agvCode)
  2. 查询TaskPathLocks表
  3. 删除对应的锁定记录
  4. 更新TaskPathLockLogs日志(如果有)
  5. 保存更改

---

### 4.4 路径锁定服务设计

#### IPathLockService - 路径锁定管理服务

**职责**: 管理路段锁定逻辑，防止路径冲突

**核心方法**:

**TryLockPathSegmentAsync** - 尝试锁定路段
- 参数: fromStationCode, toStationCode, agvId, taskId
- 返回: (IsSuccess, LockedByAgvCode, Message)
- 逻辑:
  1. 查询TaskPathLocks表
  2. 如果不存在 → 创建锁定 → 返回成功
  3. 如果已被同一辆车锁定 → 返回成功(允许重复请求)
  4. 如果被其他车锁定 → 返回失败+占用车辆信息

**UnlockPathSegmentAsync** - 解锁路段
- 参数: fromStationCode, toStationCode, agvId
- 返回: IsSuccess
- 逻辑:
  1. 删除TaskPathLocks记录
  2. 只允许锁定者解锁

**GetLockedSegmentsByAgvAsync** - 获取小车占用的所有路段
- 参数: agvId
- 返回: List<TaskPathLock>
- 用途: 任务完成/取消时批量释放锁定

**CleanupExpiredLocksAsync** - 清理过期锁定(后台任务)
- 参数: 无
- 返回: CleanedCount
- 逻辑:
  1. 查询ExpireAt小于当前时间的锁定记录
  2. 删除过期记录
  3. 记录日志
  4. 返回清理数量
- 调用时机: 后台服务每分钟执行一次

---

### 4.5 后台服务设计

**移除的服务**:
- ~~AutoDispatchService~~ - 自动调度服务 (已删除,无需后台轮询)

**保留的服务**:

**TaskTimeoutCheckerService** - 超时检测服务
- 功能: 每5分钟检查执行中的任务是否超时
- 检查间隔: 5分钟
- 超时阈值: 30分钟
- 处理方式: 记录告警日志,可选发送通知

**新增的服务**:

**PathLockCleanupService** - 路径锁定清理服务
- 功能: 每分钟清理过期的路径锁定记录
- 检查间隔: 1分钟
- 过期阈值: 10分钟 (可配置)
- 处理方式:
  1. 调用IPathLockService.CleanupExpiredLocksAsync()
  2. 删除ExpireAt < Now的记录
  3. 记录清理日志
  4. 防止死锁(小车异常离线导致锁定未释放)

---

## 五、数据库和服务注册

### 5.1 数据库迁移

**Tasks表新增字段**:
- RecommendedAgvsJson: nvarchar(max), nullable
- AssignedBy: uniqueidentifier, nullable
- AssignedByName: nvarchar(50), nullable

**新增表**:

**TaskRouteCheckpoints表**:
- Id: uniqueidentifier, PK
- RouteId: uniqueidentifier, FK → TaskRoutes
- Seq: int (序号)
- StationCode: nvarchar(50)
- CheckpointType: int (枚举: Start=10, Middle=20, End=30)
- IsLockRequired: bit
- Description: nvarchar(200), nullable
- 索引: (RouteId, Seq)

**TaskPathLocks表**:
- Id: uniqueidentifier, PK
- FromStationCode: nvarchar(50)
- ToStationCode: nvarchar(50)
- LockedByAgvId: uniqueidentifier, FK → Agv
- LockedByAgvCode: nvarchar(50)
- TaskId: uniqueidentifier, FK → Tasks
- LockedAt: datetimeoffset
- ExpireAt: datetimeoffset, nullable
- 唯一索引: (FromStationCode, ToStationCode)
- 普通索引: (LockedByAgvId, LockedAt)

**TaskPathLockLogs表 (可选)**:
- Id: uniqueidentifier, PK
- AgvId: uniqueidentifier, FK → Agv
- AgvCode: nvarchar(50)
- TaskId: uniqueidentifier, FK → Tasks
- FromStationCode: nvarchar(50)
- ToStationCode: nvarchar(50)
- RequestTime: datetimeoffset
- ApprovedTime: datetimeoffset, nullable
- Status: int (枚举: Pending=0, Approved=10, Rejected=20, Timeout=30)
- WaitDuration: int, nullable (毫秒)
- RejectedReason: nvarchar(200), nullable
- 索引: (AgvId, RequestTime), (TaskId, RequestTime)

### 5.2 服务注册

**新增服务**:
- IAgvRecommendationService / AgvRecommendationService (Scoped)
- IPathLockService / PathLockService (Scoped)

**新增后台服务**:
- PathLockCleanupService (HostedService)

**移除服务**:
- ~~AutoDispatchService~~ (HostedService)

**保留服务**:
- ITaskService / TaskService (Scoped)
- TaskTimeoutCheckerService (HostedService)

---

## 六、前端交互流程

### 6.1 召唤小车界面

**界面元素**:
1. 任务类型选择器 (4个按钮: 上料/下料/归位/充电)
2. 目标站点选择器 (下拉框: S001-上料点A, S002-上料点B, ...)
3. 路线选择器 (自动根据任务类型+站点匹配)
4. "召唤小车"按钮

**操作流程**:
1. 工人选择任务类型: "召唤小车上料"
2. 工人选择目标站点: "S001-上料点A"
3. 系统自动匹配路线 (可手动切换)
4. 点击"召唤小车"按钮 → 调用 POST /api/tasks/summon
5. 弹出推荐列表对话框

### 6.2 推荐列表对话框

**界面布局**:
```
┌────────────────────────────────────────────────┐
│         选择小车 (系统智能推荐)                   │
├────────────────────────────────────────────────┤
│ ⭐ 推荐  [V001] AGV小车001                      │
│   距离: 50cm  |  电量: 80%  |  状态: 空闲       │
│   推荐理由: 距离很近, 电量充足, 空闲可用          │
│   综合评分: 85.5分                              │
│                                [选择] <-- 默认选中│
├────────────────────────────────────────────────┤
│   [V002] AGV小车002                            │
│   距离: 120cm  |  电量: 90%  |  状态: 空闲      │
│   推荐理由: 距离适中, 电量充足, 空闲可用          │
│   综合评分: 72.0分                              │
│                                [选择]            │
├────────────────────────────────────────────────┤
│   [V003] AGV小车003                            │
│   距离: 200cm  |  电量: 30%  |  状态: 执行中    │
│   推荐理由: 距离较远, 电量偏低, 正在执行任务      │
│   综合评分: 45.0分                              │
│                                [选择]            │
├────────────────────────────────────────────────┤
│             [取消]          [确认派遣]           │
└────────────────────────────────────────────────┘
```

**交互逻辑**:
1. 默认选中第一名 (系统推荐)
2. 工人可点击其他小车切换选择
3. 点击"确认派遣":
   - 调用 POST /api/tasks/{id}/assign
   - 关闭对话框
   - 显示提示: "任务已下发至 V001"
4. 点击"取消":
   - 关闭对话框
   - 删除Pending状态的任务 (或标记为Cancelled)

### 6.3 路段死锁管理页面

**功能说明**:
配置哪些路段（站点A → 站点B）需要AGV小车提前申请占用权限，防止多车同时进入关键路段造成死锁。路段是有方向性的，A→B 和 B→A 是两条独立的路段，可以分别配置。

**页面位置**: 系统管理 → 路线配置 → 路段死锁管理

**界面布局**:
```
┌────────────────────────────────────────────────────────────────────────┐
│ 路段死锁管理                                      [+ 新增路段配置]        │
├────────────────────────────────────────────────────────────────────────┤
│ 说明: 配置需要AGV小车提前申请占用权限的路段，防止路径冲突。路段是有     │
│       方向性的，进入和离开可以分别配置。                                │
├──────┬──────────┬──────────┬──────────────────┬──────────┬──────────┤
│ 编号 │ 起始站点  │ 目标站点  │  路段描述          │ 需要锁定  │   操作    │
├──────┼──────────┼──────────┼──────────────────┼──────────┼──────────┤
│  1   │  S002    │  S003    │ 交叉口进入狭窄通道  │  ☑ 是    │[编辑][删除]│
│      │ 交叉路口A │ 狭窄通道  │                   │          │          │
│      │          │          │ 理由: 进入狭窄通道，宽度仅容单车，易堵塞   │
│      │          │    →     │ 超时: 10分钟                            │
├──────┼──────────┼──────────┼──────────────────┼──────────┼──────────┤
│  2   │  S003    │  S002    │ 狭窄通道离开交叉口  │  ☐ 否    │[编辑][删除]│
│      │ 狭窄通道  │ 交叉路口A │                   │          │          │
│      │          │          │ 理由: 离开狭窄通道，空间充足，无需锁定     │
│      │          │    →     │ 超时: -                                 │
├──────┼──────────┼──────────┼──────────────────┼──────────┼──────────┤
│  3   │  S005    │  S007    │ 卸货点到转弯区      │  ☑ 是    │[编辑][删除]│
│      │ 卸货点B   │ 转弯区域  │                   │          │          │
│      │          │          │ 理由: 90度转弯，速度慢易堵塞，需要控制    │
│      │          │    →     │ 超时: 10分钟                            │
├──────┼──────────┼──────────┼──────────────────┼──────────┼──────────┤
│  4   │  S007    │  S005    │ 转弯区到卸货点      │  ☐ 否    │[编辑][删除]│
│      │ 转弯区域  │ 卸货点B   │                   │          │          │
│      │          │          │ 理由: 转弯完成后直行，无需锁定            │
│      │          │    →     │ 超时: -                                 │
├──────┼──────────┼──────────┼──────────────────┼──────────┼──────────┤
│  5   │  S001    │  S002    │ 上料点到交叉口      │  ☑ 是    │[编辑][删除]│
│      │ 上料点A   │ 交叉路口A │                   │          │          │
│      │          │          │ 理由: 多条路线汇集交叉口，易冲突          │
│      │          │    →     │ 超时: 10分钟                            │
└──────┴──────────┴──────────┴──────────────────┴──────────┴──────────┘

筛选: [全部路段 ▼]  [需要锁定 ▼]  [起始站点 ▼]  [目标站点 ▼]  [搜索]
```

**新增/编辑对话框**:
```
┌──────────────────────────────────────────────┐
│  配置路段锁定规则                              │
├──────────────────────────────────────────────┤
│ 起始站点: [S002 - 交叉路口A    ▼]             │
│                                              │
│ 目标站点: [S003 - 狭窄通道     ▼]             │
│                                              │
│ 路段方向: S002 → S003                         │
│                                              │
│ 需要锁定: ☑ 是                                │
│                                              │
│ 锁定理由:                                     │
│ ┌──────────────────────────────────────────┐ │
│ │进入狭窄通道，通道宽度仅容纳单车，          │ │
│ │多车同时进入会造成堵塞，必须申请占用权限    │ │
│ └──────────────────────────────────────────┘ │
│                                              │
│ 锁定超时时间: [10] 分钟                       │
│ (超过此时间自动释放，防止死锁)                 │
│                                              │
│ 优先级: [普通 ▼]  (高/普通/低)                │
│                                              │
│ 反向路段配置:                                 │
│ ┌──────────────────────────────────────────┐ │
│ │ S003 → S002 (狭窄通道 → 交叉路口A)         │ │
│ │ ☐ 同时创建反向路段配置                     │ │
│ │ ☐ 反向路段也需要锁定                       │ │
│ └──────────────────────────────────────────┘ │
│                                              │
│        [取消]        [保存]                   │
└──────────────────────────────────────────────┘
```

**核心功能**:

1. **路段列表展示**:
   - 显示所有路段（起始站点 → 目标站点）及其锁定配置
   - 清晰显示路段方向（箭头表示）
   - 支持按"需要锁定"状态筛选
   - 支持按起始站点、目标站点筛选
   - 支持搜索站点编号/名称
   - 双向路段（A→B 和 B→A）分别显示

2. **新增路段配置**:
   - 选择起始站点（从Stations表读取）
   - 选择目标站点（从Stations表读取）
   - 自动显示路段方向（起始 → 目标）
   - 配置是否需要锁定
   - 填写锁定理由（便于维护人员理解）
   - 设置锁定超时时间（默认10分钟）
   - 可选：同时创建反向路段配置
   - 可选：反向路段是否也需要锁定

3. **编辑路段配置**:
   - 修改起始站点、目标站点（会创建新路段）
   - 开启/关闭锁定需求
   - 更新锁定理由
   - 调整超时时间

4. **删除路段配置**:
   - 删除锁定规则（不影响站点本身）
   - 删除前检查是否有正在使用该路段的任务
   - 确认提示："确认删除路段 S002→S003 的锁定配置？这将影响相关路线的通行控制"

**数据关联**:
- 配置保存在新表 `PathSegmentLockConfigs`（路段锁定配置表）
- 字段设计:
  - `Id`: 主键
  - `FromStationCode`: 起始站点编号
  - `ToStationCode`: 目标站点编号
  - `IsLockRequired`: 是否需要锁定（布尔值）
  - `LockReason`: 锁定理由描述
  - `TimeoutMinutes`: 超时时间（分钟，默认10）
  - `Priority`: 优先级（可选）
  - `IsActive`: 是否启用
  - 唯一索引: (`FromStationCode`, `ToStationCode`)
- 影响范围:
  - 所有包含该路段的路线（TaskRoutes）
  - AGV申请路段锁定时的判断依据
  - TaskPathLocks表的创建依据

**API端点**:

```
GET    /api/path-segments/lock-configs           获取所有路段锁定配置
GET    /api/path-segments/lock-configs/:id       获取单个路段锁定配置
POST   /api/path-segments/lock-configs           新增路段锁定配置
PUT    /api/path-segments/lock-configs/:id       更新路段锁定配置
DELETE /api/path-segments/lock-configs/:id       删除路段锁定配置
GET    /api/path-segments/lock-configs/reverse   查询反向路段配置
       ?from=S002&to=S003                        (返回 S003→S002 的配置)
```

**配置示例**:

| 起始站点 | 目标站点 | 路段方向 | 需要锁定 | 锁定理由 | 超时时间 |
|---------|---------|---------|---------|---------|---------|
| S002 | S003 | S002 → S003 | 是 | 进入狭窄通道，宽度仅容单车 | 10分钟 |
| S003 | S002 | S003 → S002 | 否 | 离开狭窄通道，空间充足 | - |
| S005 | S007 | S005 → S007 | 是 | 90度转弯，速度慢易堵塞 | 10分钟 |
| S007 | S005 | S007 → S005 | 否 | 转弯完成后直行，无需锁定 | - |
| S001 | S002 | S001 → S002 | 是 | 多条路线汇集交叉口 | 10分钟 |
| S002 | S001 | S002 → S001 | 否 | 离开交叉口，无需锁定 | - |

**业务规则**:

1. **方向性原则**:
   - 路段是有方向的：A→B 和 B→A 是两条独立的路段
   - 进入狭窄区域通常需要锁定，离开狭窄区域通常不需要锁定
   - 可以根据实际场景灵活配置单向或双向锁定

2. **自动应用规则**:
   - 配置保存后，立即应用到AGV路段锁定申请逻辑
   - 新创建的路线自动使用最新的路段锁定配置
   - 修改配置后，正在执行的任务继续使用旧配置，新任务使用新配置

3. **锁定判断逻辑**:
   - AGV到达路段起始站点时，查询 `PathSegmentLockConfigs` 表
   - 如果 `IsLockRequired = true`，则发送锁定请求
   - 如果 `IsLockRequired = false`，则直接通过，无需申请

4. **超时保护**:
   - 默认超时时间: 10分钟
   - 超时后自动释放锁定，防止死锁
   - 超时时间可根据实际路段通行耗时调整

5. **反向路段提示**:
   - 创建路段配置时，系统提示是否同时创建反向路段
   - 显示反向路段是否已配置
   - 便于管理员统一管理双向通行规则

**使用场景**:

1. **初始配置**: 系统部署时，根据现场布局配置易冲突路段
   - 狭窄通道入口：需要锁定
   - 狭窄通道出口：不需要锁定

2. **优化调整**: 运行一段时间后，根据实际冲突日志优化配置
   - 分析 `TaskPathLockLogs` 表的拒绝记录
   - 识别高频冲突路段，增加锁定配置

3. **新增路线**: 添加新路线时，同步配置路段锁定规则
   - 路线规划人员标注易冲突路段
   - 系统管理员配置锁定规则

4. **故障排查**: 查看路段配置，分析死锁原因
   - 检查是否某些路段配置不合理
   - 调整超时时间或锁定策略

**典型配置案例**:

```
场景1: 狭窄通道（宽度仅容单车）
  S002 → S003 (进入): 需要锁定 ✓  "进入狭窄通道，必须申请"
  S003 → S002 (离开): 不需要锁定 ✗  "离开通道，空间充足"

场景2: 交叉路口（多条路线汇集）
  S001 → S002 (进入): 需要锁定 ✓  "多条路线汇集，易冲突"
  S004 → S002 (进入): 需要锁定 ✓  "多条路线汇集，易冲突"
  S002 → S001 (离开): 不需要锁定 ✗  "离开交叉口"
  S002 → S004 (离开): 不需要锁定 ✗  "离开交叉口"

场景3: 转弯区域（90度转弯，速度慢）
  S005 → S007 (进入): 需要锁定 ✓  "转弯速度慢，易堵塞"
  S007 → S005 (离开): 不需要锁定 ✗  "转弯完成，直行"

场景4: 双向狭窄通道（两个方向都需要锁定）
  S010 → S011 (通过): 需要锁定 ✓  "双向通道，都需要申请"
  S011 → S010 (通过): 需要锁定 ✓  "双向通道，都需要申请"
```

**权限控制**:
- 仅系统管理员可访问此页面
- 修改配置需要二次确认
- 记录配置修改日志（谁、何时、修改了哪个路段）

**可视化辅助**（可选）:
- 在地图上显示已配置锁定的路段（用不同颜色的箭头标注）
- 红色箭头：需要锁定的路段
- 绿色箭头：不需要锁定的路段
- 点击路段箭头可直接编辑配置

---

## 七、实现顺序建议

### 阶段1: 数据模型和数据库
1. 修改 Tasks 实体 (新增3个字段)
2. 创建数据库迁移并应用
3. 编写单元测试验证字段

### 阶段2: 推荐算法服务
1. 创建 AgvRecommendation 模型
2. 实现 IAgvRecommendationService 和 AgvRecommendationService
3. 编写单元测试验证评分逻辑

### 阶段3: 任务服务
1. 修改 ITaskService 接口 (新增方法)
2. 实现 SummonAgvAsync 方法
3. 实现 AssignAgvToTaskAsync 方法
4. 编写单元测试验证业务逻辑

### 阶段4: API 控制器
1. 创建 DTO 类 (SummonAgvRequest, SummonAgvResponse, AssignAgvRequest)
2. 实现 TasksController 新增端点
3. 使用 Swagger 测试 API

### 阶段5: 路径锁定功能
1. 创建 TaskRouteCheckpoints 实体和表
2. 创建 TaskPathLocks 实体和表
3. 创建 TaskPathLockLogs 实体和表 (可选)
4. 实现 IPathLockService 和 PathLockService
5. 编写单元测试验证锁定逻辑

### 阶段6: MQTT 消息处理
1. 修改任务下发消息格式 (新增 checkpoints 字段)
2. 实现 HandlePathLockRequestAsync 方法
3. 实现 HandlePathUnlockAsync 方法
4. 测试消息收发

### 阶段7: 后台服务
1. 实现 PathLockCleanupService
2. 配置服务参数

### 阶段8: 前端界面
1. 实现召唤小车界面
2. 实现推荐列表对话框
3. 集成API调用

### 阶段9: 集成测试
1. 完整流程测试 (召唤→推荐→确认→执行→完成)
2. 路径冲突测试 (多车同时请求同一路段)
3. 异常场景测试 (取消、超时、失败、死锁)
4. 与硬件团队联调

---

## 八、关键文件清单

### 需要创建的文件

**推荐服务**:
- AgvDispatch.Host/Services/IAgvRecommendationService.cs - 推荐服务接口
- AgvDispatch.Host/Services/AgvRecommendationService.cs - 推荐服务实现
- AgvDispatch.Shared/Models/AgvRecommendation.cs - 推荐结果模型

**路径锁定服务**:
- AgvDispatch.Host/Services/IPathLockService.cs - 路径锁定服务接口
- AgvDispatch.Host/Services/PathLockService.cs - 路径锁定服务实现
- AgvDispatch.Business/Entities/RouteAggregate/TaskRouteCheckpoints.cs - 路径检查点实体
- AgvDispatch.Business/Entities/PathAggregate/TaskPathLocks.cs - 路段锁定实体
- AgvDispatch.Business/Entities/PathAggregate/TaskPathLockLogs.cs - 通行请求日志实体 (可选)

**后台服务**:
- AgvDispatch.Host/BackgroundServices/PathLockCleanupService.cs - 路径锁定清理服务

**DTO类**:
- AgvDispatch.Shared/DTOs/Tasks/SummonAgvRequest.cs - 召唤请求DTO
- AgvDispatch.Shared/DTOs/Tasks/SummonAgvResponse.cs - 召唤响应DTO
- AgvDispatch.Shared/DTOs/Tasks/AssignAgvRequest.cs - 分配请求DTO
- AgvDispatch.Shared/DTOs/Tasks/AgvRecommendationDto.cs - 推荐项DTO
- AgvDispatch.Shared/DTOs/Path/PathLockRequestMessage.cs - 路段锁定请求消息DTO
- AgvDispatch.Shared/DTOs/Path/PathLockResponseMessage.cs - 路段锁定响应消息DTO
- AgvDispatch.Shared/DTOs/Path/PathUnlockMessage.cs - 路段解锁消息DTO

### 需要修改的文件

**实体和枚举**:
- AgvDispatch.Business/Entities/TaskAggregate/Tasks.cs - 新增3个字段
- AgvDispatch.Business/Enums/TaskType.cs - 修改任务类型枚举 (4种)
- AgvDispatch.Business/Enums/CheckpointType.cs - 新增检查点类型枚举 (Start/Middle/End)
- AgvDispatch.Business/Enums/PathLockStatus.cs - 新增锁定状态枚举 (Pending/Approved/Rejected)

**服务和控制器**:
- AgvDispatch.Host/Services/ITaskService.cs - 新增2个方法
- AgvDispatch.Host/Services/TaskService.cs - 实现2个方法
- AgvDispatch.Host/Controllers/TasksController.cs - 新增2个端点
- AgvDispatch.Host/Mqtt/MqttMessageHandler.cs - 新增2个消息处理方法

**配置和注册**:
- AgvDispatch.Host/Program.cs - 注册推荐服务、路径锁定服务、后台服务
- AgvDispatchContext.cs - 新增DbSet (TaskRouteCheckpoints, TaskPathLocks, TaskPathLockLogs)

### 需要删除的文件
- AgvDispatch.Host/BackgroundServices/AutoDispatchService.cs - 自动调度服务 (不再需要)

---

## 九、配置参数说明

| 参数 | 默认值 | 说明 | 配置位置 |
|-----|-------|------|---------|
| **推荐算法** | | | |
| 最低电量要求 | 15% | 推荐时的最低电量阈值 | AgvRecommendationService |
| 推荐列表数量 | 3 | 返回Top N个推荐小车 | AgvRecommendationService |
| 距离权重 | 40% | 综合评分中距离的权重 | AgvRecommendationService |
| 电量权重 | 30% | 综合评分中电量的权重 | AgvRecommendationService |
| 状态权重 | 30% | 综合评分中状态的权重 | AgvRecommendationService |
| **任务超时** | | | |
| 超时检查间隔 | 5分钟 | 检查任务超时的频率 | TaskTimeoutCheckerService |
| 超时阈值 | 30分钟 | 任务执行超过此时间视为超时 | TaskTimeoutCheckerService |
| **路径锁定** | | | |
| 锁定清理间隔 | 1分钟 | 清理过期锁定的频率 | PathLockCleanupService |
| 锁定过期时间 | 10分钟 | 锁定超过此时间自动释放(防死锁) | PathLockService |
| AGV重试间隔 | 5秒 | 路段被拒绝后的重试间隔 | AGV端配置 |
| 请求距离阈值 | 5米 | AGV距离中间点多远时发起锁定请求 | AGV端配置 |
| **MQTT** | | | |
| 任务下发QoS | 1 | 任务下发消息的QoS级别 | MqttBrokerService |
| 锁定请求QoS | 1 | 路径锁定请求的QoS级别 | MqttBrokerService |
| 锁定响应QoS | 1 | 路径锁定响应的QoS级别 | MqttBrokerService |

---

## 十、总结

### 核心变更点

| 维度 | 原方案 | 新方案 |
|-----|-------|-------|
| **调度模式** | 后台自动调度 (每10秒轮询) | 工人手动召唤 (实时响应) |
| **任务分配** | 系统自动分配最优小车 | 系统推荐,工人确认 |
| **任务类型** | 3种 (搬运/充电/返回) | 4种独立步骤 (上料/下料/归位/充电) |
| **推荐算法** | 距离最近优先 | 综合评分 (距离40%+电量30%+状态30%) |
| **响应速度** | 最多延迟10秒 | 确认后立即下发 (零延迟) |
| **后台服务** | AutoDispatchService | 超时检测+路径锁定清理 |
| **工人操作** | 仅创建任务 | 创建+查看推荐+确认分配 |
| **路径管理** | 无冲突控制 | 实时锁定,站点间路段粒度 |
| **适用场景** | 大规模车队,全自动化 | 小规模车队,人工主导 |

### 核心设计特性

**1. 手动调度系统**:
- 工人主动召唤 → 系统智能推荐 → 工人确认 → 立即MQTT下发
- 无后台轮询,响应速度快 (零延迟)
- 工人可控性强,每一步都需人工确认

**2. 智能推荐算法**:
- 综合评分 = 距离分(40%) + 电量分(30%) + 状态分(30%)
- 推荐理由清晰,便于工人决策
- 支持手动切换,灵活性高

**3. 两层路径设计**:
- TaskRouteSegments: Web显示路径,关联地图节点和边,用于可视化
- TaskRouteCheckpoints: AGV对接路径,仅包含关键站点,用于导航

**4. 路径冲突管理**:
- 锁定粒度: 站点间路段 (如 S002→S003)
- 通行控制: AGV实时申请-响应模式
- 冲突处理: 原地等待,定期重试
- 防死锁: 锁定超时自动释放 (默认10分钟)

**5. 实时通行控制**:
- AGV到达中间点前发起锁定请求
- 服务器检查TaskPathLocks表,批准/拒绝
- 被拒绝时原地等待,5秒后重试
- 通过后自动释放上一段锁定

### 优势总结

1. **符合实际场景**: 3辆车、固定路线、人工节拍
2. **响应速度快**: 工人确认后立即下发,无需等待轮询
3. **工人可控性强**: 每一步都需人工确认,避免意外
4. **智能推荐辅助**: 综合评分算法,推荐理由清晰
5. **流程更清晰**: 4步独立任务,对应实际操作流程
6. **系统更简单**: 移除复杂的自动调度逻辑,降低维护成本
7. **路径冲突管理**: 实时锁定机制,避免多车碰撞
8. **可扩展性**: 支持增加更多中间点,灵活控制通行

### 潜在扩展

**短期优化**:
1. 锁定优先级: 紧急任务可以抢占低优先级车辆的锁定
2. 预锁定模式: 任务下发时预锁定整条路径,减少实时请求次数
3. 动态路径规划: 路段被占用时推荐备用路线

**长期扩展**:
1. 自动模式: 保留推荐算法,增加自动确认模式
2. 配置开关: 手动模式 / 自动模式
3. 恢复 AutoDispatchService,复用推荐算法
4. 多路径优化: AI算法优化路径选择

---

本方案完全基于实际场景设计,去除了不必要的复杂性,保留了智能推荐的优势,并增加了路径冲突管理机制,确保工人操作简单、系统响应快速、业务流程清晰、多车运行安全。

---

## 十一、实现任务清单 (TODO)

> **说明**: 本章节将整个方案按功能模块拆分为5个大任务,每个任务完成后提交审核,通过后再进行下一个任务。

---

### 任务1: 手动调度核心功能 (召唤小车+推荐+分配)

**功能说明**: 实现手动调度的核心流程,包括工人召唤小车、系统智能推荐、工人确认分配、MQTT下发任务。

**涉及模块**:
- 数据模型扩展 (Tasks实体、TaskType枚举)
- 推荐服务 (AgvRecommendationService)
- 任务服务扩展 (TaskService)
- API控制器 (TasksController)
- DTO定义

**主要工作内容**:

1. **数据模型**:
   - 扩展Tasks实体,新增字段: RecommendedAgvsJson, AssignedBy, AssignedByName
   - 修改TaskType枚举,定义4种任务类型: CallForLoading(10), SendToUnloading(20), ReturnToWaiting(30), SendToCharge(40)
   - 创建数据库迁移并应用

2. **推荐服务**:
   - 创建AgvRecommendation模型(包含评分详情)
   - 实现IAgvRecommendationService接口
   - 实现AgvRecommendationService服务
   - 综合评分算法: 距离分(40%) + 电量分(30%) + 状态分(30%)
   - 生成推荐理由文本,返回Top 10

3. **任务服务**:
   - 扩展ITaskService接口,新增方法:
     - `SummonAgvAsync`: 召唤小车,创建任务并返回推荐列表
     - `AssignAgvToTaskAsync`: 确认分配,更新任务和小车状态,立即MQTT下发
   - 实现上述方法,包含完整的业务逻辑和事务处理

4. **API控制器**:
   - 创建DTO: SummonAgvRequest, SummonAgvResponse, AssignAgvRequest, AgvRecommendationDto
   - 新增端点: `POST /api/tasks/summon` (召唤小车)
   - 新增端点: `POST /api/tasks/{id}/assign` (确认分配)
   - 参数验证、异常处理、Swagger文档

5. **服务注册**:
   - 注册IAgvRecommendationService到DI容器(Scoped)
   - 更新现有服务注册

**验收标准**:
- ✓ Tasks表新增3个字段,数据库迁移成功
- ✓ TaskType枚举定义正确(4种任务类型)
- ✓ 推荐算法实现正确,评分计算准确
- ✓ 推荐理由文本清晰易懂
- ✓ SummonAgvAsync方法正确创建任务,保存推荐列表JSON
- ✓ AssignAgvToTaskAsync方法正确更新状态,MQTT消息下发成功
- ✓ API端点实现正确,Swagger文档完整
- ✓ 使用Postman/Swagger测试通过完整流程: 召唤 → 推荐 → 分配
- ✓ 单元测试覆盖核心逻辑(推荐算法、任务创建、任务分配)
- ✓ 代码编译通过,无严重警告

**参考公式**:
```csharp
// 距离分 (0-40分)
distanceScore = Math.Max(0, 40 * (1 - distance / 500))

// 电量分 (0-30分)
batteryScore = (battery / 100) * 30
if (battery < minBattery) batteryScore *= 0.5  // 低电量扣分

// 状态分 (0-30分)
statusScore = status == Idle ? 30 : (status == Charging ? 10 : (status == Running ? 5 : 0))

// 总分
totalScore = distanceScore + batteryScore + statusScore
```

---

### 任务2: 路径锁定配置管理页面 (前端+后端API)

**功能说明**: 实现路段锁定配置管理页面,允许管理员配置哪些路段需要AGV提前申请占用权限。

**涉及模块**:
- 后端API (PathSegmentsController)
- 数据模型 (PathSegmentLockConfigs表)
- 前端页面 (路段锁定管理页面)

**主要工作内容**:

1. **后端数据模型**:
   - 创建PathSegmentLockConfigs实体:
     - Id, FromStationCode, ToStationCode
     - IsLockRequired(是否需要锁定)
     - LockReason(锁定理由描述)
     - TimeoutMinutes(超时时间,默认10分钟)
     - Priority(优先级,可选)
     - IsActive(是否启用)
   - 配置唯一索引: (FromStationCode, ToStationCode)
   - 创建数据库迁移并应用

2. **后端API**:
   - 创建PathSegmentsController
   - 实现端点:
     - `GET /api/path-segments/lock-configs` - 获取所有路段锁定配置
     - `GET /api/path-segments/lock-configs/:id` - 获取单个配置
     - `POST /api/path-segments/lock-configs` - 新增配置
     - `PUT /api/path-segments/lock-configs/:id` - 更新配置
     - `DELETE /api/path-segments/lock-configs/:id` - 删除配置
     - `GET /api/path-segments/lock-configs/reverse?from=S002&to=S003` - 查询反向路段配置
   - 创建DTO: PathSegmentLockConfigDto, CreatePathSegmentLockConfigRequest, UpdatePathSegmentLockConfigRequest
   - 实现服务: IPathSegmentLockConfigService, PathSegmentLockConfigService
   - 业务逻辑:
     - 新增时检查路段是否已存在
     - 删除时检查是否有正在使用该路段的任务
     - 支持同时创建反向路段配置

3. **前端页面**:
   - 创建路段锁定管理页面
   - 界面布局:
     - 路段列表表格(起始站点、目标站点、路段方向、是否需要锁定、锁定理由、操作)
     - 筛选器: 全部路段/需要锁定/起始站点/目标站点
     - "新增路段配置"按钮
   - 新增/编辑对话框:
     - 起始站点下拉框(从Stations表读取)
     - 目标站点下拉框(从Stations表读取)
     - 路段方向显示(自动: 起始 → 目标)
     - 是否需要锁定复选框
     - 锁定理由文本框
     - 锁定超时时间输入框(默认10分钟)
     - 反向路段配置选项(可选同时创建反向路段,可选反向路段是否也需要锁定)
   - 功能实现:
     - 列表查询和渲染(支持筛选)
     - 新增路段配置(表单验证)
     - 编辑路段配置
     - 删除路段配置(确认提示)
     - 显示反向路段配置状态

4. **数据初始化**:
   - 准备典型配置案例数据(如狭窄通道、交叉路口等)
   - 提供SQL脚本或种子数据

**验收标准**:
- ✓ PathSegmentLockConfigs表创建成功,唯一索引生效
- ✓ 后端API实现正确:
  - 所有端点测试通过(使用Postman/Swagger)
  - 业务逻辑准确(重复检查、删除检查等)
  - 异常处理完善
- ✓ 前端页面实现正确:
  - 界面布局美观,符合设计要求
  - 列表查询和渲染正确
  - 新增/编辑/删除功能正常
  - 表单验证完善
  - 反向路段配置功能正常
- ✓ 浏览器测试通过(增删改查完整流程)
- ✓ 路段配置生效,影响AGV路段锁定申请逻辑
- ✓ 权限控制: 仅管理员可访问
- ✓ 代码编译通过,无严重警告

**典型配置示例**:
```
S002 → S003 (进入狭窄通道): 需要锁定 ✓  "进入狭窄通道,宽度仅容单车"
S003 → S002 (离开狭窄通道): 不需要锁定 ✗  "离开通道,空间充足"
S001 → S002 (进入交叉路口): 需要锁定 ✓  "多条路线汇集,易冲突"
S005 → S007 (90度转弯): 需要锁定 ✓  "转弯速度慢,易堵塞"
```

---

### 任务3: 路径锁定功能 (后端服务+MQTT消息处理)

**功能说明**: 实现路径锁定机制,防止多车路径冲突,包括路径检查点、锁定服务、MQTT消息处理。

**涉及模块**:
- 数据模型 (路径检查点、路径锁定实体)
- 路径锁定服务 (PathLockService)
- 后台清理服务 (PathLockCleanupService)
- MQTT消息处理 (路径锁定请求/响应/解锁)

**主要工作内容**:

1. **数据模型**:
   - 创建枚举: CheckpointType(Start/Middle/End), PathLockStatus(Pending/Approved/Rejected/Timeout)
   - 创建TaskRouteCheckpoints实体(路径检查点): Id, RouteId, Seq, StationCode, CheckpointType, IsLockRequired, Description
   - 创建TaskPathLocks实体(路径锁定): Id, FromStationCode, ToStationCode, LockedByAgvId, LockedByAgvCode, TaskId, LockedAt, ExpireAt
   - 创建TaskPathLockLogs实体(可选,审计日志): Id, AgvId, TaskId, FromStationCode, ToStationCode, RequestTime, ApprovedTime, Status, WaitDuration, RejectedReason
   - 配置唯一索引: (FromStationCode, ToStationCode)
   - 创建数据库迁移并应用

2. **路径锁定服务**:
   - 创建IPathLockService接口,定义方法:
     - `TryLockPathSegmentAsync`: 尝试锁定路段,返回是否成功+占用者信息
     - `UnlockPathSegmentAsync`: 解锁路段
     - `GetLockedSegmentsByAgvAsync`: 获取小车占用的所有路段
     - `CleanupExpiredLocksAsync`: 清理过期锁定
   - 实现PathLockService服务:
     - 锁定逻辑: 检查路段是否已锁定,创建/更新锁定记录
     - 并发处理: 使用数据库事务或锁机制
     - 日志记录: 记录到TaskPathLockLogs(如果启用)

3. **后台清理服务**:
   - 创建PathLockCleanupService,继承BackgroundService
   - 每1分钟执行一次CleanupExpiredLocksAsync
   - 删除ExpireAt < Now的锁定记录
   - 记录清理日志

4. **MQTT消息处理**:
   - 创建DTO: PathLockRequestMessage, PathLockResponseMessage, PathUnlockMessage
   - 修改TaskAssignMessage,新增Checkpoints字段(包含检查点列表)
   - 实现HandlePathLockRequestAsync:
     - Topic: `agv/{agvCode}/path/lock-request`
     - 调用TryLockPathSegmentAsync
     - 根据结果发送响应(Approved/Rejected)
   - 实现HandlePathUnlockAsync:
     - Topic: `agv/{agvCode}/path/unlock`
     - 调用UnlockPathSegmentAsync
   - 更新任务下发消息,包含Checkpoints数据

5. **服务注册**:
   - 注册IPathLockService到DI容器(Scoped)
   - 注册PathLockCleanupService到DI容器(HostedService)

**验收标准**:
- ✓ 数据库表创建成功,唯一索引生效
- ✓ PathLockService实现正确,锁定逻辑准确
- ✓ 并发测试通过,无竞态条件和死锁
- ✓ PathLockCleanupService后台服务运行正常,定时清理过期锁定
- ✓ MQTT消息处理正确:
  - 锁定请求/响应测试通过(使用MQTT客户端工具)
  - 解锁消息处理测试通过
  - 任务下发消息包含Checkpoints数据
- ✓ 单元测试覆盖核心逻辑(至少5个测试用例)
- ✓ 日志记录完整(如果启用TaskPathLockLogs)
- ✓ 代码编译通过,无严重警告

---

### 任务4: 召唤小车操作界面 (前端)

**功能说明**: 实现工人召唤小车的操作界面,包括召唤页面和推荐列表对话框。

**涉及模块**:
- 召唤小车页面
- 推荐列表对话框组件

**主要工作内容**:

1. **召唤小车页面**:
   - 创建召唤小车页面/组件
   - 界面元素:
     - 任务类型选择器(4个按钮,带图标):
       - 召唤小车上料
       - 告知小车去下料
       - 确认下料去等待区
       - 让小车充电
     - 目标站点下拉框(从Stations表读取,显示: S001-上料点A)
     - 路线选择器(可选,根据任务类型+站点自动匹配)
     - "召唤小车"按钮
   - 交互逻辑:
     - 选择任务类型(高亮显示)
     - 选择目标站点
     - 自动匹配路线(可手动切换)
     - 点击"召唤小车" → 调用API: `POST /api/tasks/summon`
     - 弹出推荐列表对话框
   - 错误处理:
     - 站点列表为空时提示
     - 路线不存在时提示
     - API调用失败时提示

2. **推荐列表对话框**:
   - 创建推荐列表对话框组件
   - 界面布局:
     - 标题: "选择小车 (系统智能推荐)"
     - 推荐列表(最多3个推荐项):
       - 第一名带⭐标记,突出显示
       - 每个推荐项显示:
         - 小车编号(如: [V001] AGV小车001)
         - 距离(如: 50cm)
         - 电量(如: 80%)
         - 状态(如: 空闲/执行中/充电中)
         - 推荐理由(如: "距离很近, 电量充足, 空闲可用")
         - 综合评分(如: 85.5分)
         - "选择"按钮(第一名默认选中)
     - 底部操作按钮:
       - "取消"按钮
       - "确认派遣"按钮
   - 交互逻辑:
     - 默认选中第一名(系统推荐)
     - 可点击其他小车切换选择
     - 点击"确认派遣":
       - 调用API: `POST /api/tasks/{id}/assign`
       - 关闭对话框
       - 显示成功提示: "任务已下发至 V001"
     - 点击"取消":
       - 关闭对话框
       - 可选: 删除Pending状态的任务或标记为Cancelled
   - 异常处理:
     - 推荐列表为空时提示: "当前无可用小车"
     - API调用失败时提示

3. **样式设计**:
   - 响应式布局,支持桌面和触摸屏
   - 清晰的视觉层次(推荐第一名突出)
   - 友好的交互反馈(按钮状态、加载动画)

**验收标准**:
- ✓ 召唤小车页面实现正确:
  - 界面布局美观,符合设计要求
  - 任务类型选择器正常
  - 目标站点下拉框正常(显示站点编号+名称)
  - 路线自动匹配正确
  - API调用成功
- ✓ 推荐列表对话框实现正确:
  - 界面布局美观,推荐项清晰
  - 第一名突出显示,带⭐标记
  - 推荐信息渲染正确(距离、电量、状态、理由、评分)
  - 默认选中第一名
  - 切换选择功能正常
  - 确认派遣API调用成功
  - 成功提示显示正确
- ✓ 错误处理完善:
  - 站点列表为空时提示
  - 推荐列表为空时提示
  - API调用失败时提示
- ✓ 浏览器测试通过(Chrome, Edge, 触摸屏设备)
- ✓ 完整流程测试通过: 选择任务类型 → 选择站点 → 召唤 → 查看推荐 → 确认派遣 → 成功提示
- ✓ 代码质量良好,符合项目代码规范

---

### 任务5: 集成测试与部署上线

**功能说明**: 进行完整的集成测试,包括端到端测试、并发测试、异常测试、性能优化,最后部署到生产环境并与硬件团队联调。

**涉及模块**:
- 集成测试
- 性能优化
- 生产环境部署
- 硬件联调

**主要工作内容**:

1. **端到端测试**:
   - 测试完整流程: 召唤 → 推荐 → 确认 → MQTT下发 → 进度上报 → 完成
   - 测试场景:
     1. 工人召唤小车上料(选择站点S001)
     2. 系统推荐3辆小车
     3. 工人选择第一名确认
     4. MQTT消息成功下发(检查消息格式)
     5. 模拟小车上报进度(Executing状态)
     6. 模拟小车完成任务(Completed状态)
     7. 小车状态恢复Idle
   - 验证点:
     - 任务状态流转正确: Pending → Assigned → Executing → Completed
     - 小车状态流转正确: Idle → Running → Idle
     - 推荐列表准确(评分计算正确)
     - MQTT消息格式正确(包含Checkpoints数据)
     - 数据库记录正确
     - 日志记录完整

2. **路径冲突并发测试**:
   - 测试场景:
     1. V001和V002同时请求锁定路段S002→S003
     2. 验证只有一辆车获得锁定
     3. 另一辆车收到Rejected响应
     4. 模拟被拒绝的车等待5秒后重试
     5. 第一辆车通过后释放锁定
     6. 第二辆车重试成功,获得锁定
   - 验证点:
     - 唯一索引约束生效
     - 锁定状态正确(TaskPathLocks表数据)
     - 日志记录完整(TaskPathLockLogs表数据)
     - 无死锁和竞态条件
   - 使用工具: MQTT客户端模拟多车并发请求

3. **异常场景测试**:
   - 测试场景:
     1. **取消任务**: 工人召唤后点击取消,任务状态变为Cancelled
     2. **任务超时**: 任务执行超过30分钟,触发超时告警
     3. **任务失败**: 小车上报Failed状态,小车资源释放
     4. **锁定超时**: 锁定超过10分钟自动释放(PathLockCleanupService)
     5. **小车离线**: 任务执行中小车离线,任务失败
     6. **推荐列表为空**: 所有小车离线,推荐列表为空,前端提示
   - 验证点:
     - 异常处理逻辑正确
     - 资源释放及时(小车状态、路径锁定)
     - 错误消息清晰
     - 日志记录完整

4. **性能优化**:
   - 推荐算法查询优化:
     - 添加数据库索引(Agv.Status, Agv.Battery, Agv.LastOnlineTime)
     - 减少N+1查询
   - 路径锁定查询优化:
     - 添加索引(TaskPathLocks.FromStationCode, ToStationCode)
     - 考虑缓存热点路段配置
   - MQTT消息处理优化:
     - 异步处理,不阻塞主线程
     - 批量处理(如果消息量大)
   - 性能测试:
     - 推荐响应时间 < 500ms
     - MQTT下发时间 < 100ms
     - 路径锁定响应时间 < 200ms

5. **代码审查**:
   - 代码规范检查(使用工具: StyleCop, ReSharper)
   - 异常处理完善
   - 日志记录完整
   - 单元测试覆盖率(目标80%+)
   - 注释和文档更新

6. **生产环境部署准备**:
   - 配置文件准备:
     - 生产环境appsettings.json
     - MQTT连接配置(Broker地址、端口、认证)
     - 数据库连接字符串
     - 日志级别调整(Info/Warning)
   - 数据准备:
     - 生产数据库迁移(dotnet ef database update)
     - 基础数据初始化: 站点、路线、检查点、路段锁定配置
   - 部署检查:
     - 服务启动正常
     - 后台服务运行正常(PathLockCleanupService, TaskTimeoutCheckerService)
     - MQTT连接成功
     - 数据库连接正常
     - 健康检查通过

7. **与硬件团队联调**:
   - MQTT消息联调:
     - 任务下发消息格式确认(包含Checkpoints字段)
     - 检查点数据格式确认(seq, stationCode, type, needLock)
     - 路径锁定请求/响应格式确认
     - 进度上报消息格式确认
   - 实际场景测试:
     - 真实小车接收任务并执行
     - 真实小车上报进度
     - 真实小车申请路段锁定(测试通过/被拒绝场景)
     - 多车协同测试(2-3辆车同时运行)
   - 问题修复:
     - 消息格式调整
     - 协议细节优化
     - 异常处理完善

**验收标准**:
- ✓ 端到端测试通过:
  - 完整流程无异常
  - 数据库记录正确
  - 日志记录完整
- ✓ 路径冲突并发测试通过:
  - 无死锁和竞态条件
  - 锁定逻辑正确
  - 日志完整
- ✓ 异常场景测试通过:
  - 所有异常场景测试通过
  - 无资源泄漏
  - 错误提示准确
- ✓ 性能测试通过:
  - 推荐响应 < 500ms
  - MQTT下发 < 100ms
  - 路径锁定响应 < 200ms
- ✓ 代码审查通过:
  - 代码质量良好(无严重警告)
  - 单元测试覆盖率 ≥ 80%
  - 文档更新完整
- ✓ 生产环境部署成功:
  - 配置文件准确
  - 数据库迁移成功
  - 服务启动正常
  - 健康检查通过
- ✓ 硬件联调成功:
  - MQTT消息格式双方确认
  - 真实小车测试通过
  - 多车协同运行正常
  - 无通信异常

---

## 任务执行说明

### 工作流程
1. **AI开发**: 按照任务顺序逐个实现功能
2. **代码提交**: 每完成一个任务,提交代码并标注任务编号
3. **人工审核**: 您审核代码,确认验收标准
4. **反馈修改**: 如有问题,AI根据反馈修改
5. **进入下一个**: 审核通过后,进入下一个任务

### 任务依赖关系
- **任务1** 是核心,必须首先完成
- **任务2** 可以独立开发(路段锁定配置管理,基础数据)
- **任务3** 依赖任务2 (需要路段锁定配置数据)
- **任务4** 依赖任务1 (需要API端点)
- **任务5** 必须在所有功能开发完成后进行

### 建议执行顺序
1. 任务1: 手动调度核心功能 (优先级最高,核心功能)
2. 任务4: 召唤小车操作界面 (前端,可快速验证任务1)
3. 任务2: 路径锁定配置管理页面 (基础数据管理)
4. 任务3: 路径锁定功能 (后端核心功能,依赖任务2的配置数据)
5. 任务5: 集成测试与部署上线 (最后)

### 时间估算 (仅供参考)
- 任务1: 2-3天
- 任务2: 2-3天
- 任务3: 1-2天
- 任务4: 1-2天
- 任务5: 2-3天
- **总计**: 约8-13天 (实际时间根据审核和修改调整)

### 注意事项
1. 每个任务是一个完整的功能模块,可以独立审核
2. 任务内部可以分多次提交,但最终要完成所有验收标准
3. 遇到问题及时沟通,避免返工
4. 代码提交前自测,确保编译通过
5. 单元测试覆盖核心逻辑
6. 文档和注释保持更新

---
