# AGVè°ƒåº¦ç³»ç»ŸæŠ€æœ¯æ–¹æ¡ˆ

> ç‰ˆæœ¬: v1.5
> æ—¥æœŸ: 2026-01-04
> çŠ¶æ€: å¾…è¯„å®¡

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

å»ºè®¾ä¸€å¥—AGVå°è½¦è°ƒåº¦ç³»ç»Ÿï¼Œå®žçŽ°å¯¹3è¾†AGVå°è½¦çš„ç»Ÿä¸€è°ƒåº¦ç®¡ç†ã€‚ç³»ç»ŸåŒ…å«ä¸­å¤®è°ƒåº¦æœåŠ¡ã€çŽ°åœºè°ƒåº¦ç•Œé¢ã€ç§»åŠ¨ç«¯APPä¸‰ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†ã€‚

### 1.2 ç³»ç»Ÿæž¶æž„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              é˜¿é‡Œäº‘æœåŠ¡å™¨                                  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  AGVä¸­å¤®è°ƒåº¦æœåŠ¡ (ASP.NET Core 8)                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚   REST API   â”‚  â”‚ å†…åµŒ MQTT    â”‚  â”‚       è°ƒåº¦å¼•æ“Ž          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  Web/APPè°ƒç”¨  â”‚  â”‚ Broker:1883  â”‚  â”‚   ä»»åŠ¡åˆ†é…/è·¯çº¿é€‰æ‹©     â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚         â”‚                 â”‚                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚                        æ•°æ®åº“                               â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â–²                    â”‚                                           â”‚
â”‚         â”‚ HTTP               â”‚ MQTT                                      â”‚
â”‚         â”‚                    â–¼                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
          â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
          â”‚            â”‚   AGVå°è½¦x3   â”‚
          â”‚            â”‚   (æ ‘èŽ“æ´¾)    â”‚
          â”‚            â”‚   ç¡¬ä»¶å›¢é˜Ÿ    â”‚
          â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ HTTP (è½®è¯¢)               â”‚ HTTP (è½®è¯¢)
    â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çŽ°åœºè°ƒåº¦ç•Œé¢  â”‚        â”‚   å®‰å“APP     â”‚
â”‚  (Blazor Web) â”‚        â”‚  (Avalonia)   â”‚
â”‚   è½¯ä»¶å›¢é˜Ÿ     â”‚        â”‚   è½¯ä»¶å›¢é˜Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 é€šä¿¡æ–¹å¼åˆ†å·¥

| ç»ˆç«¯ | åè®® | ç”¨é€” |
|------|------|------|
| **AGVå°è½¦** | MQTT | å®žæ—¶åŒå‘é€šä¿¡ï¼šçŠ¶æ€ä¸ŠæŠ¥ã€æŽ¥æ”¶ä»»åŠ¡/æŒ‡ä»¤ |
| **Webç•Œé¢** | HTTP | æŸ¥è¯¢æ•°æ®ã€åˆ›å»ºä»»åŠ¡ã€è½®è¯¢çŠ¶æ€ |
| **å®‰å“APP** | HTTP | æŸ¥è¯¢æ•°æ®ã€åˆ›å»ºä»»åŠ¡ã€è½®è¯¢çŠ¶æ€ |

### 1.4 é€‰æ‹© MQTT çš„åŽŸå› ï¼ˆå°è½¦é€šä¿¡ï¼‰

- **IoT é¢†åŸŸæ ‡å‡†åè®®**ï¼šç¡¬ä»¶å›¢é˜Ÿç†Ÿæ‚‰ï¼Œæœ‰æˆç†Ÿçš„å®¢æˆ·ç«¯åº“
- **å†…ç½®å¯é æ€§**ï¼šQoS æœºåˆ¶ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±
- **æ–­çº¿é‡è¿ž**ï¼šåè®®å±‚æ”¯æŒï¼Œæ— éœ€é¢å¤–å¼€å‘
- **ç¦»çº¿æ¶ˆæ¯**ï¼šå°è½¦ç¦»çº¿æœŸé—´çš„ä»»åŠ¡å¯æš‚å­˜ï¼Œä¸Šçº¿åŽè‡ªåŠ¨æŽ¨é€
- **å¼±ç½‘å‹å¥½**ï¼šä¸“ä¸ºä¸ç¨³å®šç½‘ç»œè®¾è®¡ï¼Œé€‚åˆå·¥åŽ‚çŽ¯å¢ƒ
- **ä½Žå¸¦å®½**ï¼šåè®®å¤´ä»… 2 å­—èŠ‚ï¼Œé€‚åˆåµŒå…¥å¼è®¾å¤‡

---

## äºŒã€å›¢é˜Ÿåˆ†å·¥

### 2.1 è½¯ä»¶å›¢é˜ŸèŒè´£

| æ¨¡å— | è¯´æ˜Ž | äº¤ä»˜ç‰© |
|------|------|--------|
| ä¸­å¤®è°ƒåº¦æœåŠ¡ | éƒ¨ç½²äºŽé˜¿é‡Œäº‘ï¼Œå†…åµŒ MQTT Brokerï¼Œæä¾›è°ƒåº¦æ ¸å¿ƒé€»è¾‘ | å¯éƒ¨ç½²çš„æœåŠ¡ç¨‹åº |
| çŽ°åœºè°ƒåº¦ç•Œé¢ | Webåº”ç”¨ï¼Œç”¨äºŽçŽ°åœºæ“ä½œäººå‘˜ä½¿ç”¨ | Blazor Webåº”ç”¨ |
| å®‰å“APP | ç§»åŠ¨ç«¯åº”ç”¨ï¼Œç”¨äºŽç§»åŠ¨æŸ¥çœ‹å’Œæ“ä½œ | APKå®‰è£…åŒ… |
| é€šä¿¡åè®® | å®šä¹‰ MQTT Topic å’Œæ¶ˆæ¯æ ¼å¼ | åè®®æ–‡æ¡£ + ç¤ºä¾‹ä»£ç  |
| æ¨¡æ‹Ÿå™¨ | ç”¨äºŽè”è°ƒçš„å°è½¦æ¨¡æ‹Ÿç¨‹åº | æŽ§åˆ¶å°æ¨¡æ‹Ÿç¨‹åº |

### 2.2 ç¡¬ä»¶å›¢é˜ŸèŒè´£

| æ¨¡å— | è¯´æ˜Ž | äº¤ä»˜ç‰© |
|------|------|--------|
| å°è½¦æŽ§åˆ¶ç¨‹åº | è¿è¡ŒäºŽæ ‘èŽ“æ´¾ï¼ŒæŽ§åˆ¶å°è½¦è¿åŠ¨ | æ ‘èŽ“æ´¾ç¨‹åº |
| MQTT å®¢æˆ·ç«¯ | å¯¹æŽ¥ MQTT Brokerï¼Œæ”¶å‘æ¶ˆæ¯ | é›†æˆåˆ°æŽ§åˆ¶ç¨‹åº |
| é¿éšœç³»ç»Ÿ | ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ä¸Žé¿éšœé€»è¾‘ | é›†æˆåˆ°æŽ§åˆ¶ç¨‹åº |
| è·¯çº¿æ‰§è¡Œ | æŒ‰æœåŠ¡å™¨ä¸‹å‘çš„è·¯çº¿è¡Œé©¶ | é›†æˆåˆ°æŽ§åˆ¶ç¨‹åº |

### 2.3 èŒè´£è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è½¯ä»¶å›¢é˜Ÿè´Ÿè´£                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ä¸­å¤®è°ƒåº¦æœåŠ¡ï¼ˆå†…åµŒ MQTT Brokerï¼‰                              â”‚
â”‚  â€¢ ä»»åŠ¡åˆ›å»ºã€åˆ†é…ã€è°ƒåº¦                                          â”‚
â”‚  â€¢ è·¯çº¿é€‰æ‹©ï¼ˆé€‰æ‹©å“ªè¾†è½¦èµ°å“ªæ¡è·¯çº¿ï¼‰                               â”‚
â”‚  â€¢ å°è½¦çŠ¶æ€ç›‘æŽ§ä¸Žå±•ç¤º                                            â”‚
â”‚  â€¢ åŽ†å²è®°å½•å­˜å‚¨ä¸ŽæŸ¥è¯¢                                            â”‚
â”‚  â€¢ æä¾›é€šä¿¡åè®®åŠå¯¹æŽ¥æ”¯æŒ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ MQTT åè®®
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç¡¬ä»¶å›¢é˜Ÿè´Ÿè´£                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ è¿žæŽ¥ MQTT Brokerï¼Œè®¢é˜…/å‘å¸ƒç›¸å…³ Topic                        â”‚
â”‚  â€¢ ä¸ŠæŠ¥å°è½¦çŠ¶æ€ï¼ˆä½ç½®ã€ç”µé‡ã€è¿è¡ŒçŠ¶æ€ï¼‰                           â”‚
â”‚  â€¢ æŽ¥æ”¶å¹¶æ‰§è¡Œä»»åŠ¡æŒ‡ä»¤                                            â”‚
â”‚  â€¢ è·¯çº¿æ‰§è¡Œï¼ˆæŒ‰è·¯å¾„ç‚¹è¡Œé©¶ï¼‰                                      â”‚
â”‚  â€¢ é¿éšœå¤„ç†ï¼ˆä¼ æ„Ÿå™¨æ£€æµ‹ + åœè½¦/ç»•éšœï¼‰                            â”‚
â”‚  â€¢ å¼‚å¸¸ä¸ŠæŠ¥ï¼ˆæ•…éšœã€æ€¥åœç­‰ï¼‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 åä½œæµç¨‹

```
é˜¶æ®µ1: åè®®ç¡®è®¤
  è½¯ä»¶å›¢é˜Ÿ â”€â”€æä¾›åè®®æ–‡æ¡£â”€â”€â–¶ ç¡¬ä»¶å›¢é˜Ÿ
  ç¡¬ä»¶å›¢é˜Ÿ â”€â”€ç¡®è®¤/åé¦ˆâ”€â”€â”€â”€â–¶ è½¯ä»¶å›¢é˜Ÿ
  åŒæ–¹ â”€â”€â”€â”€â”€â”€ åè®®å®šç¨¿ â”€â”€â”€â”€â”€â”€

é˜¶æ®µ2: å¹¶è¡Œå¼€å‘
  è½¯ä»¶å›¢é˜Ÿ: éƒ¨ç½²Broker + å¼€å‘æœåŠ¡å™¨ + ç•Œé¢ + æ¨¡æ‹Ÿå™¨
  ç¡¬ä»¶å›¢é˜Ÿ: å¼€å‘å°è½¦æŽ§åˆ¶ç¨‹åº

é˜¶æ®µ3: è”è°ƒæµ‹è¯•
  è½¯ä»¶å›¢é˜Ÿ â”€â”€æä¾›æµ‹è¯•çŽ¯å¢ƒâ”€â”€â–¶ ç¡¬ä»¶å›¢é˜Ÿ
  åŒæ–¹ â”€â”€â”€â”€â”€â”€ è”è°ƒå¯¹æŽ¥ â”€â”€â”€â”€â”€â”€

é˜¶æ®µ4: çŽ°åœºéƒ¨ç½²
  åŒæ–¹ â”€â”€â”€â”€â”€â”€ çŽ°åœºè°ƒè¯• â”€â”€â”€â”€â”€â”€
```

---

## ä¸‰ã€é€šä¿¡åè®®è§„èŒƒ

### 3.1 é€šä¿¡æ–¹å¼

- **åè®®**: MQTT v5.0
- **æ•°æ®æ ¼å¼**: JSON
- **ç¼–ç **: UTF-8

### 3.2 è¿žæŽ¥ä¿¡æ¯ï¼ˆå°è½¦ â†’ MQTT Brokerï¼‰

| çŽ¯å¢ƒ | åœ°å€ | ç«¯å£ |
|------|------|------|
| ç”Ÿäº§çŽ¯å¢ƒ | {æœåŠ¡å™¨åŸŸå} | 1883 (TCP) / 8883 (TLS) |
| æµ‹è¯•çŽ¯å¢ƒ | {æœåŠ¡å™¨IP} | 1883 (TCP) |

### 3.3 è¿žæŽ¥è®¤è¯

| å‚æ•° | è¯´æ˜Ž |
|------|------|
| Client ID | å°è½¦å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ `AGV001` |
| Username | å°è½¦IDï¼Œå¦‚ `AGV001` |
| Password | è®¤è¯ä»¤ç‰Œï¼Œç”±è½¯ä»¶å›¢é˜Ÿé¢„å…ˆåˆ†é… |
| Clean Session | `false`ï¼ˆä¿ç•™ä¼šè¯ï¼Œæ”¯æŒç¦»çº¿æ¶ˆæ¯ï¼‰ |

### 3.4 QoS çº§åˆ«è¯´æ˜Ž

| QoS | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|-----|------|----------|
| 0 | æœ€å¤šä¸€æ¬¡ï¼Œå¯èƒ½ä¸¢å¤± | å¿ƒè·³ã€é«˜é¢‘çŠ¶æ€ä¸ŠæŠ¥ |
| 1 | è‡³å°‘ä¸€æ¬¡ï¼Œç¡®ä¿é€è¾¾ | ä»»åŠ¡ä¸‹å‘ã€å¼‚å¸¸ä¸ŠæŠ¥ |
| 2 | æ°å¥½ä¸€æ¬¡ï¼Œä¸é‡å¤ | æš‚ä¸ä½¿ç”¨ |

### 3.5 å¿ƒè·³æœºåˆ¶

- **Keep Alive**: 60 ç§’ï¼ˆMQTT åè®®å±‚å¿ƒè·³ï¼Œå®¢æˆ·ç«¯åº“è‡ªåŠ¨å¤„ç†ï¼‰
- **çŠ¶æ€ä¸ŠæŠ¥**: æ¯ 5 ç§’å‘å¸ƒä¸€æ¬¡çŠ¶æ€æ¶ˆæ¯
- **ç¦»çº¿æ£€æµ‹**: æœåŠ¡å™¨è®°å½•æ¯è¾†è½¦æœ€åŽä¸ŠæŠ¥æ—¶é—´ï¼Œè¶…è¿‡ 15 ç§’æœªæ”¶åˆ°çŠ¶æ€åˆ™æ ‡è®°ä¸ºç¦»çº¿

---

## å››ã€Topic è®¾è®¡

### 4.1 Topic ç»“æž„

```
agv/{agvCode}/status          # å°è½¦ â†’ æœåŠ¡å™¨ï¼šçŠ¶æ€ä¸ŠæŠ¥
agv/{agvCode}/task/assign     # æœåŠ¡å™¨ â†’ å°è½¦ï¼šä»»åŠ¡ä¸‹å‘
agv/{agvCode}/task/cancel     # æœåŠ¡å™¨ â†’ å°è½¦ï¼šå–æ¶ˆä»»åŠ¡
agv/{agvCode}/task/progress   # å°è½¦ â†’ æœåŠ¡å™¨ï¼šä»»åŠ¡è¿›åº¦
agv/{agvCode}/command         # æœåŠ¡å™¨ â†’ å°è½¦ï¼šæŽ§åˆ¶æŒ‡ä»¤
agv/{agvCode}/command/ack     # å°è½¦ â†’ æœåŠ¡å™¨ï¼šæŒ‡ä»¤åº”ç­”
agv/{agvCode}/exception       # å°è½¦ â†’ æœåŠ¡å™¨ï¼šå¼‚å¸¸ä¸ŠæŠ¥
```

### 4.2 Topic è®¢é˜…å…³ç³»

**å°è½¦ç«¯è®¢é˜…ï¼š**
```
agv/{è‡ªå·±çš„agvId}/task/assign    # QoS 1
agv/{è‡ªå·±çš„agvId}/task/cancel    # QoS 1
agv/{è‡ªå·±çš„agvId}/command        # QoS 1
```

**æœåŠ¡å™¨è®¢é˜…ï¼š**
```
agv/+/status          # æ‰€æœ‰å°è½¦çŠ¶æ€
agv/+/task/progress   # æ‰€æœ‰ä»»åŠ¡è¿›åº¦
agv/+/command/ack     # æ‰€æœ‰æŒ‡ä»¤åº”ç­”
agv/+/exception       # æ‰€æœ‰å¼‚å¸¸
```

### 4.3 Topic ä¸Ž QoS å¯¹ç…§è¡¨

| Topic | æ–¹å‘ | QoS | Retain | è¯´æ˜Ž |
|-------|------|-----|--------|------|
| `agv/{id}/status` | å°è½¦â†’æœåŠ¡å™¨ | 0 | true | é«˜é¢‘ä¸ŠæŠ¥ï¼Œå…è®¸ä¸¢å¤± |
| `agv/{id}/task/assign` | æœåŠ¡å™¨â†’å°è½¦ | 1 | false | ä»»åŠ¡å¿…è¾¾ |
| `agv/{id}/task/cancel` | æœåŠ¡å™¨â†’å°è½¦ | 1 | false | å–æ¶ˆå¿…è¾¾ |
| `agv/{id}/task/progress` | å°è½¦â†’æœåŠ¡å™¨ | 1 | false | è¿›åº¦å¿…è¾¾ |
| `agv/{id}/command` | æœåŠ¡å™¨â†’å°è½¦ | 1 | false | æŒ‡ä»¤å¿…è¾¾ |
| `agv/{id}/command/ack` | å°è½¦â†’æœåŠ¡å™¨ | 1 | false | åº”ç­”å¿…è¾¾ |
| `agv/{id}/exception` | å°è½¦â†’æœåŠ¡å™¨ | 1 | false | å¼‚å¸¸å¿…è¾¾ |

---

## äº”ã€æ¶ˆæ¯æ ¼å¼å®šä¹‰

### 5.1 æžšä¸¾å®šä¹‰

```csharp
// å°è½¦è¿è¡ŒçŠ¶æ€
public enum AgvStatus
{
    Offline = 0,      // ç¦»çº¿
    Idle = 1,         // ç©ºé—²
    Running = 2,      // æ‰§è¡Œä»»åŠ¡ä¸­
    Charging = 3,     // å……ç”µä¸­
    Error = 4,        // æ•…éšœ
    Paused = 5        // æš‚åœ
}

// ä»»åŠ¡çŠ¶æ€
public enum TaskStatus
{
    Pending = 0,      // å¾…åˆ†é…
    Assigned = 1,     // å·²åˆ†é…ï¼ˆå·²ä¸‹å‘ï¼Œå¾…æ‰§è¡Œï¼‰
    Executing = 2,    // æ‰§è¡Œä¸­
    Completed = 3,    // å·²å®Œæˆ
    Cancelled = 4,    // å·²å–æ¶ˆ
    Failed = 5        // å¤±è´¥
}

// ä»»åŠ¡ç±»åž‹
public enum TaskType
{
    Transport = 1,    // æ¬è¿ä»»åŠ¡
    Charge = 2,       // å……ç”µä»»åŠ¡
    Return = 3        // è¿”å›žå¾…å‘½ç‚¹
}

// æŽ§åˆ¶æŒ‡ä»¤ç±»åž‹
public enum CommandType
{
    Pause = 1,        // æš‚åœ
    Resume = 2,       // ç»§ç»­
    Stop = 3,         // æ€¥åœ
    ReturnHome = 4    // è¿”å›žå¾…å‘½ç‚¹
}

// å¼‚å¸¸ç±»åž‹
public enum ExceptionType
{
    ObstacleDetected = 1,   // æ£€æµ‹åˆ°éšœç¢ç‰©
    LowBattery = 2,         // ä½Žç”µé‡
    MotorError = 3,         // ç”µæœºæ•…éšœ
    SensorError = 4,        // ä¼ æ„Ÿå™¨æ•…éšœ
    NetworkError = 5,       // ç½‘ç»œå¼‚å¸¸
    EmergencyStop = 6,      // æ€¥åœæŒ‰é’®è§¦å‘
    Other = 99              // å…¶ä»–
}
```

---

### 5.2 æ¶ˆæ¯è¯¦ç»†å®šä¹‰

#### 5.2.1 çŠ¶æ€ä¸ŠæŠ¥ (agv/{agvCode}/status)

å°è½¦å®šæ—¶ï¼ˆæ¯5ç§’ï¼‰æˆ–çŠ¶æ€å˜åŒ–æ—¶å‘å¸ƒã€‚

**Payload:**
```json
{
  "agvId": "AGV001",
  "timestamp": "2026-01-04T10:00:05Z",
  "status": 2,
  "battery": 85,
  "speed": 0.5,
  "position": {
    "x": 100.5,
    "y": 200.3,
    "angle": 90.0,
    "stationId": null
  },
  "currentTaskId": "TASK001",
  "errorCode": null
}
```

| å­—æ®µ | ç±»åž‹ | è¯´æ˜Ž |
|------|------|------|
| status | int | AgvStatus æžšä¸¾å€¼ |
| battery | int | ç”µé‡ç™¾åˆ†æ¯” (0-100) |
| speed | float | å½“å‰é€Ÿåº¦ (m/s) |
| position.x | float | Xåæ ‡ (åŽ˜ç±³) |
| position.y | float | Yåæ ‡ (åŽ˜ç±³) |
| position.angle | float | æœå‘è§’åº¦ (0-360åº¦ï¼Œæ­£åŒ—ä¸º0) |
| position.stationId | string? | å½“å‰ç«™ç‚¹IDï¼Œä¸åœ¨ç«™ç‚¹æ—¶ä¸ºnull |
| currentTaskId | string? | å½“å‰ä»»åŠ¡IDï¼Œæ— ä»»åŠ¡æ—¶ä¸ºnull |
| errorCode | string? | é”™è¯¯ç ï¼Œæ­£å¸¸æ—¶ä¸ºnull |

---

#### 5.2.2 ä»»åŠ¡ä¸‹å‘ (agv/{agvCode}/task/assign)

æœåŠ¡å™¨å‘å°è½¦ä¸‹å‘ä»»åŠ¡ã€‚

**Payload:**
```json
{
  "taskId": "TASK001",
  "taskType": 1,
  "priority": 1,
  "timestamp": "2026-01-04T10:00:00Z",
  "waypoints": [
    {
      "seq": 1,
      "stationId": "S001",
      "x": 100.0,
      "y": 200.0,
      "action": "none",
      "waitTime": 0
    },
    {
      "seq": 2,
      "stationId": "S002",
      "x": 300.0,
      "y": 200.0,
      "action": "load",
      "waitTime": 5
    },
    {
      "seq": 3,
      "stationId": "S003",
      "x": 300.0,
      "y": 400.0,
      "action": "unload",
      "waitTime": 5
    }
  ],
  "description": "ä»ŽS002å–è´§é€è‡³S003"
}
```

| waypointå­—æ®µ | è¯´æ˜Ž |
|--------------|------|
| seq | è·¯å¾„ç‚¹åºå· (ä»Ž1å¼€å§‹) |
| stationId | ç«™ç‚¹ID |
| x, y | åæ ‡ (åŽ˜ç±³) |
| action | åˆ°è¾¾åŠ¨ä½œ: none/stop/load/unload |
| waitTime | ç­‰å¾…æ—¶é—´ (ç§’) |

---

#### 5.2.3 ä»»åŠ¡è¿›åº¦ (agv/{agvCode}/task/progress)

å°è½¦ä¸ŠæŠ¥ä»»åŠ¡æ‰§è¡Œè¿›åº¦ã€‚

**Payload:**
```json
{
  "agvId": "AGV001",
  "taskId": "TASK001",
  "timestamp": "2026-01-04T10:05:00Z",
  "status": 2,
  "currentWaypointSeq": 2,
  "totalWaypoints": 3,
  "message": "å·²åˆ°è¾¾S002ï¼Œæ­£åœ¨è£…è´§"
}
```

| statuså€¼ | è¯´æ˜Ž | è§¦å‘æ—¶æœº |
|----------|------|----------|
| 1 | Assigned | æ”¶åˆ°ä»»åŠ¡ï¼Œå‡†å¤‡æ‰§è¡Œ |
| 2 | Executing | å¼€å§‹æ‰§è¡Œ / åˆ°è¾¾è·¯å¾„ç‚¹ |
| 3 | Completed | ä»»åŠ¡å®Œæˆ |
| 5 | Failed | ä»»åŠ¡å¤±è´¥ |

---

#### 5.2.4 å–æ¶ˆä»»åŠ¡ (agv/{agvCode}/task/cancel)

æœåŠ¡å™¨é€šçŸ¥å°è½¦å–æ¶ˆä»»åŠ¡ã€‚

**Payload:**
```json
{
  "taskId": "TASK001",
  "timestamp": "2026-01-04T10:10:00Z",
  "reason": "ç”¨æˆ·å–æ¶ˆ"
}
```

å°è½¦æ”¶åˆ°åŽé€šè¿‡ `task/progress` ä¸ŠæŠ¥å–æ¶ˆç¡®è®¤ï¼š
```json
{
  "agvId": "AGV001",
  "taskId": "TASK001",
  "timestamp": "2026-01-04T10:10:01Z",
  "status": 4,
  "message": "ä»»åŠ¡å·²å–æ¶ˆï¼Œæ­£åœ¨è¿”å›žå¾…å‘½ç‚¹"
}
```

---

#### 5.2.5 æŽ§åˆ¶æŒ‡ä»¤ (agv/{agvCode}/command)

æœåŠ¡å™¨å‘å°è½¦ä¸‹å‘æŽ§åˆ¶æŒ‡ä»¤ã€‚

**Payload:**
```json
{
  "commandId": "CMD001",
  "commandType": 1,
  "timestamp": "2026-01-04T10:10:00Z",
  "params": {}
}
```

| commandType | è¯´æ˜Ž | params |
|-------------|------|--------|
| 1 | Pause - æš‚åœ | {} |
| 2 | Resume - ç»§ç»­ | {} |
| 3 | Stop - æ€¥åœ | {} |
| 4 | ReturnHome - è¿”å›žå¾…å‘½ç‚¹ | {} |

---

#### 5.2.6 æŒ‡ä»¤åº”ç­” (agv/{agvCode}/command/ack)

å°è½¦æ”¶åˆ°æŒ‡ä»¤åŽåº”ç­”ã€‚

**Payload:**
```json
{
  "commandId": "CMD001",
  "timestamp": "2026-01-04T10:10:01Z",
  "success": true,
  "message": "å·²æš‚åœ"
}
```

---

#### 5.2.7 å¼‚å¸¸ä¸ŠæŠ¥ (agv/{agvCode}/exception)

å°è½¦å‘ç”Ÿå¼‚å¸¸æ—¶ä¸ŠæŠ¥ã€‚

**Payload:**
```json
{
  "agvId": "AGV001",
  "timestamp": "2026-01-04T10:05:30Z",
  "exceptionType": 1,
  "severity": "warning",
  "message": "å‰æ–¹æ£€æµ‹åˆ°éšœç¢ç‰©ï¼Œå·²æš‚åœ",
  "position": {
    "x": 150.0,
    "y": 220.5,
    "angle": 90.0,
    "stationId": null
  },
  "taskId": "TASK001"
}
```

| severity | è¯´æ˜Ž |
|----------|------|
| info | æç¤ºä¿¡æ¯ |
| warning | è­¦å‘Šï¼ˆå¯è‡ªåŠ¨æ¢å¤ï¼‰ |
| error | é”™è¯¯ï¼ˆéœ€äººå·¥å¹²é¢„ï¼‰ |
| critical | ä¸¥é‡æ•…éšœ |

---

### 5.3 é€šä¿¡æ—¶åºå›¾

#### æ­£å¸¸ä»»åŠ¡æµç¨‹

```
å°è½¦                     MQTT Broker                   æœåŠ¡å™¨
  â”‚                           â”‚                          â”‚
  â”‚ â•â• CONNECT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¶â”‚                          â”‚
  â”‚ â—€â•â•â•â• CONNACK â•â•â•â•â•â•â•â•â•â•â• â”‚                          â”‚
  â”‚                           â”‚                          â”‚
  â”‚ â”€â”€ SUBSCRIBE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚                          â”‚
  â”‚    agv/AGV001/task/#      â”‚                          â”‚
  â”‚    agv/AGV001/command     â”‚                          â”‚
  â”‚                           â”‚                          â”‚
  â”‚ â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”€â”€ è½¬å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
  â”‚    agv/AGV001/status      â”‚    (çŠ¶æ€: Idle)          â”‚
  â”‚                           â”‚                          â”‚
  â”‚                           â”‚ â—€â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
  â”‚ â—€â”€â”€ è½¬å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    agv/AGV001/task/assignâ”‚
  â”‚    (ä»»åŠ¡ä¸‹å‘)              â”‚                          â”‚
  â”‚                           â”‚                          â”‚
  â”‚ â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”€â”€ è½¬å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
  â”‚    agv/AGV001/task/progressâ”‚   (status: Assigned)    â”‚
  â”‚                           â”‚                          â”‚
  â”‚ â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”€â”€ è½¬å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
  â”‚    agv/AGV001/status      â”‚    (çŠ¶æ€: Running)       â”‚
  â”‚                           â”‚                          â”‚
  â”‚         ... æ‰§è¡Œä»»åŠ¡ ...   â”‚                          â”‚
  â”‚                           â”‚                          â”‚
  â”‚ â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”€â”€ è½¬å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
  â”‚    agv/AGV001/task/progressâ”‚   (status: Completed)   â”‚
  â”‚                           â”‚                          â”‚
  â”‚ â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”€â”€ è½¬å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
  â”‚    agv/AGV001/status      â”‚    (çŠ¶æ€: Idle)          â”‚
  â”‚                           â”‚                          â”‚
```

---

## å…­ã€HTTP API æŽ¥å£è®¾è®¡

Web ç•Œé¢å’Œå®‰å“ APP é€šè¿‡ HTTP API ä¸ŽæœåŠ¡å™¨äº¤äº’ã€‚

### 6.1 æŽ¥å£è§„èŒƒ

- **åè®®**: HTTPS
- **æ•°æ®æ ¼å¼**: JSON
- **è®¤è¯æ–¹å¼**: JWT Token (Header: `Authorization: Bearer {token}`)
- **åŸºç¡€è·¯å¾„**: `/api`

### 6.2 æŽ¥å£åˆ—è¡¨

#### 6.2.1 å°è½¦ç›¸å…³

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜Ž |
|------|------|------|
| GET | `/api/agvs` | èŽ·å–æ‰€æœ‰å°è½¦çŠ¶æ€ |
| GET | `/api/agvs/{id}` | èŽ·å–å•ä¸ªå°è½¦è¯¦æƒ… |
| POST | `/api/agvs/{id}/command` | ä¸‹å‘æŽ§åˆ¶æŒ‡ä»¤ï¼ˆæš‚åœ/ç»§ç»­/æ€¥åœï¼‰ |

**GET /api/agvs å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "data": [
    {
      "id": "AGV001",
      "name": "1å·è½¦",
      "status": 1,
      "statusText": "ç©ºé—²",
      "battery": 85,
      "position": { "x": 100.5, "y": 200.3, "angle": 90.0 },
      "currentTaskId": null,
      "lastOnline": "2026-01-04T10:00:00Z"
    }
  ],
  "timestamp": "2026-01-04T10:00:05Z"
}
```

**POST /api/agvs/{id}/command è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "commandType": 1,
  "params": {}
}
```

#### 6.2.2 ä»»åŠ¡ç›¸å…³

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜Ž |
|------|------|------|
| GET | `/api/tasks` | èŽ·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µã€ç­›é€‰ï¼‰ |
| GET | `/api/tasks/{id}` | èŽ·å–ä»»åŠ¡è¯¦æƒ… |
| POST | `/api/tasks` | åˆ›å»ºä»»åŠ¡ |
| DELETE | `/api/tasks/{id}` | å–æ¶ˆä»»åŠ¡ |

**POST /api/tasks è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "taskType": 1,
  "routeId": "R001",
  "priority": 1,
  "description": "ä»ŽAç‚¹è¿é€åˆ°Bç‚¹"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "taskId": "TASK001",
  "status": 0,
  "message": "ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…åˆ†é…"
}
```

#### 6.2.3 è·¯çº¿/ç«™ç‚¹ç›¸å…³

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜Ž |
|------|------|------|
| GET | `/api/stations` | èŽ·å–æ‰€æœ‰ç«™ç‚¹ |
| POST | `/api/stations` | åˆ›å»ºç«™ç‚¹ |
| PUT | `/api/stations/{id}` | æ›´æ–°ç«™ç‚¹ |
| DELETE | `/api/stations/{id}` | åˆ é™¤ç«™ç‚¹ |
| GET | `/api/routes` | èŽ·å–æ‰€æœ‰è·¯çº¿ |
| POST | `/api/routes` | åˆ›å»ºè·¯çº¿ |
| PUT | `/api/routes/{id}` | æ›´æ–°è·¯çº¿ |
| DELETE | `/api/routes/{id}` | åˆ é™¤è·¯çº¿ |

#### 6.2.4 åŽ†å²è®°å½•

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜Ž |
|------|------|------|
| GET | `/api/tasks/history` | ä»»åŠ¡åŽ†å²ï¼ˆæ”¯æŒåˆ†é¡µã€æ—¶é—´ç­›é€‰ï¼‰ |
| GET | `/api/exceptions` | å¼‚å¸¸è®°å½• |

### 6.3 çŠ¶æ€è½®è¯¢

Web/APP é€šè¿‡å®šæ—¶è½®è¯¢èŽ·å–å°è½¦å®žæ—¶çŠ¶æ€ï¼š

```javascript
// æŽ¨èè½®è¯¢é—´éš”ï¼š2ç§’
setInterval(async () => {
  const response = await fetch('/api/agvs');
  const data = await response.json();
  updateDashboard(data);
}, 2000);
```

### 6.4 é”™è¯¯å“åº”æ ¼å¼

```json
{
  "error": {
    "code": "E001",
    "message": "å°è½¦ç¦»çº¿"
  }
}
```

---

## ä¸ƒã€è½¯ä»¶æŠ€æœ¯é€‰åž‹

### 7.1 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰åž‹ | ç‰ˆæœ¬ | è¯´æ˜Ž |
|------|----------|------|------|
| åŽç«¯æ¡†æž¶ | ASP.NET Core | 8.0 | è·¨å¹³å°ï¼Œæ€§èƒ½ä¼˜ç§€ |
| MQTT å®¢æˆ·ç«¯ | MQTTnet | 4.x | .NET é¦–é€‰ MQTT åº“ |
| ORM | Entity Framework Core | 8.0 | ä»£ç ä¼˜å…ˆï¼Œè¿ç§»æ–¹ä¾¿ |
| æ•°æ®åº“ | PostgreSQL | 15+ | å¼€æºï¼Œç¨³å®šå¯é  |
| ç¼“å­˜ | å†…å­˜ç¼“å­˜ | - | å°è§„æ¨¡æš‚ä¸éœ€è¦Redis |
| çŽ°åœºç•Œé¢ | Blazor Server | 8.0 | .NETå…¨æ ˆï¼Œå…±äº«æ¨¡åž‹ |
| ç§»åŠ¨ç«¯ | Avalonia UI | 11.x | è·¨å¹³å°ï¼Œè‡ªç»˜å¼•æ“Žï¼Œç¨³å®šæ€§å¥½ |
| æ—¥å¿— | Serilog | 3.x | ç»“æž„åŒ–æ—¥å¿— |
| APIæ–‡æ¡£ | Swagger/OpenAPI | - | è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ |

### 7.2 é¡¹ç›®ç»“æž„

```
agv-dispatch/
â”‚
â”œâ”€â”€ src/
â”‚   â”‚
â”‚   â”œâ”€â”€ AgvDispatch.Shared/              # å…±äº«ç±»åº“
â”‚   â”‚   â”œâ”€â”€ Models/                      # æ•°æ®æ¨¡åž‹
â”‚   â”‚   â”‚   â”œâ”€â”€ Agv.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ AgvTask.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ Route.cs
â”‚   â”‚   â”‚   â””â”€â”€ Station.cs
â”‚   â”‚   â”œâ”€â”€ Messages/                    # MQTT æ¶ˆæ¯å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ StatusMessage.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskAssignMessage.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskProgressMessage.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ CommandMessage.cs
â”‚   â”‚   â”‚   â””â”€â”€ ExceptionMessage.cs
â”‚   â”‚   â”œâ”€â”€ Enums/
â”‚   â”‚   â”‚   â”œâ”€â”€ AgvStatus.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskStatus.cs
â”‚   â”‚   â”‚   â””â”€â”€ CommandType.cs
â”‚   â”‚   â””â”€â”€ Constants/
â”‚   â”‚       â””â”€â”€ MqttTopics.cs            # Topic å¸¸é‡å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ AgvDispatch.Business/            # ä¸šåŠ¡å±‚ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ Services/                    # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ IDispatchService.cs      # è°ƒåº¦æœåŠ¡æŽ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ DispatchService.cs       # è°ƒåº¦ç®—æ³•ã€ä»»åŠ¡åˆ†é…è§„åˆ™
â”‚   â”‚   â”‚   â”œâ”€â”€ ITaskBusinessService.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskBusinessService.cs   # ä»»åŠ¡ä¸šåŠ¡è§„åˆ™
â”‚   â”‚   â”‚   â”œâ”€â”€ IRoutePlanningService.cs
â”‚   â”‚   â”‚   â””â”€â”€ RoutePlanningService.cs  # è·¯çº¿è§„åˆ’é€»è¾‘
â”‚   â”‚   â””â”€â”€ Interfaces/                  # ä¸šåŠ¡æŽ¥å£å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ AgvDispatch.Host/              # ä¸­å¤®è°ƒåº¦æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ Program.cs
â”‚   â”‚   â”œâ”€â”€ appsettings.json
â”‚   â”‚   â”œâ”€â”€ Mqtt/                        # å†…åµŒ MQTT Broker
â”‚   â”‚   â”‚   â”œâ”€â”€ MqttBrokerService.cs     # Broker æ‰˜ç®¡æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ MqttMessageHandler.cs    # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ Controllers/                 # HTTP API (ä¾› Web/APP è°ƒç”¨)
â”‚   â”‚   â”‚   â”œâ”€â”€ AgvsController.cs        # GET/POST /api/agvs
â”‚   â”‚   â”‚   â”œâ”€â”€ TasksController.cs       # GET/POST/DELETE /api/tasks
â”‚   â”‚   â”‚   â”œâ”€â”€ StationsController.cs    # GET/POST/PUT/DELETE /api/stations
â”‚   â”‚   â”‚   â””â”€â”€ RoutesController.cs      # GET/POST/PUT/DELETE /api/routes
â”‚   â”‚   â”œâ”€â”€ Application/                 # åº”ç”¨æœåŠ¡å±‚ï¼ˆåè°ƒå±‚ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ Services/                # åº”ç”¨æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AgvApplicationService.cs    # åè°ƒä¸šåŠ¡å±‚å’Œæ•°æ®å±‚ï¼Œå¤„ç†å°è½¦ç›¸å…³æ“ä½œ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TaskApplicationService.cs   # åè°ƒä»»åŠ¡åˆ›å»ºã€åˆ†é…ã€ä¿å­˜çš„å®Œæ•´æµç¨‹
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ DispatchApplicationService.cs # åè°ƒè°ƒåº¦æµç¨‹ï¼ˆè¯»å–æ•°æ®â†’è°ƒç”¨ä¸šåŠ¡é€»è¾‘â†’ä¿å­˜ç»“æžœâ†’å‘é€æ¶ˆæ¯ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ DTOs/                    # æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆController å’Œ Service ä¹‹é—´ä¼ é€’çš„æ•°æ®ï¼‰
â”‚   â”‚   â”œâ”€â”€ Infrastructure/             # åŸºç¡€è®¾æ–½å±‚ï¼ˆæŠ€æœ¯å®žçŽ°ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ Messaging/               # æ¶ˆæ¯å¤„ç†ï¼ˆMQTT æ¶ˆæ¯å‘é€ã€æŽ¥æ”¶çš„å°è£…ï¼‰
â”‚   â”‚   â””â”€â”€ Data/                        # æ•°æ®å±‚ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
â”‚   â”‚       â”œâ”€â”€ AppDbContext.cs         # EF Core æ•°æ®åº“ä¸Šä¸‹æ–‡
â”‚   â”‚       â”œâ”€â”€ Entities/                # æ•°æ®åº“å®žä½“ï¼ˆå¯¹åº”æ•°æ®åº“è¡¨ï¼‰
â”‚   â”‚       â””â”€â”€ Repositories/           # æ•°æ®è®¿é—®æŽ¥å£å’Œå®žçŽ°ï¼ˆå°è£…æ•°æ®åº“æ“ä½œï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ AgvDispatch.Web/                 # çŽ°åœºè°ƒåº¦ç•Œé¢ (Blazor)
â”‚   â”‚   â”œâ”€â”€ Program.cs
â”‚   â”‚   â”œâ”€â”€ Components/
â”‚   â”‚   â”‚   â”œâ”€â”€ Pages/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Dashboard.razor      # ç›‘æŽ§å¤§å±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TaskManage.razor     # ä»»åŠ¡ç®¡ç†
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AgvMonitor.razor     # å°è½¦ç›‘æŽ§
â”‚   â”‚   â”‚   â””â”€â”€ Shared/
â”‚   â”‚   â””â”€â”€ wwwroot/
â”‚   â”‚
â”‚   â”œâ”€â”€ AgvDispatch.Mobile/              # å®‰å“APP (Avalonia)
â”‚   â”‚   â”œâ”€â”€ Program.cs
â”‚   â”‚   â”œâ”€â”€ App.axaml                    # Avalonia åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ Views/
â”‚   â”‚   â”œâ”€â”€ ViewModels/
â”‚   â”‚   â””â”€â”€ Services/
â”‚   â”‚
â”‚   â””â”€â”€ AgvDispatch.Simulator/           # å°è½¦æ¨¡æ‹Ÿå™¨ (è”è°ƒç”¨)
â”‚       â”œâ”€â”€ Program.cs
â”‚       â””â”€â”€ AgvSimulator.cs
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ AgvDispatch.Host.Tests/
â”‚   â””â”€â”€ AgvDispatch.Shared.Tests/
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ technical-design.md              # æœ¬æ–‡æ¡£
â”‚   â””â”€â”€ api-reference.md                 # APIå‚è€ƒ
â”‚
â””â”€â”€ AgvDispatch.sln                      # è§£å†³æ–¹æ¡ˆæ–‡ä»¶
```

**è¯´æ˜Ž**ï¼š
- **ä»£ç ç»“æž„åˆ†ç¦»**ï¼š`AgvDispatch.Host` å’Œ `AgvDispatch.Web` åœ¨ä»£ç å±‚é¢æ˜¯åˆ†å¼€çš„é¡¹ç›®ï¼Œä¾¿äºŽæ¨¡å—åŒ–ç®¡ç†å’ŒèŒè´£åˆ†ç¦»
- **éƒ¨ç½²æ—¶é›†æˆ**ï¼š`AgvDispatch.Web` ä½œä¸º Blazor Server åº”ç”¨ï¼Œé€šè¿‡é¡¹ç›®å¼•ç”¨é›†æˆåˆ° `AgvDispatch.Host` ä¸­ï¼Œæœ€ç»ˆæ‰“åŒ…æˆä¸€ä¸ªæœåŠ¡éƒ¨ç½²
- **å®žé™…éƒ¨ç½²**ï¼šåªéœ€è¦éƒ¨ç½²ä¸€ä¸ªæœåŠ¡ï¼ˆ`agv-dispatch`ï¼‰ï¼Œè¯¥æœåŠ¡åŒæ—¶æä¾›ï¼š
  - MQTT Brokerï¼ˆç«¯å£ 1883/8883ï¼‰
  - REST APIï¼ˆç«¯å£ 443ï¼Œä¾› Web/APP è°ƒç”¨ï¼‰
  - Blazor Web ç•Œé¢ï¼ˆç«¯å£ 443ï¼Œé€šè¿‡ SignalR å®žæ—¶é€šä¿¡ï¼‰

**é¡¹ç›®å¼•ç”¨å…³ç³»**ï¼š
```
AgvDispatch.Host (ä¸»é¡¹ç›®ï¼Œå¯åŠ¨å…¥å£)
  â”œâ”€â”€ å¼•ç”¨ AgvDispatch.Business (ä¸šåŠ¡å±‚)
  â”œâ”€â”€ å¼•ç”¨ AgvDispatch.Shared (å…±äº«ç±»åº“)
  â””â”€â”€ å¼•ç”¨ AgvDispatch.Web (Blazor ç»„ä»¶åº“)

AgvDispatch.Business (ä¸šåŠ¡å±‚)
  â””â”€â”€ å¼•ç”¨ AgvDispatch.Shared (å…±äº«ç±»åº“)
```

**åˆ†å±‚æž¶æž„è¯´æ˜Ž**ï¼š

| å±‚çº§ | é¡¹ç›®/ç›®å½• | èŒè´£ | ä¾èµ–å…³ç³» |
|------|----------|------|----------|
| **è¡¨çŽ°å±‚** | `Controllers/` | æŽ¥æ”¶ HTTP è¯·æ±‚ï¼Œå‚æ•°éªŒè¯ï¼Œè°ƒç”¨åº”ç”¨æœåŠ¡ | ä¾èµ– Application |
| **åº”ç”¨æœåŠ¡å±‚** | `Application/` | åè°ƒä¸šåŠ¡é€»è¾‘ã€æ•°æ®è®¿é—®ã€åŸºç¡€è®¾æ–½ï¼Œå¤„ç†äº‹åŠ¡è¾¹ç•Œ | ä¾èµ– Businessã€Dataã€Infrastructure |
| **ä¸šåŠ¡å±‚** | `AgvDispatch.Business/` | æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ã€ç®—æ³•ã€é¢†åŸŸé€»è¾‘ï¼ˆçº¯ä¸šåŠ¡ï¼Œä¸ä¾èµ–åŸºç¡€è®¾æ–½ï¼‰ | ä»…ä¾èµ– Shared |
| **åŸºç¡€è®¾æ–½å±‚** | `Infrastructure/`, `Mqtt/` | æŠ€æœ¯å®žçŽ°ï¼šMQTTã€ç¼“å­˜ã€å¤–éƒ¨æœåŠ¡ | ä¾èµ– Businessã€Data |
| **æ•°æ®å±‚** | `Data/` | æ•°æ®æŒä¹…åŒ–ã€æ•°æ®åº“è®¿é—® | ä¾èµ– Shared |

**å„å±‚èŒè´£è¯¦è§£ï¼ˆä»¥"åˆ›å»ºä»»åŠ¡"ä¸ºä¾‹ï¼‰**ï¼š

å‡è®¾ç”¨æˆ·é€šè¿‡ Web ç•Œé¢åˆ›å»ºä¸€ä¸ªä»»åŠ¡"ä»Ž A ç‚¹è¿é€åˆ° B ç‚¹"ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š

```
1. Controllers/ (è¡¨çŽ°å±‚)
   â””â”€â”€ TasksController.Create()
       â€¢ æŽ¥æ”¶ HTTP POST è¯·æ±‚
       â€¢ éªŒè¯å‚æ•°ï¼ˆè·¯çº¿æ˜¯å¦å­˜åœ¨ã€å‚æ•°æ˜¯å¦åˆæ³•ï¼‰
       â€¢ è°ƒç”¨ Application å±‚çš„ TaskApplicationService

2. Application/Services/ (åº”ç”¨æœåŠ¡å±‚ - åè°ƒå±‚)
   â””â”€â”€ TaskApplicationService.CreateTask()
       â€¢ ä»Ž Data å±‚è¯»å–æ‰€æœ‰å°è½¦çŠ¶æ€
       â€¢ è°ƒç”¨ Business å±‚çš„ DispatchService é€‰æ‹©åˆé€‚çš„å°è½¦
       â€¢ å°†ä»»åŠ¡ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆData å±‚ï¼‰
       â€¢ é€šè¿‡ Infrastructure å±‚çš„ MQTT æœåŠ¡å‘é€ä»»åŠ¡ç»™å°è½¦
       â€¢ å¤„ç†äº‹åŠ¡ï¼ˆå¦‚æžœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå›žæ»šï¼‰

3. Business/Services/ (ä¸šåŠ¡å±‚ - æ ¸å¿ƒé€»è¾‘)
   â””â”€â”€ DispatchService.AssignTask()
       â€¢ ä¸šåŠ¡è§„åˆ™ï¼šç­›é€‰å¯ç”¨å°è½¦ï¼ˆçŠ¶æ€=ç©ºé—²ï¼Œç”µé‡>20%ï¼‰
       â€¢ ä¸šåŠ¡è§„åˆ™ï¼šè®¡ç®—æ¯è¾†è½¦åˆ°èµ·ç‚¹çš„è·ç¦»
       â€¢ ä¸šåŠ¡è§„åˆ™ï¼šé€‰æ‹©æœ€è¿‘çš„å°è½¦
       â€¢ ä¸šåŠ¡è§„åˆ™ï¼šæ£€æŸ¥è·¯çº¿å†²çª
       â€¢ è¿”å›žé€‰ä¸­çš„å°è½¦ï¼ˆçº¯ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ¶‰åŠæ•°æ®åº“ã€MQTTï¼‰

4. Data/ (æ•°æ®å±‚)
   â””â”€â”€ TaskRepository.Save()
       â€¢ å°†ä»»åŠ¡ä¿¡æ¯ä¿å­˜åˆ° PostgreSQL æ•°æ®åº“
       â€¢ æ›´æ–°å°è½¦çŠ¶æ€ä¸º"æ‰§è¡Œä»»åŠ¡ä¸­"

5. Infrastructure/Mqtt/ (åŸºç¡€è®¾æ–½å±‚)
   â””â”€â”€ MqttBrokerService.Publish()
       â€¢ é€šè¿‡ MQTT åè®®å‘é€ä»»åŠ¡æ¶ˆæ¯ç»™é€‰ä¸­çš„å°è½¦
       â€¢ å¤„ç†æ¶ˆæ¯å‘é€å¤±è´¥çš„æƒ…å†µ
```

**ä¸ºä»€ä¹ˆéœ€è¦ Application å±‚ï¼Ÿ**

- **Business å±‚**ï¼šåªè´Ÿè´£"é€‰å“ªè¾†è½¦"è¿™ä¸ªä¸šåŠ¡å†³ç­–ï¼Œä¸å…³å¿ƒæ•°æ®æ€Žä¹ˆå­˜ã€æ¶ˆæ¯æ€Žä¹ˆå‘
- **Application å±‚**ï¼šè´Ÿè´£æŠŠ Business çš„å†³ç­–ç»“æžœ"ä¸²è”èµ·æ¥"â€”â€”ä¿å­˜æ•°æ®ã€å‘é€æ¶ˆæ¯ã€å¤„ç†å¼‚å¸¸
- **å¥½å¤„**ï¼šå¦‚æžœä»¥åŽä¸ç”¨ MQTT äº†ï¼Œæ”¹ç”¨ HTTPï¼Œåªéœ€è¦æ”¹ Infrastructure å±‚ï¼ŒBusiness å±‚å®Œå…¨ä¸ç”¨åŠ¨

**è®¾è®¡ä¼˜åŠ¿**ï¼š
1. **èŒè´£æ¸…æ™°**ï¼šä¸šåŠ¡é€»è¾‘ä¸ŽåŸºç¡€è®¾æ–½åˆ†ç¦»ï¼Œä¾¿äºŽç»´æŠ¤å’Œæµ‹è¯•
2. **æ˜“äºŽæµ‹è¯•**ï¼šä¸šåŠ¡å±‚å¯ç‹¬ç«‹è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œä¸ä¾èµ–æ•°æ®åº“ã€MQTT ç­‰
3. **ä¾¿äºŽæ‰©å±•**ï¼šä¿®æ”¹ MQTT å®žçŽ°æˆ–æ›¿æ¢åŸºç¡€è®¾æ–½ä¸å½±å“ä¸šåŠ¡é€»è¾‘
4. **ä»£ç å¤ç”¨**ï¼šä¸šåŠ¡å±‚å¯è¢«å…¶ä»–é¡¹ç›®å¼•ç”¨ï¼ˆå¦‚æµ‹è¯•é¡¹ç›®ã€æ¨¡æ‹Ÿå™¨é¡¹ç›®ï¼‰

### 7.3 æ•°æ®åº“è®¾è®¡

#### 7.3.1 æ ¸å¿ƒè¡¨ç»“æž„

```sql
-- å°è½¦è¡¨
CREATE TABLE agvs (
    id VARCHAR(50) PRIMARY KEY,          -- å°è½¦IDï¼Œå¦‚ AGV001
    name VARCHAR(100) NOT NULL,          -- å°è½¦åç§°
    password VARCHAR(100) NOT NULL,      -- MQTT è¿žæŽ¥å¯†ç 
    status INT NOT NULL DEFAULT 0,       -- çŠ¶æ€
    battery INT DEFAULT 100,             -- ç”µé‡
    position_x DECIMAL(10,2),            -- Xåæ ‡
    position_y DECIMAL(10,2),            -- Yåæ ‡
    position_angle DECIMAL(5,2),         -- æœå‘
    current_station_id VARCHAR(50),      -- å½“å‰ç«™ç‚¹
    current_task_id VARCHAR(50),         -- å½“å‰ä»»åŠ¡
    last_online TIMESTAMP,               -- æœ€åŽåœ¨çº¿æ—¶é—´
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç«™ç‚¹è¡¨
CREATE TABLE stations (
    id VARCHAR(50) PRIMARY KEY,          -- ç«™ç‚¹ID
    name VARCHAR(100) NOT NULL,          -- ç«™ç‚¹åç§°
    x DECIMAL(10,2) NOT NULL,            -- Xåæ ‡
    y DECIMAL(10,2) NOT NULL,            -- Yåæ ‡
    type VARCHAR(50),                    -- ç±»åž‹: pickup/dropoff/charge/standby
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è·¯çº¿è¡¨
CREATE TABLE routes (
    id VARCHAR(50) PRIMARY KEY,          -- è·¯çº¿ID
    name VARCHAR(100) NOT NULL,          -- è·¯çº¿åç§°
    waypoints JSONB NOT NULL,            -- è·¯å¾„ç‚¹ (JSONæ•°ç»„)
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ä»»åŠ¡è¡¨
CREATE TABLE tasks (
    id VARCHAR(50) PRIMARY KEY,          -- ä»»åŠ¡ID
    type INT NOT NULL,                   -- ä»»åŠ¡ç±»åž‹
    status INT NOT NULL DEFAULT 0,       -- ä»»åŠ¡çŠ¶æ€
    priority INT DEFAULT 1,              -- ä¼˜å…ˆçº§ (1æœ€é«˜)
    assigned_agv_id VARCHAR(50),         -- åˆ†é…çš„å°è½¦
    route_id VARCHAR(50),                -- è·¯çº¿ID
    waypoints JSONB,                     -- è·¯å¾„ç‚¹å¿«ç…§
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    assigned_at TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_by VARCHAR(100)              -- åˆ›å»ºäºº
);

-- åŽ†å²è®°å½•è¡¨
CREATE TABLE task_logs (
    id BIGSERIAL PRIMARY KEY,
    task_id VARCHAR(50) NOT NULL,
    agv_id VARCHAR(50),
    action VARCHAR(50) NOT NULL,         -- åŠ¨ä½œ: created/assigned/started/completed/cancelled/failed
    message TEXT,
    position_x DECIMAL(10,2),
    position_y DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW()
);

-- å¼‚å¸¸è®°å½•è¡¨
CREATE TABLE exception_logs (
    id BIGSERIAL PRIMARY KEY,
    agv_id VARCHAR(50) NOT NULL,
    task_id VARCHAR(50),
    exception_type INT NOT NULL,
    severity VARCHAR(20) NOT NULL,
    message TEXT,
    position_x DECIMAL(10,2),
    position_y DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW(),
    resolved_at TIMESTAMP,
    resolved_by VARCHAR(100)
);
```

---

## å…«ã€æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 8.1 å†…åµŒ MQTT Broker æœåŠ¡

```csharp
public class MqttBrokerService : IHostedService
{
    private MqttServer _mqttServer;
    private readonly IServiceProvider _serviceProvider;

    public MqttBrokerService(IServiceProvider serviceProvider)
    {
        _serviceProvider = serviceProvider;
    }

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        var options = new MqttServerOptionsBuilder()
            .WithDefaultEndpoint()
            .WithDefaultEndpointPort(1883)
            .Build();

        _mqttServer = new MqttFactory().CreateMqttServer(options);

        // å®¢æˆ·ç«¯è¿žæŽ¥è®¤è¯
        _mqttServer.ValidatingConnectionAsync += async e =>
        {
            using var scope = _serviceProvider.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            var agv = await db.Agvs.FindAsync(e.ClientId);
            if (agv == null || agv.Password != e.Password)
            {
                e.ReasonCode = MqttConnectReasonCode.BadUserNameOrPassword;
            }
        };

        // æ”¶åˆ°æ¶ˆæ¯æ—¶å¤„ç†
        _mqttServer.InterceptingPublishAsync += async e =>
        {
            var topic = e.ApplicationMessage.Topic;
            var payload = Encoding.UTF8.GetString(e.ApplicationMessage.Payload);

            // æ ¹æ® Topic åˆ†å‘å¤„ç†
            if (topic.Contains("/status"))
                await HandleStatusAsync(topic, payload);
            else if (topic.Contains("/task/progress"))
                await HandleProgressAsync(topic, payload);
            else if (topic.Contains("/exception"))
                await HandleExceptionAsync(topic, payload);
        };

        await _mqttServer.StartAsync();
    }

    // å‘é€æ¶ˆæ¯ç»™æŒ‡å®šå°è½¦
    public async Task PublishToAgvAsync(string agvId, string topic, object payload)
    {
        var message = new MqttApplicationMessageBuilder()
            .WithTopic($"agv/{agvCode}/{topic}")
            .WithPayload(JsonSerializer.Serialize(payload))
            .WithQualityOfServiceLevel(MqttQualityOfServiceLevel.AtLeastOnce)
            .Build();

        await _mqttServer.InjectApplicationMessage(
            new InjectedMqttApplicationMessage(message));
    }

    public async Task StopAsync(CancellationToken cancellationToken)
    {
        await _mqttServer.StopAsync();
    }
}
```

**è¯´æ˜Ž**ï¼šå†…åµŒ Broker ç›´æŽ¥æ‹¦æˆªæ‰€æœ‰æ¶ˆæ¯ï¼Œæ— éœ€è®¢é˜… Topicã€‚è®¤è¯ä½¿ç”¨æ•°æ®åº“ä¸­çš„å°è½¦å¯†ç ã€‚

### 8.2 è°ƒåº¦å¼•æ“Ž

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è°ƒåº¦å¼•æ“Ž                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  è¾“å…¥:                                                  â”‚
â”‚    â€¢ å¾…åˆ†é…ä»»åŠ¡é˜Ÿåˆ—                                      â”‚
â”‚    â€¢ æ‰€æœ‰å°è½¦å½“å‰çŠ¶æ€ï¼ˆæ¥è‡ª MQTT çŠ¶æ€ä¸ŠæŠ¥ï¼‰              â”‚
â”‚    â€¢ å¯ç”¨è·¯çº¿é…ç½®                                        â”‚
â”‚                                                         â”‚
â”‚  è°ƒåº¦ç­–ç•¥:                                               â”‚
â”‚    1. ç­›é€‰å¯ç”¨å°è½¦ (çŠ¶æ€=Idle, ç”µé‡>20%)                 â”‚
â”‚    2. è®¡ç®—æ¯è¾†è½¦åˆ°ä»»åŠ¡èµ·ç‚¹çš„è·ç¦»                         â”‚
â”‚    3. é€‰æ‹©æœ€è¿‘çš„ç©ºé—²å°è½¦                                 â”‚
â”‚    4. æ£€æŸ¥è·¯çº¿å†²çª (æ˜¯å¦ä¸Žå…¶ä»–å°è½¦è·¯çº¿äº¤å‰)              â”‚
â”‚    5. é€šè¿‡ MQTT å‘å¸ƒä»»åŠ¡åˆ° agv/{id}/task/assign         â”‚
â”‚                                                         â”‚
â”‚  è¾“å‡º:                                                  â”‚
â”‚    â€¢ ä»»åŠ¡åˆ†é…ç»“æžœ                                        â”‚
â”‚    â€¢ MQTT æ¶ˆæ¯å‘å¸ƒ                                       â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 åŠŸèƒ½æ¨¡å—åˆ’åˆ†

| æ¨¡å— | åŠŸèƒ½ | ç•Œé¢å…¥å£ |
|------|------|----------|
| ç›‘æŽ§å¤§å± | å®žæ—¶æ˜¾ç¤ºæ‰€æœ‰å°è½¦ä½ç½®ã€çŠ¶æ€ | Webé¦–é¡µ |
| ä»»åŠ¡ç®¡ç† | åˆ›å»ºä»»åŠ¡ã€æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨ã€å–æ¶ˆä»»åŠ¡ | Web+APP |
| å°è½¦ç®¡ç† | æŸ¥çœ‹å°è½¦è¯¦æƒ…ã€æ‰‹åŠ¨æŽ§åˆ¶(æš‚åœ/ç»§ç»­) | Web+APP |
| è·¯çº¿é…ç½® | é…ç½®ç«™ç‚¹ã€è·¯çº¿ | Web |
| åŽ†å²æŸ¥è¯¢ | æŸ¥è¯¢ä»»åŠ¡åŽ†å²ã€å¼‚å¸¸è®°å½• | Web |
| ç³»ç»Ÿè®¾ç½® | å‚æ•°é…ç½® | Web |

### 8.4 Web ç«¯é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web ç«¯ (Blazor Server)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ðŸ“Š ç›‘æŽ§æ¨¡å—                                                â”‚
â”‚  â””â”€â”€ ç›‘æŽ§å¤§å±        åœ°å›¾æ˜¾ç¤ºå°è½¦ä½ç½®ã€çŠ¶æ€ã€ç”µé‡ã€ä»»åŠ¡      â”‚
â”‚                                                             â”‚
â”‚  ðŸ“‹ ä»»åŠ¡æ¨¡å—                                                â”‚
â”‚  â”œâ”€â”€ ä»»åŠ¡åˆ—è¡¨        è¿›è¡Œä¸­/å¾…åˆ†é…/å·²å®Œæˆï¼Œæ”¯æŒç­›é€‰          â”‚
â”‚  â””â”€â”€ åˆ›å»ºä»»åŠ¡        é€‰æ‹©è·¯çº¿ã€è®¾ç½®ä¼˜å…ˆçº§ã€ä¸‹å‘ä»»åŠ¡          â”‚
â”‚                                                             â”‚
â”‚  ðŸš— å°è½¦æ¨¡å—                                                â”‚
â”‚  â”œâ”€â”€ å°è½¦åˆ—è¡¨        æ‰€æœ‰å°è½¦çŠ¶æ€å¡ç‰‡                        â”‚
â”‚  â””â”€â”€ å°è½¦è¯¦æƒ…        è¯¦ç»†ä¿¡æ¯ + æŽ§åˆ¶æŒ‰é’®ï¼ˆæš‚åœ/ç»§ç»­/æ€¥åœï¼‰   â”‚
â”‚                                                             â”‚
â”‚  âš™ï¸ é…ç½®æ¨¡å—                                                â”‚
â”‚  â”œâ”€â”€ ç«™ç‚¹ç®¡ç†        å¢žåˆ æ”¹ç«™ç‚¹ï¼Œåœ°å›¾æ ‡æ³¨                    â”‚
â”‚  â””â”€â”€ è·¯çº¿ç®¡ç†        å¢žåˆ æ”¹è·¯çº¿ï¼Œè·¯å¾„ç¼–è¾‘                    â”‚
â”‚                                                             â”‚
â”‚  ðŸ“œ åŽ†å²æ¨¡å—                                                â”‚
â”‚  â”œâ”€â”€ ä»»åŠ¡åŽ†å²        æŒ‰æ—¶é—´/å°è½¦/çŠ¶æ€ç­›é€‰                    â”‚
â”‚  â””â”€â”€ å¼‚å¸¸è®°å½•        å¼‚å¸¸æ—¥å¿—åˆ—è¡¨                            â”‚
â”‚                                                             â”‚
â”‚  ðŸ”§ ç³»ç»Ÿæ¨¡å—                                                â”‚
â”‚  â””â”€â”€ ç³»ç»Ÿè®¾ç½®        å‚æ•°é…ç½®                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.5 å®‰å“ç«¯é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®‰å“ç«¯ (Avalonia)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ðŸ  é¦–é¡µ                                                    â”‚
â”‚  â””â”€â”€ çŠ¶æ€æ¦‚è§ˆ        å°è½¦çŠ¶æ€å¡ç‰‡ã€è¿›è¡Œä¸­ä»»åŠ¡æ•°ã€å¿«æ·å…¥å£    â”‚
â”‚                                                             â”‚
â”‚  ðŸ“‹ ä»»åŠ¡æ¨¡å—                                                â”‚
â”‚  â”œâ”€â”€ ä»»åŠ¡åˆ—è¡¨        è¿›è¡Œä¸­/å·²å®Œæˆä»»åŠ¡                       â”‚
â”‚  â””â”€â”€ åˆ›å»ºä»»åŠ¡        å¿«é€Ÿé€‰æ‹©è·¯çº¿ã€ä¸‹å‘ä»»åŠ¡                  â”‚
â”‚                                                             â”‚
â”‚  ðŸš— å°è½¦æ¨¡å—                                                â”‚
â”‚  â””â”€â”€ å°è½¦åˆ—è¡¨        çŠ¶æ€å¡ç‰‡ + å¿«æ·æŽ§åˆ¶æŒ‰é’®                 â”‚
â”‚                                                             â”‚
â”‚  ðŸ”” é€šçŸ¥æ¨¡å—                                                â”‚
â”‚  â””â”€â”€ æ¶ˆæ¯ä¸­å¿ƒ        å¼‚å¸¸å‘Šè­¦æŽ¨é€ã€ä»»åŠ¡å®Œæˆé€šçŸ¥              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.6 åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | Web | APP | è¯´æ˜Ž |
|------|:---:|:---:|------|
| ç›‘æŽ§å¤§å±ï¼ˆåœ°å›¾ï¼‰ | âœ… | âŒ | æ‰‹æœºå±å¹•å°ï¼Œä¸é€‚åˆåœ°å›¾ |
| ä»»åŠ¡åˆ—è¡¨ | âœ… | âœ… | APP ç²¾ç®€ç‰ˆ |
| åˆ›å»ºä»»åŠ¡ | âœ… | âœ… | APP å¿«é€Ÿåˆ›å»º |
| å°è½¦æŽ§åˆ¶ | âœ… | âœ… | æš‚åœ/ç»§ç»­/æ€¥åœ |
| ç«™ç‚¹/è·¯çº¿é…ç½® | âœ… | âŒ | é…ç½®ç±»æ“ä½œåœ¨ Web å®Œæˆ |
| åŽ†å²æŸ¥è¯¢ | âœ… | âŒ | æŸ¥è¯¢ç±»æ“ä½œåœ¨ Web å®Œæˆ |
| å¼‚å¸¸é€šçŸ¥ | âœ… | âœ… | APP æ”¯æŒæŽ¨é€ |
| ç³»ç»Ÿè®¾ç½® | âœ… | âŒ | ç®¡ç†ç±»æ“ä½œåœ¨ Web å®Œæˆ |

**è®¾è®¡åŽŸåˆ™**ï¼šWeb åŠŸèƒ½å®Œæ•´ï¼ŒAPP åªåšç§»åŠ¨åœºæ™¯é«˜é¢‘æ“ä½œï¼ˆçœ‹çŠ¶æ€ã€å‘ä»»åŠ¡ã€ç´§æ€¥æŽ§åˆ¶ï¼‰ã€‚

---

## ä¹ã€éƒ¨ç½²æž¶æž„

### 9.1 æœåŠ¡å™¨éƒ¨ç½²

```
é˜¿é‡Œäº‘ECS (æŽ¨èé…ç½®: 2æ ¸4G)
â”œâ”€â”€ Docker
â”‚   â”œâ”€â”€ agv-dispatch          # è°ƒåº¦æœåŠ¡ (å†…åµŒ MQTT Broker + REST API + Blazor)
â”‚   â””â”€â”€ postgres              # æ•°æ®åº“
â”‚
â””â”€â”€ Nginx (åå‘ä»£ç† + HTTPS)
```

**è¯´æ˜Ž**ï¼šMQTT Broker ä½¿ç”¨ MQTTnet å†…åµŒåˆ°è°ƒåº¦æœåŠ¡ä¸­ï¼Œæ— éœ€ç‹¬ç«‹éƒ¨ç½²ã€‚

### 9.2 ç½‘ç»œé…ç½®

| ç«¯å£ | ç”¨é€” |
|------|------|
| 443 | HTTPS (Webç•Œé¢ + REST API) |
| 1883 | MQTT TCP (å°è½¦è¿žæŽ¥) |
| 8883 | MQTT TLS (å¯é€‰ï¼ŒåŠ å¯†è¿žæŽ¥) |
| 5000 | å†…éƒ¨æœåŠ¡ç«¯å£ |
| 5432 | PostgreSQL (ä»…å†…ç½‘) |

### 9.3 åŸŸåè§„åˆ’

```
è°ƒåº¦ç³»ç»Ÿ:     haining-agv.drinduan.com
APIåœ°å€:      haining-agv.drinduan.com/api
MQTT Broker:  haining-agv.drinduan.com:8883 (TLS)
```

### 9.4 TLS è¯ä¹¦é…ç½®

ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ä¸º MQTT é€šä¿¡åŠ å¯†ã€‚

#### 9.4.1 ä¸ºä»€ä¹ˆéœ€è¦ TLS

| é£Žé™© | ä¸ç”¨ TLS | ç”¨ TLS |
|------|----------|--------|
| æ•°æ®è¢«çªƒå¬ | æ˜Žæ–‡ä¼ è¾“ï¼Œå¯è¢«æˆªèŽ· | åŠ å¯†ä¼ è¾“ |
| å¯†ç æ³„éœ² | MQTTå¯†ç æ˜Žæ–‡ä¼ è¾“ | åŠ å¯†ä¿æŠ¤ |
| æŒ‡ä»¤è¢«ç¯¡æ”¹ | å¯ä¼ªé€ æŽ§åˆ¶æŒ‡ä»¤ | æ— æ³•ç¯¡æ”¹ |

**å»ºè®®**ï¼šå¼€å‘é˜¶æ®µå¯ç”¨ 1883 æ˜Žæ–‡ï¼Œç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨ 8883 TLSã€‚

#### 9.4.2 è¯ä¹¦ç”³è¯·æ­¥éª¤

**1. åŸŸåè§£æž**

åœ¨åŸŸåæœåŠ¡å•†å¤„æ·»åŠ  A è®°å½•ï¼š
```
haining-agv.drinduan.com â†’ é˜¿é‡Œäº‘æœåŠ¡å™¨IP
```

**2. å®‰è£… Certbot**

```bash
# Ubuntu/Debian
apt update && apt install certbot

# CentOS
yum install certbot
```

**3. ç”³è¯·è¯ä¹¦**

```bash
# ç”³è¯·å‰å…ˆåœæŽ‰å ç”¨ 80 ç«¯å£çš„æœåŠ¡ï¼ˆå¦‚ Nginxï¼‰
systemctl stop nginx

# ç”³è¯·è¯ä¹¦
certbot certonly --standalone -d haining-agv.drinduan.com

# ç”³è¯·æˆåŠŸåŽå¯åŠ¨ Nginx
systemctl start nginx
```

**4. è¯ä¹¦æ–‡ä»¶ä½ç½®**

```
è¯ä¹¦: /etc/letsencrypt/live/haining-agv.drinduan.com/fullchain.pem
ç§é’¥: /etc/letsencrypt/live/haining-agv.drinduan.com/privkey.pem
```

#### 9.4.3 å†…åµŒ MQTT Broker é…ç½® TLS

åœ¨ ASP.NET Core æœåŠ¡ä¸­é…ç½® MQTTnet çš„ TLSï¼š

```csharp
// Program.cs
var certificate = new X509Certificate2(
    "/etc/letsencrypt/live/haining-agv.drinduan.com/fullchain.pem",
    "/etc/letsencrypt/live/haining-agv.drinduan.com/privkey.pem"
);

var mqttServerOptions = new MqttServerOptionsBuilder()
    .WithDefaultEndpoint()           // 1883 æ˜Žæ–‡ç«¯å£ï¼ˆå¯é€‰ï¼Œå¼€å‘ç”¨ï¼‰
    .WithEncryptedEndpoint()         // 8883 TLS ç«¯å£
    .WithEncryptedEndpointPort(8883)
    .WithEncryptionCertificate(certificate)
    .Build();

var mqttServer = new MqttFactory().CreateMqttServer(mqttServerOptions);
await mqttServer.StartAsync();
```

Docker éƒ¨ç½²æ—¶æŒ‚è½½è¯ä¹¦ï¼š

```yaml
# docker-compose.yml
services:
  agv-dispatch:
    image: agv-dispatch:latest
    ports:
      - "443:443"    # HTTPS
      - "1883:1883"  # MQTT (å¼€å‘)
      - "8883:8883"  # MQTT TLS (ç”Ÿäº§)
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
```

#### 9.4.4 å°è½¦ç«¯è¿žæŽ¥é…ç½® (Python)

```python
import ssl
import paho.mqtt.client as mqtt

client = mqtt.Client(client_id="AGV001", clean_session=False)
client.username_pw_set("AGV001", "your-password")

# å¯ç”¨ TLS
client.tls_set(
    ca_certs=None,  # ä½¿ç”¨ç³»ç»ŸCAè¯ä¹¦ï¼ˆLet's Encryptè¢«ä¿¡ä»»ï¼‰
    cert_reqs=ssl.CERT_REQUIRED,
    tls_version=ssl.PROTOCOL_TLS
)

# è¿žæŽ¥åˆ° 8883 ç«¯å£
client.connect("haining-agv.drinduan.com", 8883, keepalive=60)
```

#### 9.4.5 è¯ä¹¦è‡ªåŠ¨ç»­æœŸ

Let's Encrypt è¯ä¹¦æœ‰æ•ˆæœŸ 90 å¤©ï¼ŒCertbot ä¼šè‡ªåŠ¨ç»­æœŸï¼š

```bash
# æµ‹è¯•ç»­æœŸæ˜¯å¦æ­£å¸¸
certbot renew --dry-run

# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡ï¼ˆå·²è‡ªåŠ¨æ·»åŠ ï¼‰
systemctl list-timers | grep certbot
```

**æ³¨æ„**ï¼šç»­æœŸåŽéœ€è¦é‡å¯æœåŠ¡åŠ è½½æ–°è¯ä¹¦ï¼š

```bash
# åˆ›å»ºç»­æœŸåŽè‡ªåŠ¨é‡å¯çš„é’©å­
cat > /etc/letsencrypt/renewal-hooks/post/restart-agv.sh << 'EOF'
#!/bin/bash
docker restart agv-dispatch
EOF
chmod +x /etc/letsencrypt/renewal-hooks/post/restart-agv.sh
```

---

## åã€å¼€å‘è®¡åˆ’

### 10.1 é‡Œç¨‹ç¢‘

| é˜¶æ®µ | å†…å®¹ | äº¤ä»˜ç‰© |
|------|------|--------|
| M1 | åŸºç¡€æ¡†æž¶æ­å»º | é¡¹ç›®éª¨æž¶ã€æ•°æ®åº“ã€åŸºç¡€API |
| M2 | MQTT é›†æˆ | å†…åµŒBrokerã€æ¶ˆæ¯å¤„ç†ã€æ¨¡æ‹Ÿå™¨ |
| M3 | è°ƒåº¦æ ¸å¿ƒ | ä»»åŠ¡åˆ†é…ã€çŠ¶æ€ç®¡ç† |
| M4 | Webç•Œé¢ | ç›‘æŽ§å¤§å±ã€ä»»åŠ¡ç®¡ç† |
| M5 | å®‰å“APP | åŸºç¡€åŠŸèƒ½ |
| M6 | è”è°ƒæµ‹è¯• | ä¸Žç¡¬ä»¶å›¢é˜Ÿå¯¹æŽ¥ |
| M7 | éƒ¨ç½²ä¸Šçº¿ | ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½² |

### 10.2 ä¼˜å…ˆçº§

1. **P0 (å¿…é¡»)**: MQTTé€šä¿¡ã€ä»»åŠ¡ä¸‹å‘ã€çŠ¶æ€ä¸ŠæŠ¥ã€åŸºç¡€ç›‘æŽ§
2. **P1 (é‡è¦)**: è°ƒåº¦ç®—æ³•ã€åŽ†å²è®°å½•ã€å¼‚å¸¸å¤„ç†
3. **P2 (ä¸€èˆ¬)**: é«˜çº§ç›‘æŽ§ã€æŠ¥è¡¨ç»Ÿè®¡ã€å‚æ•°é…ç½®

---

## åä¸€ã€é™„å½•

### 11.1 é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | è¯´æ˜Ž |
|--------|------|
| E001 | å°è½¦ç¦»çº¿ |
| E002 | å°è½¦å¿™ç¢Œ |
| E003 | ä»»åŠ¡ä¸å­˜åœ¨ |
| E004 | è·¯çº¿ä¸å­˜åœ¨ |
| E005 | ç”µé‡ä¸è¶³ |
| E006 | è®¤è¯å¤±è´¥ |

### 11.2 ç¡¬ä»¶å›¢é˜Ÿå¯¹æŽ¥ç¤ºä¾‹ (Python)

```python
import json
import time
from datetime import datetime
import paho.mqtt.client as mqtt

class AgvClient:
    def __init__(self, broker_host, agv_id, password):
        self.broker_host = broker_host
        self.agv_id = agv_id
        self.password = password
        self.client = mqtt.Client(client_id=agv_id, clean_session=False)

        # è®¾ç½®è®¤è¯
        self.client.username_pw_set(agv_id, password)

        # è®¾ç½®å›žè°ƒ
        self.client.on_connect = self._on_connect
        self.client.on_message = self._on_message
        self.client.on_disconnect = self._on_disconnect

    def _on_connect(self, client, userdata, flags, rc):
        print(f"å·²è¿žæŽ¥åˆ° Broker, rc={rc}")
        # è®¢é˜…ä»»åŠ¡å’ŒæŒ‡ä»¤
        client.subscribe(f"agv/{self.agv_id}/task/assign", qos=1)
        client.subscribe(f"agv/{self.agv_id}/task/cancel", qos=1)
        client.subscribe(f"agv/{self.agv_id}/command", qos=1)

    def _on_message(self, client, userdata, msg):
        payload = json.loads(msg.payload.decode())
        topic = msg.topic

        if "task/assign" in topic:
            self._handle_task_assign(payload)
        elif "task/cancel" in topic:
            self._handle_task_cancel(payload)
        elif "command" in topic:
            self._handle_command(payload)

    def _on_disconnect(self, client, userdata, rc):
        print(f"è¿žæŽ¥æ–­å¼€, rc={rc}, å°è¯•é‡è¿ž...")

    def _handle_task_assign(self, payload):
        print(f"æ”¶åˆ°ä»»åŠ¡: {payload['taskId']}")
        # åº”ç­”ä»»åŠ¡
        self._publish_progress(
            payload['taskId'],
            status=1,  # Assigned
            message="ä»»åŠ¡å·²æŽ¥æ”¶"
        )

    def _handle_task_cancel(self, payload):
        print(f"ä»»åŠ¡å–æ¶ˆ: {payload['taskId']}")
        self._publish_progress(
            payload['taskId'],
            status=4,  # Cancelled
            message="ä»»åŠ¡å·²å–æ¶ˆ"
        )

    def _handle_command(self, payload):
        print(f"æ”¶åˆ°æŒ‡ä»¤: {payload}")
        # åº”ç­”æŒ‡ä»¤
        ack = {
            "commandId": payload['commandId'],
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "success": True,
            "message": "æŒ‡ä»¤å·²æ‰§è¡Œ"
        }
        self.client.publish(
            f"agv/{self.agv_id}/command/ack",
            json.dumps(ack),
            qos=1
        )

    def _publish_progress(self, task_id, status, message, waypoint_seq=0, total=0):
        payload = {
            "agvId": self.agv_id,
            "taskId": task_id,
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "status": status,
            "currentWaypointSeq": waypoint_seq,
            "totalWaypoints": total,
            "message": message
        }
        self.client.publish(
            f"agv/{self.agv_id}/task/progress",
            json.dumps(payload),
            qos=1
        )

    def publish_status(self, status, battery, position):
        """ä¸ŠæŠ¥çŠ¶æ€"""
        payload = {
            "agvId": self.agv_id,
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "status": status,
            "battery": battery,
            "speed": 0.0,
            "position": position,
            "currentTaskId": None,
            "errorCode": None
        }
        self.client.publish(
            f"agv/{self.agv_id}/status",
            json.dumps(payload),
            qos=0,
            retain=True
        )

    def connect(self):
        """è¿žæŽ¥ Broker"""
        self.client.connect(self.broker_host, 1883, keepalive=60)

    def run(self):
        """ä¸»å¾ªçŽ¯"""
        self.connect()
        self.client.loop_start()

        # å®šæ—¶ä¸ŠæŠ¥çŠ¶æ€
        while True:
            self.publish_status(
                status=1,  # Idle
                battery=85,
                position={"x": 100.0, "y": 200.0, "angle": 90.0, "stationId": None}
            )
            time.sleep(5)


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    client = AgvClient(
        broker_host="localhost",
        agv_id="AGV001",
        password="your-password-here"
    )
    try:
        client.run()
    except KeyboardInterrupt:
        print("é€€å‡º")
```

### 11.3 å‚è€ƒèµ„æ–™

- [MQTT åè®®è§„èŒƒ](https://mqtt.org/mqtt-specification/)
- [MQTTnet æ–‡æ¡£](https://github.com/dotnet/MQTTnet)
- [paho-mqtt Python åº“](https://pypi.org/project/paho-mqtt/)
- [Avalonia UI æ–‡æ¡£](https://docs.avaloniaui.net/)
- [Blazor æ–‡æ¡£](https://docs.microsoft.com/aspnet/core/blazor)

---

## ä¿®è®¢è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢äºº | è¯´æ˜Ž |
|------|------|--------|------|
| v1.0 | 2026-01-04 | - | åˆç¨¿ |
| v1.1 | 2026-01-04 | - | é€šä¿¡åè®®ä»ŽSignalRæ”¹ä¸ºåŽŸç”ŸWebSocket |
| v1.2 | 2026-01-04 | - | é€šä¿¡åè®®ä»ŽWebSocketæ”¹ä¸ºMQTT |
| v1.3 | 2026-01-04 | - | æ˜Žç¡®é€šä¿¡åˆ†å·¥ï¼šå°è½¦ç”¨MQTTï¼ŒWeb/APPç”¨HTTPè½®è¯¢ï¼›è¡¥å……HTTP APIè®¾è®¡ |
| v1.4 | 2026-01-04 | - | MQTT Broker æ”¹ä¸ºå†…åµŒæ–¹æ¡ˆï¼ˆMQTTnetï¼‰ï¼Œç®€åŒ–éƒ¨ç½²æž¶æž„ï¼›ç§»é™¤é—å˜±æ¶ˆæ¯æœºåˆ¶ |
| v1.5 | 2026-01-04 | - | ç§»åŠ¨ç«¯æ¡†æž¶ä»Ž .NET MAUI æ”¹ä¸º Avalonia UI |
