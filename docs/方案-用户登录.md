# 用户登录方案

> 版本: v1.0
> 日期: 2026-01-06

---

## 一、需求

- 支持：API / Blazor Web / Avalonia App
- 内置用户存数据库，角色作为字段
- 内置账号：`admin01`（管理员）、`user01`（普通用户）
- Token 有效期：10 小时
- 公网环境，HTTPS 传输

---

## 二、数据库设计

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password_hash VARCHAR(100) NOT NULL,
    password_salt VARCHAR(50) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'User',  -- 'Admin' | 'User'
    display_name VARCHAR(100),
    is_valid BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP
);

-- 初始数据（密码哈希需要代码生成后替换）
INSERT INTO users (username, password_hash, password_salt, role, display_name)
VALUES
    ('admin01', '{hash}', '{salt}', 'Admin', '管理员'),
    ('user01', '{hash}', '{salt}', 'User', '操作员');
```

---

## 三、API 设计

### POST /api/auth/login

请求：
```json
{
  "username": "admin01",
  "password": "xxx"
}
```

响应：
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGci...",
    "expiresAt": "2026-01-06T22:00:00Z",
    "user": {
      "username": "admin01",
      "displayName": "管理员",
      "role": "Admin"
    }
  }
}
```

### GET /api/auth/me

需要 `Authorization: Bearer {token}`

---

## 四、权限矩阵

| 功能 | User | Admin |
|------|:----:|:-----:|
| 监控/任务/小车控制 | ✅ | ✅ |
| 站点/路线配置 | ❌ | ✅ |
| 小车增删改 | ❌ | ✅ |
| 系统设置 | ❌ | ✅ |

---

## 五、配置

```json
// appsettings.json
{
  "Jwt": {
    "SecretKey": "至少32位的密钥，生产环境用环境变量",
    "Issuer": "AgvDispatch",
    "Audience": "AgvDispatchClients",
    "ExpirationHours": 10
  }
}
```

---

## 六、Token 存储

| 客户端 | 存储方式 |
|--------|----------|
| Blazor Web | ProtectedLocalStorage |
| Avalonia App | SecureStorage |

---

## 七、NuGet 依赖

- `Microsoft.AspNetCore.Authentication.JwtBearer`

---

## 八、实现步骤

1. 创建 User 实体和数据库表(脚本)
2. 实现 AuthService（登录验证、生成 Token）
3. 创建 AuthController
4. 配置 JWT 认证中间件
5. Controller 添加 `[Authorize]` 特性
6. Blazor 实现 AuthenticationStateProvider 和登录页
7. Avalonia 实现 Token 存储和 HttpClient 拦截
